!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Apple2=e():t.Apple2=e()}(self,(()=>(()=>{var t,e,s={2800:(t,e,s)=>{var i={"./apple2_char":[7975,975],"./apple2_char.ts":[7975,975],"./apple2e_char":[3189,189],"./apple2e_char.ts":[3189,189],"./apple2enh_char":[4064,64],"./apple2enh_char.ts":[4064,64],"./apple2j_char":[8132,132],"./apple2j_char.ts":[8132,132],"./apple2lc_char":[957,957],"./apple2lc_char.ts":[957,957],"./pigfont_char":[5030,30],"./pigfont_char.ts":[5030,30],"./rmfont_char":[6601,601],"./rmfont_char.ts":[6601,601]};function r(t){if(!s.o(i,t))return Promise.resolve().then((()=>{var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}));var e=i[t],r=e[0];return s.e(e[1]).then((()=>s(r)))}r.keys=()=>Object.keys(i),r.id=2800,t.exports=r},6190:(t,e,s)=>{var i={"./apple2e":[2553,553],"./apple2e.ts":[2553,553],"./apple2enh":[5045,45],"./apple2enh.ts":[5045,45],"./apple2ex":[2875,875],"./apple2ex.ts":[2875,875],"./apple2j":[7156,156],"./apple2j.ts":[7156,156],"./fpbasic":[4094,94],"./fpbasic.ts":[4094,94],"./intbasic":[7089,89],"./intbasic.ts":[7089,89],"./original":[4663,663],"./original.ts":[4663,663]};function r(t){if(!s.o(i,t))return Promise.resolve().then((()=>{var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}));var e=i[t],r=e[0];return s.e(e[1]).then((()=>s(r)))}r.keys=()=>Object.keys(i),r.id=6190,t.exports=r},7911:t=>{"use strict";const e=function(){const t=class{constructor(t,e){this.x=t,this.y=e}},e=class{constructor(t,e){this.width=t,this.height=e}copy(){return new e(this.width,this.height)}get ratio(){return this.width/this.height}},s=class{constructor(s,i,r,a){this.origin=new t(s,i),this.size=new e(r,a)}get x(){return this.origin.x}get y(){return this.origin.y}get width(){return this.size.width}get height(){return this.size.height}get l(){return this.origin.x}get r(){return this.origin.x+this.size.width}get t(){return this.origin.y}get b(){return this.origin.y+this.size.height}},i=class{constructor(t){this.data=new Float32Array(t)}normalize(){const t=this.data;let e=0;for(const s of t)e+=s;const s=1/e;for(const e in t)t[e]*=s;return this}mul(t){const e=new i(0);if("number"!=typeof t&&this.data.length!=t.data.length)return e;e.data=new Float32Array(this.data);for(let s=0;s<e.data.length;s++)e.data[s]*="number"==typeof t?t:t.data[s];return e}realIDFT(){const t=this.data.length,e=new i(t);for(let s=0;s<t;s++){const i=2*Math.PI*s/t;for(let r=0;r<t;r++)e.data[s]+=this.data[r]*Math.cos(r*i)}for(let s=0;s<t;s++)e.data[s]/=t;return e}resize(t){const e=new Float32Array(t);for(let t=0;t<Math.min(e.length,this.data.length);t++)e[t]=this.data[t];return this.data=e,this}static chebyshevWindow(t,e){const s=t-1;let r=new i(s);const a=Math.cosh(Math.acosh(Math.pow(10,e/20))/s);for(let t=0;t<s;t++){const e=Math.abs(a*Math.cos(Math.PI*t/s));r.data[t]=e>1?Math.pow(-1,t)*Math.cosh(s*Math.acosh(e)):Math.pow(-1,t)*Math.cos(s*Math.acos(e))}r=r.realIDFT(),r.resize(t),r.data[0]/=2,r.data[t-1]=r.data[0];const n=r.data.reduce(((t,e)=>Math.max(t,Math.abs(e))));for(const t in r.data)r.data[t]/=n;return r}static lanczosWindow(t,e){let s=new i(t);e=Math.min(e,.5);const r=Math.floor(t/2);for(let i=0;i<t;i++){const t=2*Math.PI*e*(i-r);s.data[i]=0==t?1:Math.sin(t)/t}return s}},r=class{constructor(t,e,s,i,r,a,n,o,h){this.data=new Float32Array([t,e,s,i,r,a,n,o,h])}at(t,e){return this.data[3*t+e]}mul(t){const e=new r(0,0,0,0,0,0,0,0,0);if("number"==typeof t)e.data=this.data.map((e=>e*t));else for(let s=0;s<3;s++)for(let i=0;i<3;i++)for(let r=0;r<3;r++)e.data[3*s+i]+=t.data[3*s+r]*this.data[3*r+i];return e}},a=65,n=14,o=315/88*1e6,h=4*o,d=7e5,c=h*a/912,l=new s(9222222222222219e-21*c,19,c*(1e-6*(52+8/9)),240),m=new s(16,38,40,192),u=14250450*a/912,f=new s(1137037037037037e-20*u,21,52e-6*u,288),g=new s(16,48,40,192),p="\n// an attribute will receive data from a buffer\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_texCoord;\n\n// all shaders have a main function\nvoid main() {\n  gl_Position = a_position;\n  v_texCoord = a_texCoord;\n}\n";function A(s,i,r,o,h){const d=i.y,c=a*o,l=Math.floor(i.x),m=new e(Math.floor(n*r.width),Math.floor(r.height)),u=Math.floor((l-r.x)*n);return{fsc:h,clockFrequency:s,displayRect:i,visibleRect:r,vertStart:d,vertTotal:o,frameCycleNum:c,horizStart:l,imageSize:m,imageLeft:u,colorBurst:[2*Math.PI*(-33/360+u%4/4)],cycleNum:c+16,topLeft:new t(u,d-r.y),topLeft80Col:new t(u-n/2,d-r.y)}}const b=A(c,m,l,262,o),_=A(u,g,f,312,4433618.75),w=t=>new Promise(((e,s)=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>s(`error loading '${t}'`),i.src=t})),y=["SHADOWMASK_TRIAD","SHADOWMASK_INLINE","SHADOWMASK_APERTURE","SHADOWMASK_LCD","SHADOWMASK_BAYER","IMAGE_PHASEINFO","IMAGE_IN","IMAGE_DECODED","IMAGE_PERSISTENCE"],S=["COMPOSITE","DISPLAY","RGB"],E=t=>{const e=t.clientWidth,s=t.clientHeight;t.width==e&&t.height==s||(t.width=e,t.height=s)},R=(t,e,s,i)=>{const r=t.createShader(s);if(t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS))return r;const a=t.getShaderInfoLog(r);throw t.deleteShader(r),new Error(`unable to compile shader ${e}: \n${a}`)},T=(t,e,...s)=>{const i=t.createProgram();for(let e of s)t.attachShader(i,e);if(t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS))return i;const r=t.getProgramInfoLog(i);throw t.deleteProgram(i),new Error(`unable to compile program ${e}: \n${r}`)},v=class{constructor(t,e,s){this.width=t,this.height=e,this.glTexture=s}get size(){return new e(this.width,this.height)}};return{C:{HORIZ_START:16,HORIZ_BLANK:25,HORIZ_DISPLAY:40,HORIZ_TOTAL:a,CELL_WIDTH:n,CELL_HEIGHT:8,VERT_NTSC_START:38,VERT_PAL_START:48,VERT_DISPLAY:192,BLOCK_WIDTH:40,BLOCK_HEIGHT:24,NTSC_I_CUTOFF:13e5,NTSC_Q_CUTOFF:6e5,NTSC_IQ_DELTA:d,NTSC_DETAILS:b,PAL_DETAILS:_},loadImage:w,screenData:(t,e,s=!0)=>{if(560!=t.naturalWidth||192!=t.naturalHeight)throw new Error(`screenData expects an image 560x192; got ${t.naturalWidth}x${t.naturalHeight}`);const i=document.createElement("canvas"),r=i.getContext("2d"),a=e.imageSize.width,n=e.imageSize.height;i.width=a,i.height=n,r.fillStyle="rgba(0,0,0,1)",r.fillRect(0,0,a,n);const o=s?e.topLeft80Col:e.topLeft;return r.drawImage(t,o.x,o.y),[i,r.getImageData(0,0,a,n)]},resizeCanvas:E,createShader:R,createProgram:T,ScreenView:class{constructor(t){const i=t.getContext("webgl");if(null==i.getExtension("OES_texture_float"))throw new Error("WebGL extension 'OES_texture_float' unavailable");this.canvas=t,this.gl=i,this.textures={},this.shaders={},this.buffers=[],this.image=null,this.display=null,this.imageSampleRate=null,this.imageBlackLevel=null,this.imageWhiteLevel=null,this.imageSubcarrier=null,this.viewportSize=new e(0,0),this.persistenceTexRect=new s(0,0,0,0),this.configurationChanged=!0,this.imageChanged=!0}get image(){return this._image}set image(t){this._image=t,this.imageChanged=!0}set displayConfiguration(t){this.display=t,this.configurationChanged=!0}async initOpenGL(){const t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.textures={};for(let e of y)this.textures[e]=new v(0,0,t.createTexture());for(let e=0;e<3;e++)this.buffers.push(t.createBuffer());await this.loadTextures(),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),this.loadShaders()}freeOpenGL(){const t=this.gl;for(let e of y)t.deleteTexture(this.textures[e].glTexture);for(let e of this.buffers)t.deleteBuffer(e);this.deleteShaders()}loadTextures(){return Promise.all([this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB5hJREFUeNrsXEtolUcU/u6NNT4SH0SNbyUlrVpTlPRBqykq0RjpQsT6WATFhbowLrS4KEKhRaorFxZEixSkipviwvoIFVtiVSq+tW1qia8mPmpFk6gx5tX/frcX0jT3n5l/zrEU7seskpn5zpkz/8ycM2duDKEoAGYD04GJwFCgP//4BLgP/AL8AHwLXIMaXgKKKcFbFGUwkA20AU1APXABOAZUAw/1JAgo3wNmAVOAUUAu0AtoIWWg92kOwFmgVZ55DnAIeAZ0hpZnrDZHnD7QdA1w2UQflHvANqBQXIJC9nvPQoLLlDVXjHkScNiCtls5zIYy+ACodaR/CnwG5IjQ57Cvp44S1FJubywHGtxHP1ka2NwLwRq3Myp9UM4BRZ4SFLGXyBLsTK3T7ujnp3tXEfpFk2AycMab/qHPLFjO9p4SnKEm7tglMfrJsisC/TigRoi+HVgSQYIlbCkiQQ31cUGl3OgnS6UTfXCyOCBK/4frWlTENoISHKBWdnjVbrN3KvfYrS1WSdMHZb+TAfYrSLDKlvxLBfJOdmuFke5nHsuyyFKCRTr0tdTNhCl0rDT4n7BzMzbo0AfleyBupI+znpIEG8z0pZEPLRbHqlJjpRhQrubGvmlzHpnMekoop4ahBngXijB3Pjbimc12ChQbKxWrzcCkdccaDPCypgGCzvuG1xgPDNGUYKJADQ8MoYahBhiizG+IDgyDLkYK1PCDQcN4XJM8blwCY8rqxwRqqEoQb9Qkb2S41FBDFQ8FaniPQagB7miS3zHy1wPNmhLcEKjhgWZqGGqAak1+c+dXgStq9G3ACWOlE6ynhCvUMNQAR1SucxIIuj1irNQCVKmpf56hZQPOsZ4SqqihaY84quMFHrXc4Iq4TmlIsM5ymNbp0DfaRgTn6/DPt58oOxTof7U/4w5jbXEJdjh8Ktulybc7faljuFoK0j8HFjpJsJBtBCW4Qq2s0Yd361Lkh9ihG4pFA/LrI6zX60WvI4qd+YcDJyXIT7KriJGrBgkJtkTeM7dI0DdEjy8OjZQP0S03YqjPqWEmUOdB3wFs9Dy3bGQvkSWoow4eyAY+ovPgylzPhtn+J7cCYJ/7HUUHL8PniZwd57GvDvfrj32UXgI5TDWqsb6BXiOVktM1jvo58MCCvpWn7VJIo5T9tlpI8ICyRgwrx8K/hmnA+8A7tOzA1ARv4Tp3DTgFfENXsgU6CJazuUAZMJVRy1wgiyo3p5Ijv6MEP+v58pM4ADNTuZl9OWLtTI68TQ+uiu7mfcVoYRLB6OelgvvNNHoDXiCySD8I6E31H1PlZy9Sgj40QA5FCQ6sjzgG7cgggwwy+D8jpk+Ry5jUFG7keVzFnzBxq4ab2FXNaHACI7mFBxKM5k4G7l51TCo/z51UF72AVyjBBCCfmbvPuX1c4/uGQIhEEnypEvl0ZmfdTn+Aa6MIHxtvrqOdpCv4fKIpPX0TK1SIn6GTGE/NLlPLdBIENvjb5TkJLOPsFEBv9lXt4ssEk/IrHnoFMAr41DHZrpZNRkkN/TRq02CXy/2PUapyC+GlCWxWRfXjg6nyCc950VHuEcuo808Sy6IGbS6J3N3/dNXnjUMR23sGs/ZEiKUmsdLOcw13q1f6uAp73Cl7+NNv0Z5cFbKlSDh3t01SZzcsE0rvb2dXzohT6k4RA3QyyJDvxJ/PNoIXGm4x5bmhm61raWKHLyiSHTYLHbBb4Upvqf22c12a+7rTbrjUgylsOZxhyT/De+3tsZy1fPC2WedOe7Ol9v0pqbwBHD6C3TojEJTFRu4RwC0d7lvs3IzFXjShe91suo8GjGY9JSywCduP0eEeY+mhLvBiCTXAcKDE2ENJ5DtgO196hPHgr4dymw9wup4BYOMTFGmOwPDwS75shlj0MMF4yVrgO/3iZgt71/ATb1h4wCdPkz7P5n1DXNUAZp+0D3SRHR5qzFbm7hVdOgt0Gg1gvnjUvppsCvlfC28n9fDYeN3dJPCNh+KmsYebmiPQEp5fHxj/rib9XeP8qvfLSIgZDXDB2McFzRG4RZ805AvGRU36i0lXKQTXKaPWF3CTPp4BZzU/ghPGKXhM0wDmzhts3oCY9oG0ZatlF1t1XNF2pgQZMAi4pEN/iZ2bUeYXhk37j9/tf3JlHGuLj8BeS/oKHQNU2E/ivRoGWOv0Ha2VVv9PexcvCzgoTX/Q6WauiPJKGuBr15vBLLYRHIHVTvST/LKq/3036fz7d6sFDVDtehuTRD5biozApgj0ZXa5vDaptmXRdtNNIgbY5pMb0ZvtfdR/ZBOCTodC/pKnD/1pzx/AXEwN3AzQ1sX0K0QObyuizsXTzGDywkCPF387UplbXpjqOAsSjymDU9QXxt9VccJY9vjU5fKjUjCuMws47jIIx9lEMoRUaXdPlPCiP9QL6Rbwxc8ZRkw6esoCus/jRnDeG6ARRy3hb2jWUs0eda9lhRLfgGYaDKBmB6llW09PeloTTlws8fvMSk/lEwh6fx14g2lng/nAIIt8j1MJkqdUf60h8KTeBl7jCWFAlwcmjcxO/Qn4kYu2Isan3rfkcYFLxo6f89h6gwmJGWSQQQb/Hf4SYABjDjkS7NbBvAAAAABJRU5ErkJggg==",!0,"SHADOWMASK_TRIAD"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAxdJREFUeNrsnDtoVEEUhr9do0YwAR9YiGJhoYIiFiJooSJoI6KFj8KIIAQRIwQsLI2IYhHBQkGxUolgowQtREEJPlAxEhstYnwQNBLQJMSYxI3xetLkce7dCUuKvfv/TLP3nHNnmG927mPOXDKwE5rgB/yC3lEl+tkNb6EGyonRDGiA3NjIcSWyXiBe1eb0Oz7+D7yExRMjK62Fw2Flg1v5reD482787uD4VuJOMBAQfTKu9w6H1d5vnB2thC9hp7iYSgDZEzaI8+oorHANGwnSTFjvGpa5Q9vTFtKo7NIwv3kwxzVMC66qzG9AgfFFDyAT7JpBmgIA6gIBEABJAARAEgABkARAACQBEABJAASgVDQsAIXpb4Fd/TU4/pt79GdwE9pTCKAPXoR5fojr6ivwOSD+DVx3DU22qJZXA1CfQgA5OAXfA9xOwyfX9g72wwOD6aoHbsNB6HDNg1Bry6Wd8ZU3W/xd11z0y0zPYDMcgTW2tjp6nsnAELTBVXiUcIonsAPmwnRvnhq0fIXBhPiIzDGog1kxc2SXpRaQTgAjg7imwFP0T+Zi4Pdyp+6CdBsqCYAASAIgAJIACIAUpjQ8iC2CA7DaMoDHPQnn4CPcgJaE+GrL3B6Id4iekK8lvPJZB8et8qEYh8j0Gs76rzuKPb17lRmSI3tgV1zvbbXH4LyVd9q7DkcLbO9CSPtrUzgFZW3jQt4E7wp7U7PQte2xAZpX8+P2N0TDf21YY6tSCGA2bArzjP4oS1xDZXBlFe7R8uD4ynRehMsm83fRXZAkAAIgCYAASAIgAJIACIAkAAIgAJIACIBUrAAKzc8fLnUAfcGuOffoq7DgIUvSdtQWnNb6NJ0A7oT5PYb3ruEy3A+Ib4CbrqE5bufCWLXCmVQCKKuzrILtiU4ttuzf7dp6YR8cgm32Ta1xM1LGxnejZRXETlbnLMO8yr5dlh07KWXtY37P4VLYRpYiBNABe22Pw/IJGxRGNji0w8PkaaLLBnF9Ic1otFKK+r+kGl0G7lmRdBsqAJIACIAkAAIgCYAASFOvfwIMAIJ7Za+ecZHPAAAAAElFTkSuQmCC",!0,"SHADOWMASK_INLINE"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAJ9JREFUeNrs0bEJgEAURMHFWGzIOmzLQqzJJkyMBDUw85DLRJzHpQv/mCzJXvf6lJqq92NxP1Tv5/u4Sz59/1kTvRoAAAAEAIAAABAAAAIAQAAACAAAAQAgAA+tAN5tAyAAAAQAgAAAEAAAAgBAAAC4/hdfaAEIAAABACAAAAQAgAAAEAAAAgBAAAAIAAABACAAAAQAgAAAEAAAujoEGADEOVdpwC68FwAAAABJRU5ErkJggg==",!0,"SHADOWMASK_APERTURE"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAedJREFUeNrsnL9rFEEcR9+uPwhyXBQbm1QWRsg/kcomiCCWVoLYpE5rbWehFnYWpk9lIQhCCCgKWgmCoNglCIomBs/EzVReMnd+RTj94ntMczv72f3OvpvhDpahgQvwGD7AF/j8U+s+foSXsAhTjOAo3IfBcHJf63pvMpqr5aSt0flv8ARmDib7kL1+LsE27P6qXR9192uBcNe+ludUYQ7exS5xqzqA7PXzLJbegLPVApZj+a7dqOYvhvOvqgPIXn97mhAn4US14xBRDlePtn+Yz15/24QvED9zkmSvv0UUoABRgAJEAQoQBShAFKAAUYACRAEK+NfZTP70N7MLGCQXMHAJcglSgChAAaIABYgCFCAKUIAoQAFWP7H6cw+hl1xAzyXISawAUYACRAEKEAUoQBSgAFGAAkQBCpAcAnbCZ+7+xtHJ8bfrb+Ov2NffBX8aC3+H59WON7Aeu8Rq9Wj2+rkT2+7pEUxX8z14EMjfGzPZlgL513DmYLKfv/7mFNyFhbHuXsCVsjlYneOl+1zZk2rfjG7K92OlDGBrzB3Ow+WyrV07PKnbEluD2/C2OoBjyevf20aqG8M8zMKR4XRTZt57eBieZhOmG8Cn5PXnpp+/fn+G+j9AAaIABYgCFCAK+P/4IcAAEwdyjgWX2v0AAAAASUVORK5CYII=",!0,"SHADOWMASK_LCD"),this.loadTexture("data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAIAAABdtOgoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAACPNJREFUeNrsXFuMFEUUPdUzs7vsg13XZRVlgQUiKhJFjYhiQnxFIyHqjxHlx2j48c8fE01MjMZHYjTGD2NEVDB+YYgJiYogIT54BJ+orKgQwkN5LC9hd2dnuu051TXTM1vd0z0zDRThZjKZ7qmqe27fW7du3bozAiQBOMBFwFFeXg9cB9wMXAV0884g8DuwCfgR+J53ZGPZsTrJdu3Af7ycAUzn6JOBDt45Cewhj7+AP3lHNo7AwHTwHl0MHAG6gCXAw0A/+wrVwlGXu4CPgRXAMdUlKo0HThDZncACYKIasUjy8gCwAfiSAsguEchc8N4YXcQ0E3gWuBtI+XA7ql1RnhywFngBGFAdq5O0iEnAI8ANgKUYwMeg+J6noX4E7PXZXTAZDT4lxz/BafsacDtgq1fF7CnetDj/ZgPbgd3sng1nMg44zWm7lGzkgxnLoPjAXAZ9NGN39H/ZPRf2cMwFX1BAG3AKuIIC3AIM+yavGDNZijPaVfM0Gt0WTjt3kNEgDi0cdBIFmEVxozBwJbyMvQbowlv0YhgNvqQAl8UrwF3ASMWyEOq23DGncJX7VMngBMng4n6ci+NoHAbuc+rlKvedksHRKMBc8J4CXAEWA08ATWxmRVuTBNVsUc0Hga30p8Paplm6hnuBDPuIyAykv+gBjtOU2jTOwmjwUB4Li4ggG1mAYs8sOy7ipWsfzUFN59HX5iILUBQjx47zlE1lNK2MBl9A8iCnV9zx/VzmAA9wtW/VNprPwDmPGinPBfBWYEjzkIwG7ylgNp1VPTJcwqBCXqbGNuqnpeVrZZDnrqlfXZbbudHgPQX016HgYgA2mR+OaufZpfSedTLo5QfXUNOVz8dc8J4CpozZ09XAoo/rjaM1ot66Gbg0AehUK5uPjAbvKaA7Yj4kVIZulXXRsOhoBIMOlXURZQupueBLUqTrZiH306mwvXbdZOnNx2jw3pen655h4F59yJcaKaORRsgwohnHIV9DwZcUcLBuGdzuh4B9KuVSSccaweC4Sl3aZQowF3xJAQN1T2SLafBR5l81SZW9nMhOfTLsZ8zYWhn0GA3eA7CTE1DUMf4QZQDzARoZ9nHTWQ+DLHNmYJxYntUyGryngPXA38wX1RDv2uzodl8f4jB/IIKmmuzIYccDHASadIrR4EsuaDMnhxWTi4xr8+w+wAOmk9p27izeoTJZcRnItNkODjJerZXlLshc8KU46w9gLlODcbfczTxlfUatVYFZdRfBldzt2DEZZOgglqtzJZ0PNRp8QQFdwD8c/EZuFyLmVWwKcBh4A9jIfMnJoKbtPJRweG7SGvk5ORTAjR8+AX7hIDoLMhq8pwCJZhun4Wx1giYiCOCGzx8AbxLYSEhOxiaanZyG/exZVQwpwDBPb1ezy6jezRsN3lNAXgUAG2gL05i/yysn5pQv6dJ1jmPsvAJ4TsUPw+ESywDgZ9rCRL7boQya6BfWAR+quZwNTPeaC95TgIyU5LHcV8pf9dE0HN/gFpeLZtqLGza8D7zOr+SprKia9pXHcj8pcSfwjuOrJ7AU+lGGDV8Aq/iVPJUVYWGeoeCLHAp9ZUzWTMfVCzzKI+hruLiNY7shrkbbgV+BldyCdlKeYdW9ChMZk2UosWurdwBT+epRJxUj9Mq7+VpHI5LPNVslAjEafClBV5xA3RxK0n2UoY2fT1GGNeqrHi5OdtziMkFnelzdnMuBWvh5mIw3q686WW3ixKiMMxR8ZeAU62Q1NqUbkTw7v8BbFQu4nagMTiPSx8Fjmwv+fKD0hUdwgc5ZEmPdXWK9DAMvyhb6ZErgfdTNAMSlm1jRM5/hYjdHOcJA8RtubLeUN44WpZgJ3reuJ1m/T5IV+e77Y6zjn6GiR39Rq8WNv7uJfDdeEb+x4EUp65RUCbw0M4nG3SE9Dyz0MajYzguVmvwMeJqpYmlKoRsmk8Hz2D/hEnhmaAaZsnyLhcyOqtfXRpKyQmcW02sDtKlu4gvI+RsLPiMKiaBU8iXwneoHLMtYqppVm1ARPCOlhNOAq5lb2cVBdEkzU8EXRmi2hEuphEvgWzio2/Rtms9wMHotg6lMvqxilG9p0sYmg885hVcq4RL4dmZiFgNPxmQAxeBylhVsozBjzjWMBl8KVJMqgc8oX7mE0zAfn8EoF8CHeHlEJTfLyWjwBQUkWALfykBvIavwRU2ZFPmc5tLI5fFJORkN3lNAgiXwUqZ7GAnUXF7jMGK/Te/gjQbvKSCpEviMssw+33SugWwOOscX1fvIaPCeApIqgU+rfeD4aNFJyBNKMWaEpnbEaPCeApIqgZfmNJMrXf0kl8jTlbeNBu9xSrYEPtOgGvuwjbyh4DNCMk+qBF5a5mB42Uc0Ey2+pzR8TQUvUkKkhbASK4HPcXuzn3sZ1OEphEooQxNKGwzeGbadIduxEiuBz6qahEP1rWPyN9Xb9TPAaPBei6RK4G11sYmGmqn1OVmMH77WPwijwXstEiyBl9mPlbQxq1YfmuJj/rbCR3hkNHhPAQmWwGdVMn1j/OJu/251DXmM1yyJRoMvJeNW87C0hrqONDuuDgpI8moivwr8xs193IRiMx3oMp+/GENGgy/MkWRL4LPMpRxgJLCA7UYjM5B1xi/xhK9H/SVfORkN3lNA4iXwMu27lQzmqdYiggCuWb4DvEwBDgfmWswFX6aABEvgbZVpXMv8+HQmMO1Q19nMEublwFNKpFyYAgwF7ykg8RJ4yUDazufMOlr8m40WX3BWLOIvGqdrPi/yq7awH8QbDb40RMIl8KpFC3eDRznoUlY1XcviqVaVq9rDp+ga83ssWOgi16EqDIwGX1kZl2AJfJHBBM5QSfdThnaVj9+jghKZaD4cNcA0GnxlZNaYEvjw6oE2dQiipV6VBogfVpoLvpHZ3YaR/Bcxq7RfOR/BizOLyfLVU8L3f7ZOcC4FSf/w4uyCT59RGYRVeHli0KsW8Nt6GSxYaUcU3i2rCSOD9rmhAB947/k6oYcBVdRgnQ1J/LWDwfGlDTvrODlqLS0yHda5MQ8igC9TAAL/MNF1Ui3ifwEGAI7Rd9mplcoZAAAAAElFTkSuQmCC",!0,"SHADOWMASK_BAYER")])}async loadTexture(t,e,s){const i=this.gl,r=this.textures[s],a=await w(t);i.bindTexture(i.TEXTURE_2D,r.glTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,a),e&&i.generateMipmap(i.TEXTURE_2D),r.width=a.naturalWidth,r.height=a.naturalHeight}loadShaders(){this.loadShader("COMPOSITE","\nprecision mediump float;\n\nvarying vec2 v_texCoord;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\nuniform float subcarrier;\nuniform sampler2D phaseInfo;\nuniform vec3 c0, c1, c2, c3, c4, c5, c6, c7, c8;\nuniform mat3 decoderMatrix;\nuniform vec3 decoderOffset;\n\nfloat PI = 3.14159265358979323846264;\n\nvec3 pixel(in vec2 q)\n{\n  vec3 c = texture2D(texture, q).rgb;\n  vec2 p = texture2D(phaseInfo, vec2(0, q.y)).rg;\n  float phase = 2.0 * PI * (subcarrier * textureSize.x * q.x + p.x);\n  return c * vec3(1.0, sin(phase), (1.0 - 2.0 * p.y) * cos(phase));\n}\n\nvec3 pixels(vec2 q, float i)\n{\n  return pixel(vec2(q.x + i, q.y)) + pixel(vec2(q.x - i, q.y));\n}\n\nvoid main(void)\n{\n  vec2 q = v_texCoord;\n  vec3 c = pixel(q) * c0;\n  c += pixels(q, 1.0 / textureSize.x) * c1;\n  c += pixels(q, 2.0 / textureSize.x) * c2;\n  c += pixels(q, 3.0 / textureSize.x) * c3;\n  c += pixels(q, 4.0 / textureSize.x) * c4;\n  c += pixels(q, 5.0 / textureSize.x) * c5;\n  c += pixels(q, 6.0 / textureSize.x) * c6;\n  c += pixels(q, 7.0 / textureSize.x) * c7;\n  c += pixels(q, 8.0 / textureSize.x) * c8;\n  gl_FragColor = vec4(decoderMatrix * c + decoderOffset, 1.0);\n}\n",p),this.loadShader("RGB","\nprecision mediump float;\n\nvarying vec2 v_texCoord;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\nuniform vec3 c0, c1, c2, c3, c4, c5, c6, c7, c8;\nuniform mat3 decoderMatrix;\nuniform vec3 decoderOffset;\n\nvec3 pixel(vec2 q)\n{\n  return texture2D(texture, q).rgb;\n}\n\nvec3 pixels(in vec2 q, in float i)\n{\n  return pixel(vec2(q.x + i, q.y)) + pixel(vec2(q.x - i, q.y));\n}\n\nvoid main(void)\n{\n  vec2 q = v_texCoord;\n  vec3 c = pixel(q) * c0;\n  c += pixels(q, 1.0 / textureSize.x) * c1;\n  c += pixels(q, 2.0 / textureSize.x) * c2;\n  c += pixels(q, 3.0 / textureSize.x) * c3;\n  c += pixels(q, 4.0 / textureSize.x) * c4;\n  c += pixels(q, 5.0 / textureSize.x) * c5;\n  c += pixels(q, 6.0 / textureSize.x) * c6;\n  c += pixels(q, 7.0 / textureSize.x) * c7;\n  c += pixels(q, 8.0 / textureSize.x) * c8;\n  gl_FragColor = vec4(decoderMatrix * c + decoderOffset, 1.0);\n}\n",p),this.loadShader("DISPLAY","\nprecision mediump float;\n\nvarying vec2 v_texCoord;\nvarying vec2 v_texCoord2;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\nuniform float barrel;\nuniform vec2 barrelSize;\nuniform float scanlineLevel;\nuniform sampler2D shadowMask;\nuniform vec2 shadowMaskSize;\nuniform float shadowMaskLevel;\nuniform float centerLighting;\nuniform sampler2D persistence;\nuniform vec2 persistenceSize;\nuniform vec2 persistenceOrigin;\nuniform float persistenceLevel;\nuniform float luminanceGain;\n\nfloat PI = 3.14159265358979323846264;\n\nvoid main(void)\n{\n  vec2 qc = (v_texCoord2 - vec2(0.5, 0.5)) * barrelSize;\n  vec2 qb = barrel * qc * dot(qc, qc);\n  vec2 q = v_texCoord + qb;\n\n  vec3 c = texture2D(texture, q).rgb;\n\n  float scanline = sin(PI * textureSize.y * q.y);\n  c *= mix(1.0, scanline * scanline, scanlineLevel);\n\n  vec3 mask = texture2D(shadowMask, (v_texCoord2 + qb) * shadowMaskSize).rgb;\n  c *= mix(vec3(1.0, 1.0, 1.0), mask, shadowMaskLevel);\n\n  vec2 lighting = qc * centerLighting;\n  c *= exp(-dot(lighting, lighting));\n\n  c *= luminanceGain;\n\n  vec2 qp = v_texCoord2 * persistenceSize + persistenceOrigin;\n  c = max(c, texture2D(persistence, qp).rgb * persistenceLevel - 0.5 / 256.0);\n\n  gl_FragColor = vec4(c, 1.0);\n}\n","\n// an attribute will receive data from a buffer\nattribute vec4 a_position;\nattribute vec2 a_texCoord;\nattribute vec2 a_texCoord2;\nvarying vec2 v_texCoord;\nvarying vec2 v_texCoord2;\n\n// all shaders have a main function\nvoid main() {\n  gl_Position = vec4(a_position.x, -a_position.y, a_position.z, a_position.w);\n  v_texCoord = a_texCoord;\n  v_texCoord2 = a_texCoord2;\n}\n")}loadShader(t,e,s){const i=R(this.gl,t,this.gl.VERTEX_SHADER,s),r=R(this.gl,t,this.gl.FRAGMENT_SHADER,e),a=T(this.gl,t,i,r);this.gl.deleteShader(i),this.gl.deleteShader(r),this.shaders[t]=a}deleteShaders(){for(let t of S)this.shaders[t]&&(this.gl.deleteProgram(this.shaders[t]),this.shaders[t]=!1)}vsync(){const t=this.gl;E(this.canvas);const s=this.canvas.width,i=this.canvas.height;this.viewportSize.width==s&&this.viewportSize.height==this.canvasHeight||(this.viewportSize=new e(s,i),t.viewport(0,0,s,i),this.configurationChanged=!0),this.imageChanged&&this.uploadImage(),this.configurationChanged&&this.configureShaders(),(this.imageChanged||this.configurationChanged)&&this.renderImage(),(this.imageChanged||this.configurationChanged||0!=this.image.displayPersistence)&&this.drawDisplayCanvas(),this.imageChanged=!1,this.configurationChanged=!1}uploadImage(){const t=this.gl,e=this.image;this.resizeTexture("IMAGE_IN",e.width,e.height,!0);const s=this.textures.IMAGE_IN;t.bindTexture(t.TEXTURE_2D,s.glTexture);const i=t.LUMINANCE,r=t.UNSIGNED_BYTE,a=(t=>{const e=t.width,s=t.height,i=t.data,r=e*s,a=new Uint8Array(r);for(let t=0;t<r;t++)a[t]=Math.max(i[4*t],i[4*t+1],i[4*t+2]);return a})(e.data);t.texSubImage2D(t.TEXTURE_2D,0,0,0,e.data.width,e.data.height,i,r,a),e.sampleRate==this.imageSampleRate&&e.blackLevel==this.imageBlackLevel&&e.whiteLevel==this.imageWhiteLevel&&e.subCarrier==this.imageSubcarrier||(this.imageSampleRate=e.sampleRate,this.imageBlackLevel=e.blackLevel,this.imageWhiteLevel=e.whiteLevel,this.imageSubcarrier=e.subCarrier,this.configurationChanged=!0);const n=2**Math.ceil(Math.log2(e.height)),o=e.colorBurst,h=e.phaseAlternation,d=new Float32Array(3*n);for(let t=0;t<e.height;t++){const e=o[t%o.length]/2/Math.PI;d[3*t+0]=e-Math.floor(e),d[3*t+1]=h[t%h.length]}const c=this.textures.IMAGE_PHASEINFO;t.bindTexture(t.TEXTURE_2D,c.glTexture),t.texImage2D(t.TEXTURE_2D,0,t.RGB,1,n,0,t.RGB,t.FLOAT,d)}getRenderShader(){switch(this.display.videoDecoder){case"CANVAS_RGB":case"CANVAS_MONOCHROME":return[this.shaders.RGB,"RGB"];case"CANVAS_YUV":case"CANVAS_YIQ":case"CANVAS_CXA2025AS":return[this.shaders.COMPOSITE,"COMPOSITE"]}const t=this.display.videoDecoder;throw new Error(`unknown displayConfiguration.videoDecoder: ${t}`)}configureShaders(){const t=this.gl,[e,s]=this.getRenderShader(),a=this.shaders.DISPLAY,n="COMPOSITE"==s;t.useProgram(e),n&&t.uniform1f(t.getUniformLocation(e,"subcarrier"),this.imageSubcarrier/this.imageSampleRate);const o=i.chebyshevWindow(17,50).normalize();let h,c,l;const m=this.display.videoBandwidth/this.imageSampleRate;if(n){let t=this.display.videoLumaBandwidth/this.imageSampleRate,e=this.display.videoChromaBandwidth/this.imageSampleRate,s=e;"CANVAS_YIQ"==this.display.videoDecoder&&(e+=d/this.imageSampleRate),(0==this.imageSubcarrier||this.display.videoWhiteOnly)&&(t=m,e=m,s=m),h=o.mul(i.lanczosWindow(17,t)),h=h.normalize(),c=o.mul(i.lanczosWindow(17,e)),c=c.normalize().mul(2),l=o.mul(i.lanczosWindow(17,s)),l=l.normalize().mul(2)}else h=o.mul(i.lanczosWindow(17,m)),c=l=h=h.normalize();t.uniform3f(t.getUniformLocation(e,"c0"),h.data[8],c.data[8],l.data[8]),t.uniform3f(t.getUniformLocation(e,"c1"),h.data[7],c.data[7],l.data[7]),t.uniform3f(t.getUniformLocation(e,"c2"),h.data[6],c.data[6],l.data[6]),t.uniform3f(t.getUniformLocation(e,"c3"),h.data[5],c.data[5],l.data[5]),t.uniform3f(t.getUniformLocation(e,"c4"),h.data[4],c.data[4],l.data[4]),t.uniform3f(t.getUniformLocation(e,"c5"),h.data[3],c.data[3],l.data[3]),t.uniform3f(t.getUniformLocation(e,"c6"),h.data[2],c.data[2],l.data[2]),t.uniform3f(t.getUniformLocation(e,"c7"),h.data[1],c.data[1],l.data[1]),t.uniform3f(t.getUniformLocation(e,"c8"),h.data[0],c.data[0],l.data[0]);let u=new r(1,0,0,0,1,0,0,0,1);n||(u=new r(.299,-.168736,.5,.587,-.331264,-.418688,.114,.5,-.081312).mul(u)),"CANVAS_MONOCHROME"==this.display.videoDecoder&&(u=new r(1,.5,0,0,0,0,0,0,0).mul(u)),n&&(0==this.imageSubcarrier||this.display.videoWhiteOnly)&&(u=new r(1,0,0,0,0,0,0,0,0).mul(u)),u=new r(1,0,0,0,this.display.videoSaturation,0,0,0,this.display.videoSaturation).mul(u);let f=2*Math.PI*this.display.videoHue;switch(u=new r(1,0,0,0,Math.cos(f),-Math.sin(f),0,Math.sin(f),Math.cos(f)).mul(u),this.display.videoDecoder){case"CANVAS_RGB":case"CANVAS_MONOCHROME":u=new r(1,1,1,0,-.344136,1.772,1.402,-.714136,0).mul(u);break;case"CANVAS_YUV":case"CANVAS_YIQ":u=new r(1,1,1,0,-.394642,2.032062,1.139883,-.580622,0).mul(u);break;case"CANVAS_CXA2025AS":u=new r(1,0,0,0,0,1,0,1,0).mul(u),f=33*-Math.PI/180,u=new r(1,0,0,0,Math.cos(f),-Math.sin(f),0,Math.sin(f),Math.cos(f)).mul(u),u=new r(1,1,1,1.63,-.378,-1.089,.317,-.466,1.677).mul(u);break;default:throw new Error(`unknown videoDecoder: ${this.display.videoDecoder}`)}const g=this.display.videoBrightness-this.imageBlackLevel;let p;p=n?u.mul(new r(g,0,0,0,0,0,0,0,0)):u.mul(new r(g,0,0,g,0,0,g,0,0)),t.uniform3f(t.getUniformLocation(e,"decoderOffset"),p.at(0,0),p.at(0,1),p.at(0,2));let A=this.display.videoContrast;const b=this.imageWhiteLevel-this.imageBlackLevel;b>0?A/=b:A=0,A<0&&(A=0),u=u.mul(A),t.uniformMatrix3fv(t.getUniformLocation(e,"decoderMatrix"),!1,u.data),t.useProgram(a),t.uniform1f(t.getUniformLocation(a,"barrel"),this.display.displayBarrel),t.uniform1i(t.getUniformLocation(a,"shadowMask"),1),t.uniform1f(t.getUniformLocation(a,"shadowMaskLevel"),this.display.displayShadowMaskLevel),t.uniform1f(t.getUniformLocation(a,"persistenceLevel"),this.display.displayPersistence/(1/60+this.display.displayPersistence)),0==this.display.displayPersistence&&this.resizeTexture("IMAGE_PERSISTENCE",0,0);let _=this.display.displayCenterLighting;Math.abs(_)<.001&&(_=.001),t.uniform1f(t.getUniformLocation(a,"centerLighting"),1/_-1),t.uniform1f(t.getUniformLocation(a,"luminanceGain"),this.display.displayLuminanceGain)}renderImage(){const t=this.gl,[e,i]=this.getRenderShader(),r="COMPOSITE"==i;t.useProgram(e);const a=this.textures.IMAGE_IN.size;this.resizeTexture("IMAGE_DECODED",a.width,a.height),t.uniform1i(t.getUniformLocation(e,"texture"),0),t.uniform2f(t.getUniformLocation(e,"textureSize"),a.width,a.height),r&&(t.uniform1i(t.getUniformLocation(e,"phaseInfo"),1),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.textures.IMAGE_PHASEINFO.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.activeTexture(t.TEXTURE0));const n=this.image.size;for(let i=0;i<this.image.height;i+=this.viewportSize.height)for(let r=0;r<this.image.width;r+=this.viewportSize.width){const o=this.viewportSize.copy();r+o.width>n.width&&(o.width=n.width-r),i+o.height>n.height&&(o.height=n.height-i);const h=new s(r/a.width,i/a.height,o.width/a.width,o.height/a.height),d=new s(-1,-1,2*o.width/this.viewportSize.width,2*o.height/this.viewportSize.height);t.bindTexture(t.TEXTURE_2D,this.textures.IMAGE_IN.glTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),this.drawRectangle(e,d,h),t.bindTexture(t.TEXTURE_2D,this.textures.IMAGE_DECODED.glTexture),t.copyTexSubImage2D(t.TEXTURE_2D,0,r,i,0,0,o.width,o.height)}}drawRectangle(t,e,s,i){const r=this.gl;r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);const a=r.getAttribLocation(t,"a_position"),n=[r.getAttribLocation(t,"a_texCoord")],o=[s];i&&(n.push(r.getAttribLocation(t,"a_texCoord2")),o.push(i));const h=this.buffers[0];r.bindBuffer(r.ARRAY_BUFFER,h);const d=e.l,c=e.r,l=e.t,m=e.b;r.bufferData(r.ARRAY_BUFFER,new Float32Array([d,l,c,l,d,m,d,m,c,l,c,m]),r.STATIC_DRAW),r.enableVertexAttribArray(a),r.bindBuffer(r.ARRAY_BUFFER,h),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0);for(let t=0;t<o.length;t++){const e=this.buffers[t+1];r.bindBuffer(r.ARRAY_BUFFER,e);const s=o[t].l,i=o[t].r,a=o[t].t,h=o[t].b;r.bufferData(r.ARRAY_BUFFER,new Float32Array([s,a,i,a,s,h,s,h,i,a,i,h]),r.STATIC_DRAW),r.enableVertexAttribArray(n[t]),r.bindBuffer(r.ARRAY_BUFFER,e),r.vertexAttribPointer(n[t],2,r.FLOAT,!1,0,0)}r.drawArrays(r.TRIANGLES,0,6)}drawDisplayCanvas(){const i=this.gl,r=this.shaders.DISPLAY;if(0==this.image.width||0==this.image.height)return void this.resizeTexture("IMAGE_PERSISTENCE",0,0);const a=this.display.displayResolution,n=new s(-1,-1,2,2),o=this.viewportSize.ratio,h=a.ratio,d=o/h;d>1?(n.origin.x/=d,n.size.width/=d):(n.origin.y*=d,n.size.height*=d);const c=new s(0,0,1,1),l=this.image.interlace/this.image.height,m=this.getDisplayCanvasTexPoint(new t(-1,2*l-1)),u=this.getDisplayCanvasTexPoint(new t(1,1+2*l)),f=new s(m.x,m.y,u.x-m.x,u.y-m.y),g=new e(.5*this.viewportSize.width*n.size.width,.5*this.viewportSize.height*n.size.height),p=new e(g.width*this.display.videoSize.width,g.height*this.display.videoSize.height);let A;const b=this.textures.IMAGE_DECODED;i.useProgram(r);const _=b.size;i.uniform1i(i.getUniformLocation(r,"texture"),0),i.uniform2f(i.getUniformLocation(r,"textureSize"),_.width,_.height),A=new s(-.5,-.5/h,1,1/h),i.uniform2f(i.getUniformLocation(r,"barrelSize"),1,1/h);const w=p.height/this.image.height;let y,S,E=this.display.displayScanlineLevel;switch(E=w>2.5?E:w<2?0:(w-2)/.5*E,i.uniform1f(i.getUniformLocation(r,"scanlineLevel"),E),this.display.displayShadowMask){case"SHADOWMASK_TRIAD":y=this.textures.SHADOWMASK_TRIAD,S=2/(274/240);break;case"SHADOWMASK_INLINE":y=this.textures.SHADOWMASK_INLINE,S=2;break;case"SHADOWMASK_APERTURE":y=this.textures.SHADOWMASK_APERTURE,S=2;break;case"SHADOWMASK_LCD":y=this.textures.SHADOWMASK_LCD,S=2;break;case"SHADOWMASK_BAYER":y=this.textures.SHADOWMASK_BAYER,S=2}let R=this.display.displayShadowMaskDotPitch;R<=.001&&(R=.001);const T=a.width/this.display.displayPixelDensity*25.4*.5/R,v=new e(T,T*S/h);i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,y.glTexture),i.uniform2f(i.getUniformLocation(r,"shadowMaskSize"),v.width,v.height),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.textures.IMAGE_PERSISTENCE.glTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.activeTexture(i.TEXTURE0),i.uniform1i(i.getUniformLocation(r,"persistence"),2),i.uniform2f(i.getUniformLocation(r,"persistenceOrigin"),this.persistenceTexRect.x,this.persistenceTexRect.y),i.uniform2f(i.getUniformLocation(r,"persistenceSize"),this.persistenceTexRect.width,this.persistenceTexRect.height),i.bindTexture(i.TEXTURE_2D,b.glTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),this.drawRectangle(r,n,f,c)}getDisplayCanvasTexPoint(e){const s=this.display.videoCenter,i=this.display.videoSize;e=new t((e.x-2*s.x)/i.width,(e.y-2*s.y)/i.height);const r=this.image.size,a=this.textures.IMAGE_IN.size;return e.x=.5*(e.x+1)*r.width/a.width,e.y=.5*(e.y+1)*r.height/a.height,e}resizeTexture(t,e,s,i=!1){const r=this.gl,a=this.textures[t];if(!a)throw new Error(`Cannot find texture named ${t}`);if(e<4&&(e=4),s<4&&(s=4),e=2**Math.ceil(Math.log2(e)),s=2**Math.ceil(Math.log2(s)),a.width!=e||a.height!=s){a.width=e,a.height=s,r.bindTexture(r.TEXTURE_2D,a.glTexture);const t=new Uint8Array(e*s*(i?1:4)),n=i?r.LUMINANCE:r.RGBA;r.texImage2D(r.TEXTURE_2D,0,n,e,s,0,n,r.UNSIGNED_BYTE,t)}}},DisplayConfiguration:class{constructor(){this.videoDecoder="CANVAS_YUV",this.videoBrightness=0,this.videoContrast=1,this.videoSaturation=1,this.videoHue=0,this.videoCenter=new t(0,0),this.videoSize=new e(1.05,1.05),this.videoBandwidth=6e6,this.videoLumaBandwidth=2e6,this.videoChromaBandwidth=6e5,this.videoWhiteOnly=!1,this.displayResolution=new e(640,480),this.displayPixelDensity=72,this.displayBarrel=.05,this.displayScanlineLevel=.05,this.displayShadowMaskLevel=.05,this.displayShadowMaskDotPitch=.5,this.displayShadowMask="SHADOWMASK_TRIAD",this.displayPersistence=0,this.displayCenterLighting=1,this.displayLuminanceGain=1}},ImageInfo:class{constructor(t){if("object"!=typeof t)throw new Error(`want typeof data == 'object'; got '${typeof t}'`);if(!(t instanceof ImageData))throw new Error(`want data instanceof ImageData; got '${t.constructor.name}'`);this.sampleRate=h,this.blackLevel=0,this.whiteLevel=1,this.interlace=0,this.subCarrier=o,this.colorBurst=b.colorBurst,this.phaseAlternation=[!1],this.data=t}get width(){return this.data.width}get height(){return this.data.height}get size(){return new e(this.data.width,this.data.height)}},Vector:i,Size:e,Point:t}}();t.exports={screenEmu:e}}},i={};function r(t){var e=i[t];if(void 0!==e)return e.exports;var a=i[t]={exports:{}};return s[t](a,a.exports,r),a.exports}r.m=s,r.d=(t,e)=>{for(var s in e)r.o(e,s)&&!r.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,s)=>(r.f[s](t,e),e)),[])),r.u=t=>t+".bundle.js",r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t={},e="Apple2:",r.l=(s,i,a,n)=>{if(t[s])t[s].push(i);else{var o,h;if(void 0!==a)for(var d=document.getElementsByTagName("script"),c=0;c<d.length;c++){var l=d[c];if(l.getAttribute("src")==s||l.getAttribute("data-webpack")==e+a){o=l;break}}o||(h=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",e+a),o.src=s),t[s]=[i];var m=(e,i)=>{o.onerror=o.onload=null,clearTimeout(u);var r=t[s];if(delete t[s],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach((t=>t(i))),e)return e(i)},u=setTimeout(m.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=m.bind(null,o.onerror),o.onload=m.bind(null,o.onload),h&&document.head.appendChild(o)}},r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.p="dist/",(()=>{var t={804:0};r.f.j=(e,s)=>{var i=r.o(t,e)?t[e]:void 0;if(0!==i)if(i)s.push(i[2]);else{var a=new Promise(((s,r)=>i=t[e]=[s,r]));s.push(i[2]=a);var n=r.p+r.u(e),o=new Error;r.l(n,(s=>{if(r.o(t,e)&&(0!==(i=t[e])&&(t[e]=void 0),i)){var a=s&&("load"===s.type?"missing":s.type),n=s&&s.target&&s.target.src;o.message="Loading chunk "+e+" failed.\n("+a+": "+n+")",o.name="ChunkLoadError",o.type=a,o.request=n,i[1](o)}}),"chunk-"+e,e)}};var e=(e,s)=>{var i,a,[n,o,h]=s,d=0;if(n.some((e=>0!==t[e]))){for(i in o)r.o(o,i)&&(r.m[i]=o[i]);h&&h(r)}for(e&&e(s);d<n.length;d++)a=n[d],r.o(t,a)&&t[a]&&t[a][0](),t[a]=0},s=self.webpackChunkApple2=self.webpackChunkApple2||[];s.forEach(e.bind(null,0)),s.push=e.bind(null,s.push.bind(s))})();var a={};return(()=>{"use strict";r.d(a,{Apple2:()=>ji});var t={};r.r(t),r.d(t,{clearPrinterPaper:()=>xe,clickDisk:()=>Ce,compileApplesoftProgram:()=>re,doDelete:()=>Ae,doLoad:()=>ge,doLoadHTTP:()=>we,doSave:()=>pe,driveLights:()=>se,dumpApplesoftProgram:()=>ie,handleDragEnd:()=>ce,handleDragOver:()=>de,handleDrop:()=>le,initUI:()=>Ue,loadAjax:()=>fe,openAlert:()=>oe,openImage:()=>he,openLoad:()=>ae,openOptions:()=>Le,openPrinterModal:()=>Ne,openSave:()=>ne,pauseRun:()=>De,reset:()=>Te,selectCategory:()=>ve,selectDisk:()=>Pe,toggleShowFPS:()=>Ee,toggleSound:()=>Re,updateKHz:()=>Se,updateUI:()=>Me});const e=void 0!==window.localStorage;class s{constructor(){this.url=new URL(window.location.href),this.title=window.document.title}havePrefs(){return e}readPref(t,s=null){var i;return this.url.searchParams.has(t)?this.url.searchParams.get(t):e&&null!==(i=window.localStorage.getItem(t))&&void 0!==i?i:s}writePref(t,s){this.url.searchParams.has(t)&&(this.url.searchParams.set(t,s),history.replaceState(null,this.title,this.url.toString())),e&&window.localStorage.setItem(t,s)}}function i(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function n(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return o(t,e);var s=Object.prototype.toString.call(t).slice(8,-1);return"Object"===s&&t.constructor&&(s=t.constructor.name),"Map"===s||"Set"===s?Array.from(s):"Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s)?o(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var s=0,i=new Array(e);s<e;s++)i[s]=t[s];return i}var h,d,c,l,m,u=(h=["a[href]","area[href]",'input:not([disabled]):not([type="hidden"]):not([aria-hidden])',"select:not([disabled]):not([aria-hidden])","textarea:not([disabled]):not([aria-hidden])","button:not([disabled]):not([aria-hidden])","iframe","object","embed","[contenteditable]",'[tabindex]:not([tabindex^="-"])'],d=function(){function t(e){var s=e.targetModal,i=e.triggers,r=void 0===i?[]:i,a=e.onShow,o=void 0===a?function(){}:a,h=e.onClose,d=void 0===h?function(){}:h,c=e.openTrigger,l=void 0===c?"data-micromodal-trigger":c,m=e.closeTrigger,u=void 0===m?"data-micromodal-close":m,f=e.openClass,g=void 0===f?"is-open":f,p=e.disableScroll,A=void 0!==p&&p,b=e.disableFocus,_=void 0!==b&&b,w=e.awaitCloseAnimation,y=void 0!==w&&w,S=e.awaitOpenAnimation,E=void 0!==S&&S,R=e.debugMode,T=void 0!==R&&R;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.modal=document.getElementById(s),this.config={debugMode:T,disableScroll:A,openTrigger:l,closeTrigger:u,openClass:g,onShow:o,onClose:d,awaitCloseAnimation:y,awaitOpenAnimation:E,disableFocus:_},r.length>0&&this.registerTriggers.apply(this,n(r)),this.onClick=this.onClick.bind(this),this.onKeydown=this.onKeydown.bind(this)}var e,s;return e=t,s=[{key:"registerTriggers",value:function(){for(var t=this,e=arguments.length,s=new Array(e),i=0;i<e;i++)s[i]=arguments[i];s.filter(Boolean).forEach((function(e){e.addEventListener("click",(function(e){return t.showModal(e)}))}))}},{key:"showModal",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.activeElement=document.activeElement,this.modal.setAttribute("aria-hidden","false"),this.modal.classList.add(this.config.openClass),this.scrollBehaviour("disable"),this.addEventListeners(),this.config.awaitOpenAnimation?this.modal.addEventListener("animationend",(function e(){t.modal.removeEventListener("animationend",e,!1),t.setFocusToFirstNode()}),!1):this.setFocusToFirstNode(),this.config.onShow(this.modal,this.activeElement,e)}},{key:"closeModal",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=this.modal;if(this.modal.setAttribute("aria-hidden","true"),this.removeEventListeners(),this.scrollBehaviour("enable"),this.activeElement&&this.activeElement.focus&&this.activeElement.focus(),this.config.onClose(this.modal,this.activeElement,t),this.config.awaitCloseAnimation){var s=this.config.openClass;this.modal.addEventListener("animationend",(function t(){e.classList.remove(s),e.removeEventListener("animationend",t,!1)}),!1)}else e.classList.remove(this.config.openClass)}},{key:"closeModalById",value:function(t){this.modal=document.getElementById(t),this.modal&&this.closeModal()}},{key:"scrollBehaviour",value:function(t){if(this.config.disableScroll){var e=document.querySelector("body");switch(t){case"enable":Object.assign(e.style,{overflow:""});break;case"disable":Object.assign(e.style,{overflow:"hidden"})}}}},{key:"addEventListeners",value:function(){this.modal.addEventListener("touchstart",this.onClick),this.modal.addEventListener("click",this.onClick),document.addEventListener("keydown",this.onKeydown)}},{key:"removeEventListeners",value:function(){this.modal.removeEventListener("touchstart",this.onClick),this.modal.removeEventListener("click",this.onClick),document.removeEventListener("keydown",this.onKeydown)}},{key:"onClick",value:function(t){t.target.hasAttribute(this.config.closeTrigger)&&this.closeModal(t)}},{key:"onKeydown",value:function(t){27===t.keyCode&&this.closeModal(t),9===t.keyCode&&this.retainFocus(t)}},{key:"getFocusableNodes",value:function(){var t=this.modal.querySelectorAll(h);return Array.apply(void 0,n(t))}},{key:"setFocusToFirstNode",value:function(){var t=this;if(!this.config.disableFocus){var e=this.getFocusableNodes();if(0!==e.length){var s=e.filter((function(e){return!e.hasAttribute(t.config.closeTrigger)}));s.length>0&&s[0].focus(),0===s.length&&e[0].focus()}}}},{key:"retainFocus",value:function(t){var e=this.getFocusableNodes();if(0!==e.length)if(e=e.filter((function(t){return null!==t.offsetParent})),this.modal.contains(document.activeElement)){var s=e.indexOf(document.activeElement);t.shiftKey&&0===s&&(e[e.length-1].focus(),t.preventDefault()),!t.shiftKey&&e.length>0&&s===e.length-1&&(e[0].focus(),t.preventDefault())}else e[0].focus()}}],s&&i(e.prototype,s),t}(),c=null,l=function(t){if(!document.getElementById(t))return console.warn("MicroModal: ❗Seems like you have missed %c'".concat(t,"'"),"background-color: #f8f9fa;color: #50596c;font-weight: bold;","ID somewhere in your code. Refer example below to resolve it."),console.warn("%cExample:","background-color: #f8f9fa;color: #50596c;font-weight: bold;",'<div class="modal" id="'.concat(t,'"></div>')),!1},m=function(t,e){if(function(t){t.length<=0&&(console.warn("MicroModal: ❗Please specify at least one %c'micromodal-trigger'","background-color: #f8f9fa;color: #50596c;font-weight: bold;","data attribute."),console.warn("%cExample:","background-color: #f8f9fa;color: #50596c;font-weight: bold;",'<a href="#" data-micromodal-trigger="my-modal"></a>'))}(t),!e)return!0;for(var s in e)l(s);return!0},{init:function(t){var e=Object.assign({},{openTrigger:"data-micromodal-trigger"},t),s=n(document.querySelectorAll("[".concat(e.openTrigger,"]"))),i=function(t,e){var s=[];return t.forEach((function(t){var i=t.attributes[e].value;void 0===s[i]&&(s[i]=[]),s[i].push(t)})),s}(s,e.openTrigger);if(!0!==e.debugMode||!1!==m(s,i))for(var r in i){var a=i[r];e.targetModal=r,e.triggers=n(a),c=new d(e)}},show:function(t,e){var s=e||{};s.targetModal=t,!0===s.debugMode&&!1===l(t)||(c&&c.removeEventListeners(),(c=new d(s)).showModal())},close:function(t){t?c.closeModalById(t):c.closeModal()}});window.MicroModal=u;const f=u,g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function p(t){let e,s,i,r,a,n,o,h,d=0,c=0,l="";const m=[];if(t){do{e=t[d++],s=t[d++],i=t[d++],h=e<<16|s<<8|i,r=h>>18&63,a=h>>12&63,n=h>>6&63,o=63&h,m[c++]=g.charAt(r)+g.charAt(a)+g.charAt(n)+g.charAt(o)}while(d<t.length);switch(l=m.join(""),t.length%3){case 1:l=l.slice(0,-2)+"==";break;case 2:l=l.slice(0,-1)+"="}return l}}function A(t){let e,s,i,r,a,n,o,h,d=0,c=0;const l=[];if(t){do{r=g.indexOf(t.charAt(d++)),a=g.indexOf(t.charAt(d++)),n=g.indexOf(t.charAt(d++)),o=g.indexOf(t.charAt(d++)),h=r<<18|a<<12|n<<6|o,e=h>>16&255,s=h>>8&255,i=255&h,l[c++]=e,64!==n&&(l[c++]=s),64!==o&&(l[c++]=i)}while(d<t.length);return new Uint8Array(l)}}const b="data:application/octet-stream;base64,";function _(t){return JSON.parse(t,((t,e)=>"string"==typeof e&&e.startsWith(b)?A(e.slice(b.length)):e))}const w="BOOLEAN_OPTION",y="SELECT_OPTION",S="0123456789ABCDEF";function E(){return 256*Math.random()&255}function R(t){const e=new Uint8Array(t);for(let s=0;s<t;s++)e[s]=2&s?0:255;for(let s=0;s<t;s+=512)e[s+40]=E(),e[s+41]=E(),e[s+104]=E(),e[s+105]=E();return e}function T(t){return R(t<<8)}function v(t){return new Uint8Array(t)}function P(...t){console.log(...t)}function C(t,e){e||(e=t<256?2:4);let s="";for(let i=0;i<e;i++)s=S[15&t]+s,t>>=4;return s}const I="enable_sound",O=window.AudioContext||window.webkitAudioContext;class k{constructor(t){if(this.sound=!0,this.samples=[],this.started=!1,this.autoStart=()=>{this.audioContext&&!this.started&&(this.samples=[],this.audioContext.resume().then((()=>{this.started=!0})).catch((t=>{console.warn("audio not started",t)})))},this.start=()=>{this.audioContext&&(this.samples=[],this.audioContext.resume().catch((t=>{console.warn("audio not resumed",t)})))},this.isEnabled=()=>this.sound,this.setOption=(t,e)=>{t===I&&(this.sound=e)},this.audioContext=new O({sampleRate:44e3}),window.AudioWorklet){const e=this.audioContext.audioWorklet.addModule("./dist/audio_worker.bundle.js");this.ready=e.then((()=>{this.workletNode=new AudioWorkletNode(this.audioContext,"audio_worker"),t.sampleRate(this.audioContext.sampleRate,128),t.addSampleListener((t=>{this.sound&&"running"===this.audioContext.state&&this.workletNode.port.postMessage(t)})),this.workletNode.connect(this.audioContext.destination)})).catch(console.error)}else this.audioNode=this.audioContext.createScriptProcessor(1024,1,1),this.audioNode.onaudioprocess=t=>{const e=t.outputBuffer.getChannelData(0),s=this.samples.shift();let i=0,r=e.length;if(s)for(r=Math.min(s.length,r);i<r;i++)e[i]=s[i];for(;i<e.length;i++)e[i]=0},this.audioNode.connect(this.audioContext.destination),t.sampleRate(this.audioContext.sampleRate,1024),t.addSampleListener((t=>{this.sound&&"running"===this.audioContext.state&&this.samples.length<5&&this.samples.push(t)})),this.ready=Promise.resolve();window.addEventListener("keydown",this.autoStart),void 0!==window.ontouchstart&&window.addEventListener("touchstart",this.autoStart),window.addEventListener("mousedown",this.autoStart),P("Sound initialized")}getOptions(){return[{name:"Audio",options:[{name:I,label:"Enabled",type:w,defaultVal:!0}]}]}}function M(t,e){return t.includes(e)}const D=[1,2],L="empty",N="nibble",x="bitstream",B="block",F=["2mg","d13","do","dsk","po","nib"],U=[...F,"woz"],X=["2mg","hdv","po"],z=[...U,...X];function H(t){return(null==t?void 0:t.encoding)===L}function G(t){return(null==t?void 0:t.encoding)===N}function Z(t){return(null==t?void 0:t.encoding)===x}const Y={A:0,B:1,X:2,Y:3,L1:4,R1:5,L3:6,R3:7,START:8,SELECT:9,LOGO:10,UP:11,DOWN:12,LEFT:13,RIGHT:14};let W=null;const K={A:0,B:1,L1:0,R1:1,START:""},j=[],q=[];function V(t){for(let t=0;t<16;t++)j[t]=void 0;const e=t||K;for(const t of Object.entries(e)){const e=t[0],s=t[1];let i;i="string"==typeof s?s.charCodeAt(0):-s,e in Y?j[Y[e]]=i:j[parseInt(e,10)]=i}}window.addEventListener("gamepadconnected",(function(t){W=t.gamepad}));const Q={0:[0,0,0],1:[1,1,1],2:[2,2,2],3:[3,3,3],4:[4,4,4],5:[5,5,5],6:[6,6,6],7:[7,7,7],8:[127,127,127],9:[9,9,9],10:[10,10,10],11:[11,11,11],12:[12,12,12],13:[13,13,13],14:[14,14,14],15:[15,15,15],16:[255,255,255],17:[255,255,255],18:[255,255,255],19:[19,19,19],20:[20,20,20],21:[21,21,21],22:[22,22,22],23:[23,23,24],24:[24,24,24],25:[25,25,25],26:[26,26,26],27:[27,27,27],28:[28,28,28],29:[29,29,29],30:[30,30,30],31:[31,31,31],32:[32,32,32],33:[33,33,33],34:[34,34,34],35:[35,35,35],36:[36,36,36],37:[8,8,8],38:[11,11,11],39:[21,21,21],40:[10,10,10],41:[41,41,41],42:[42,42,42],43:[43,43,43],44:[44,44,60],45:[45,45,95],46:[46,46,62],47:[47,47,63],48:[48,48,41],49:[49,49,33],50:[50,0,64],51:[51,51,35],52:[52,52,36],53:[53,53,37],54:[54,54,94],55:[55,55,38],56:[56,56,42],57:[57,57,40],58:[58,58,58],59:[59,59,58],60:[60,60,60],61:[61,61,43],62:[62,62,62],63:[63,63,63],64:[64,0,64],65:[97,1,65],66:[98,2,66],67:[99,3,67],68:[100,4,68],69:[101,5,69],70:[102,6,70],71:[103,7,71],72:[104,8,72],73:[105,9,73],74:[106,10,74],75:[107,11,75],76:[108,12,76],77:[109,13,77],78:[110,14,78],79:[111,15,79],80:[112,16,80],81:[113,17,81],82:[114,18,82],83:[115,19,83],84:[116,20,84],85:[117,21,85],86:[118,22,86],87:[119,23,87],88:[120,24,88],89:[121,25,89],90:[122,26,90],91:[255,255,255],92:[255,255,255],93:[255,255,255],94:[94,30,94],95:[95,31,95],96:[48,48,48],97:[49,49,49],98:[50,50,50],99:[51,51,51],100:[52,52,52],101:[53,53,53],102:[54,54,54],103:[55,55,55],104:[56,56,56],105:[57,57,57],106:[42,42,42],107:[43,43,43],109:[45,45,45],110:[46,46,46],111:[47,47,57],173:[45,45,95],186:[59,59,58],187:[61,61,43],188:[44,44,60],189:[45,45,95],190:[46,46,62],191:[47,47,63],192:[96,96,126],219:[91,27,123],220:[92,28,124],221:[93,29,125],222:[39,34,34],255:[255,255,255]},J={Dead:255,UIKeyInputLeftArrow:8,UIKeyInputRightArrow:21,UIKeyInputUpArrow:11,UIKeyInputDownArrow:10,UIKeyInputEscape:27},$=[[["1","2","3","4","5","6","7","8","9","0",":","-","RESET"],["ESC","Q","W","E","R","T","Y","U","I","O","P","REPT","RETURN"],["CTRL","A","S","D","F","G","H","J","K","L",";","&larr;","&rarr;"],["SHIFT","Z","X","C","V","B","N","M",",",".","/","SHIFT"],["POWER","&nbsp;"]],[["!",'"',"#","$","%","&","'","(",")","0","*","=","RESET"],["ESC","Q","W","E","R","T","Y","U","I","O","@","REPT","RETURN"],["CTRL","A","S","D","F","BELL","H","J","K","L","+","&larr;","&rarr;"],["SHIFT","Z","X","C","V","B","^","]","<",">","?","SHIFT"],["POWER","&nbsp;"]]],tt=[[["ESC","1","2","3","4","5","6","7","8","9","0","-","=","DELETE"],["TAB","Q","W","E","R","T","Y","U","I","O","P","[","]","\\"],["CTRL","A","S","D","F","G","H","J","K","L",";",'"',"RETURN"],["SHIFT","Z","X","C","V","B","N","M",",",".","/","SHIFT"],["LOCK","`","POW","OPEN_APPLE","&nbsp;","CLOSED_APPLE","&larr;","&rarr;","&darr;","&uarr;"]],[["ESC","!","@","#","$","%","^","&","*","(",")","_","+","DELETE"],["TAB","Q","W","E","R","T","Y","U","I","O","P","{","}","|"],["CTRL","A","S","D","F","G","H","J","K","L",":","'","RETURN"],["SHIFT","Z","X","C","V","B","N","M","<",">","?","SHIFT"],["CAPS","~","POW","OPEN_APPLE","&nbsp;","CLOSED_APPLE","&larr;","&rarr;","&darr;","&uarr;"]]];class et{constructor(t,e,s){this.cpu=t,this.io=e,this.e=s,this.shifted=!1,this.controlled=!1,this.capslocked=!0,this.capslockKeyUsed=!1,this.optioned=!1,this.commanded=!1,this.functions={},this.keydown=t=>{if(!this.dialogOpen()&&(!t.metaKey||t.ctrlKey||this.e)){t.preventDefault();const e=this.mapKeyEvent(t);if(255!==e)return void this.io.keyDown(e)}"Shift"===t.key?this.shiftKey(!0):"CapsLock"===t.key?this.capslockKey():"Control"===t.key?this.controlKey(!0):"Meta"===t.key?this.commandKey(!0):"Alt"===t.key?1===t.location?this.commandKey(!0):this.optionKey(!0):t.key in this.functions&&(this.functions[t.key](t),t.preventDefault())},this.keyup=t=>{this.dialogOpen()||this.io.keyUp(),"Shift"===t.key?this.shiftKey(!1):"Control"===t.key?this.controlKey(!1):"Meta"===t.key?this.commandKey(!1):"Alt"===t.key&&(1===t.location?this.commandKey(!1):this.optionKey(!1))},this.keys=s?tt:$,window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}setFunction(t,e){this.functions[t]=e}mapKeyEvent(t){const e=t.keyCode;let s=255;return t.key in J?s=J[t.key]:function(t){return t in Q}(e)?(s=Q[e][t.shiftKey?2:t.ctrlKey?1:0],20!==e&&this.capslockKeyUsed&&this.capslockKey(t.getModifierState("CapsLock")),this.capslocked&&s>=97&&s<=122&&(s-=32)):P("Unhandled key = "+C(e)),127===s&&t.shiftKey&&t.ctrlKey&&(this.cpu.reset(),s=255),s}shiftKey(t){const e=this.kb.querySelectorAll(".key-SHIFT");this.shifted=t,t?(this.io.buttonUp(2),e.forEach((t=>{t.classList.add("active")}))):(this.io.buttonDown(2),e.forEach((t=>{t.classList.remove("active")})))}controlKey(t){const e=this.kb.querySelector(".key-CTRL");this.controlled=t,t?e.classList.add("active"):e.classList.remove("active")}commandKey(t){const e=this.kb.querySelector(".key-OPEN_APPLE");e&&(this.commanded=t,t?(this.io.buttonDown(0),e.classList.add("active")):(this.io.buttonUp(0),e.classList.remove("active")))}optionKey(t){const e=this.kb.querySelector(".key-CLOSED_APPLE");e&&(this.optioned=t,t?(this.io.buttonDown(1),e.classList.add("active")):(this.io.buttonUp(1),e.classList.remove("active")))}capslockKey(t){const e=this.kb.querySelector(".key-LOCK");0===arguments.length?this.capslockKeyUsed?this.capslocked=!this.capslocked:this.capslockKeyUsed=!0:void 0===t?(this.capslocked=!this.capslocked,this.capslockKeyUsed=!1):this.capslocked=t,this.capslocked?e.classList.add("active"):e.classList.remove("active")}reset(t){t.preventDefault(),t.stopPropagation(),this.cpu.reset()}create(t){let e,s,i,r,a,n,o;this.kb=document.querySelector(t);const h=t=>{const e=document.createElement("span");return e.innerHTML=t,t.length>1&&"&"!==t.slice(0,1)&&e.classList.add("small"),e};for(s=0;s<5;s++)for(i=document.createElement("div"),i.classList.add("row"),i.classList.add(`row${s}`),this.kb.append(i),e=0;e<this.keys[0][s].length;e++){const t=this.keys[0][s][e],d=this.keys[1][s][e];a=document.createElement("div"),n=h(t),o=h(d),r=document.createElement("div"),r.classList.add("key"),r.classList.add("key-"+t.replace(/[&#;]/g,"")),t.length>1&&("LOCK"===t?r.classList.add("v-center2"):r.classList.add("v-center")),t!==d&&(r.classList.add("key-"+d.replace(/[&;]/g,"")),a.append(o),a.append(document.createElement("br"))),"LOCK"===t&&r.classList.add("active"),a.append(n),r.append(a),r.dataset.key1=t,r.dataset.key2=d;const c=this.genMouseDown(r,t,d),l=this.genMouseUp(r);void 0===window.ontouchstart?(r.addEventListener("mousedown",c),r.addEventListener("mouseup",l),r.addEventListener("mouseleave",l)):(r.addEventListener("touchstart",c),r.addEventListener("touchend",l),r.addEventListener("touchleave",l)),i.append(r)}}genMouseDown(t,e,s){return i=>{i.preventDefault(),t.classList.add("pressed");let r=this.shifted?s:e;switch(r){case"BELL":r="G";break;case"RETURN":r="\r";break;case"TAB":r="\t";break;case"DELETE":r="";break;case"&larr;":r="\b";break;case"&rarr;":r="";break;case"&darr;":r="\n";break;case"&uarr;":r="\v";break;case"&nbsp;":r=" ";break;case"ESC":r=""}if(r.length>1)switch(r){case"SHIFT":this.shiftKey(!this.shifted);break;case"CTRL":this.controlKey(!this.controlled);break;case"CAPS":case"LOCK":this.capslockKey(void 0);break;case"POW":case"POWER":window.confirm("Power Cycle?")&&window.location.reload();break;case"RESET":this.cpu.reset();break;case"OPEN_APPLE":this.commandKey(!this.commanded);break;case"CLOSED_APPLE":this.optionKey(!this.optioned)}else this.controlled&&r>="@"&&r<="_"?this.io.keyDown(r.charCodeAt(0)-64):this.e&&!this.shifted&&!this.capslocked&&r>="A"&&r<="Z"?this.io.keyDown(r.charCodeAt(0)+32):this.io.keyDown(r.charCodeAt(0))}}dialogOpen(){return!!document.querySelector(".modal.is-open")}genMouseUp(t){return()=>t.classList.remove("pressed")}}const st=["wav","aiff","aif","mp3","m4a"];class it{constructor(t){this.io=t}doLoadLocalTape(t,e){const s=this.io.getKHz();let i;if(!AudioContext)return window.alert("Not supported by your browser"),void(e&&e());i=new AudioContext;const r=new FileReader;r.onload=t=>{const r=t.target.result;i.decodeAudioData(r).then((t=>{const i=[],r=t.getChannelData(0);let a,n,o=r[0],h=o>0,d=0;P(`Sample Count: ${r.length}`),P(`Sample rate: ${t.sampleRate}`);for(let e=1;e<r.length;e++)if(o=r[e],(o>.1||o<-.1)&&(a=o>0,a!==h)){n=e-d,n>2e6&&(n=2e6);let r=n/t.sampleRate*1e3;r>=.55&&r<.75?r=.65:r>=.175&&r<.225?r=.2:r>=.225&&r<.275?r=.25:r>=.45&&r<.55&&(r=.5),i.push([r*s,a]),h=a,d=e}this.io.setTape(i),e&&e()}),(t=>{window.alert(t.message)}))},r.readAsArrayBuffer(t)}}const rt={128:"END",129:"FOR",130:"NEXT",131:"DATA",132:"INPUT",133:"DEL",134:"DIM",135:"READ",136:"GR",137:"TEXT",138:"PR#",139:"IN#",140:"CALL",141:"PLOT",142:"HLIN",143:"VLIN",144:"HGR2",145:"HGR",146:"HCOLOR=",147:"HPLOT",148:"DRAW",149:"XDRAW",150:"HTAB",151:"HOME",152:"ROT=",153:"SCALE=",154:"SHLOAD",155:"TRACE",156:"NOTRACE",157:"NORMAL",158:"INVERSE",159:"FLASH",160:"COLOR=",161:"POP=",162:"VTAB",163:"HIMEM:",164:"LOMEM:",165:"ONERR",166:"RESUME",167:"RECALL",168:"STORE",169:"SPEED=",170:"LET",171:"GOTO",172:"RUN",173:"IF",174:"RESTORE",175:"&",176:"GOSUB",177:"RETURN",178:"REM",179:"STOP",180:"ON",181:"WAIT",182:"LOAD",183:"SAVE",184:"DEF",185:"POKE",186:"PRINT",187:"CONT",188:"LIST",189:"CLEAR",190:"GET",191:"NEW",192:"TAB(",193:"TO",194:"FN",195:"SPC(",196:"THEN",197:"AT",198:"NOT",199:"STEP",200:"+",201:"-",202:"*",203:"/",204:"^",205:"AND",206:"OR",207:">",208:"=",209:"<",210:"SGN",211:"INT",212:"ABS",213:"USR",214:"FRE",215:"SCRN(",216:"PDL",217:"POS",218:"SQR",219:"RND",220:"LOG",221:"EXP",222:"COS",223:"SIN",224:"TAN",225:"ATN",226:"PEEK",227:"LEN",228:"STR$",229:"VAL",230:"ASC",231:"CHR$",232:"LEFT$",233:"RIGHT$",234:"MID$"},at={END:128,FOR:129,NEXT:130,DATA:131,INPUT:132,DEL:133,DIM:134,READ:135,GR:136,TEXT:137,"PR#":138,"IN#":139,CALL:140,PLOT:141,HLIN:142,VLIN:143,HGR2:144,HGR:145,"HCOLOR=":146,HPLOT:147,DRAW:148,XDRAW:149,HTAB:150,HOME:151,"ROT=":152,"SCALE=":153,SHLOAD:154,TRACE:155,NOTRACE:156,NORMAL:157,INVERSE:158,FLASH:159,"COLOR=":160,"POP=":161,VTAB:162,"HIMEM:":163,"LOMEM:":164,ONERR:165,RESUME:166,RECALL:167,STORE:168,"SPEED=":169,LET:170,GOTO:171,RUN:172,IF:173,RESTORE:174,"&":175,GOSUB:176,RETURN:177,REM:178,STOP:179,ON:180,WAIT:181,LOAD:182,SAVE:183,DEF:184,POKE:185,PRINT:186,CONT:187,LIST:188,CLEAR:189,GET:190,NEW:191,"TAB(":192,TO:193,FN:194,"SPC(":195,THEN:196,AT:197,NOT:198,STEP:199,"+":200,"-":201,"*":202,"/":203,"^":204,AND:205,OR:206,">":207,"=":208,"<":209,SGN:210,INT:211,ABS:212,USR:213,FRE:214,"SCRN(":215,PDL:216,POS:217,SQR:218,RND:219,LOG:220,EXP:221,COS:222,SIN:223,TAN:224,ATN:225,PEEK:226,LEN:227,STR$:228,VAL:229,ASC:230,CHR$:231,LEFT$:232,RIGHT$:233,MID$:234},nt=103,ot="                                 !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~ ",ht=t=>{let e;return e=t>=128&&t<=234?rt[t]:void 0!==ot[t]?ot[t]:`[${C(t)}]`,e},dt={apple2:"e",columns:40},ct={style:"pretty"};class lt{static decompilerFromMemory(t){const e=[],s=t.read(0,nt)+(t.read(0,nt+1)<<8),i=t.read(0,175)+(t.read(0,176)<<8);if(s>=49152||i>=49152)throw new Error(`Program memory ${C(s,4)}-${C(i,4)} out of range`);for(let r=s;r<=i;r++)e.push(t.read(r>>8,255&r));return new lt(new Uint8Array(e),s)}constructor(t,e=2049){if(this.program=t,this.base=e,0===this.base){const e=this.wordAt(0);let s=4;for(;t[s];)s++;s++,this.base=e-s}}wordAt(t){return this.program[t]+(this.program[t+1]<<8)}forEachLine(t,e,s){let i=0,r=0,a=this.wordAt(r),n=this.wordAt(r+2);for(;0!==a&&n<t;){if(++i>32768)throw new Error("Loop detected in listing");r=a,a=this.wordAt(r),n=this.wordAt(r+2)}for(;0!==a&&n<=e;){if(++i>32768)throw new Error("Loop detected in listing");s(r+2),r=a-this.base,a=this.wordAt(r),n=this.wordAt(r+2)}}listLine(t,e){const s=[];let i="";const r=this.wordAt(t);for("e"===e.apple2&&(i+=" "),i+=`${r} `,t+=2;0!==this.program[t];){if(t>=this.program.length){s.unshift("Unterminated line: ");break}const r=this.program[t];r>=128&&r<=234?(i+=" ",i+=ht(r),i+=" "):i+=ht(r),t++,i.length>=e.columns-7&&(i+="\n",s.push(i),i="     ")}return s.push(i+"\n"),s.join("")}list(t={},e=0,s=65536){const i=Object.assign(Object.assign({},dt),t);let r="";return this.forEachLine(e,s,(t=>{r+=this.listLine(t,i)})),r}compactLine(t){let e="",s=()=>!1;for(e+=this.wordAt(t),s=t=>/^\d/.test(t),t+=2;0!==this.program[t];){if(t>=this.program.length)return"Unterminated line: "+e;const i=this.program[t];let r=ht(i);"PRINT"===r&&(r="?"),s(r)&&(e+=" "),e+=r,s=()=>!1,i===at.AT&&(s=t=>t.toUpperCase().startsWith("N")),t++}return e}prettyLine(t){let e="",s=!1,i=()=>!1;for(e+=`${this.wordAt(t)} `,t+=2;0!==this.program[t];){if(t>=this.program.length)return"Unterminated line: "+e;const r=this.program[t],a=ht(r);'"'===a&&(s=!s),(i(r)||!s&&":"===a)&&(e+=" "),e+=a,i=!s&&":"===a||!s&&","===a?()=>!0:r>=207&&r<=209?t=>t<207||t>209:r>128&&r<234?t=>40!==t:t=>t>=128&&t<=234,t++}return e}decompile(t={},e=0,s=65536){const i=Object.assign(Object.assign({},ct),t),r=[];return this.forEachLine(e,s,(t=>{r.push("compact"===i.style?this.compactLine(t):this.prettyLine(t))})),r.join("\n")}}var mt;function ut(t,e,s){const i=e>>8,r=255&e;return t.write(i,r,s)}function ft(t,e,s){const i=s>>8;ut(t,e,255&s),ut(t,e+1,i)}!function(t){t[t.NORMAL=0]="NORMAL",t[t.STRING=1]="STRING",t[t.COMMENT=2]="COMMENT",t[t.DATA=3]="DATA",t[t.DATA_QUOTE=4]="DATA_QUOTE"}(mt||(mt={}));class gt{constructor(t,e=0){this.line=t,this.curChar=e,this.prevChar=0}[Symbol.iterator](){return this}clone(){return new gt(this.line,this.curChar)}next(){return this.atEnd()?{done:!0,value:void 0}:(this.prevChar=this.curChar,{done:!1,value:this.line[this.curChar++]})}lookingAtToken(t){const e=this.curChar,s=this.prevChar;let i="";for(const e of this)if(" "!==e&&(i+=e,i.length===t.length))break;return i.toUpperCase()===t?(this.prevChar=e,!0):(this.curChar=e,this.prevChar=s,!1)}backup(){this.curChar=this.prevChar}peek(){if(this.atEnd())throw new RangeError(`Reading past the end of ${this.line}`);return this.line[this.curChar]}atEnd(){return this.curChar>=this.line.length}}class pt{constructor(){this.lines=new Map}static compileToMemory(t,e,s=2049){const i=new pt;i.compile(e);const r=i.program(s);for(let e=0;e<r.byteLength;e++)ut(t,s+e,r[e]);const a=s+r.byteLength+1;ft(t,nt,s),ft(t,175,a),ft(t,105,a),ft(t,107,a),ft(t,109,a)}readLineNumber(t){let e="";for(const s of t){if(!/\d/.test(s)){t.backup();break}e+=s}if(0===e.length)throw new Error("Missing line number");return parseInt(e,10)}readToken(t){var e,s,i,r;for(const i in at)if(t.lookingAtToken(i)){if("AT"===i&&!t.atEnd()){const i=t.peek();if("N"===i)return t.next(),at.ATN;if("O"===i)return t.backup(),null!==(s=null===(e=t.next().value)||void 0===e?void 0:e.charCodeAt(0))&&void 0!==s?s:0}return at[i]}return null!==(r=null===(i=t.next().value)||void 0===i?void 0:i.toUpperCase().charCodeAt(0))&&void 0!==r?r:0}compileLine(t){const e=[];if(!t)return;const s=new gt(t);let i=mt.NORMAL;const r=this.readLineNumber(s);if(r<0||r>65535)throw new Error("Line number out of range");for(const t of s){const r=t.charCodeAt(0);switch(i){case mt.NORMAL:if(" "===t)break;if('"'===t){e.push(r),i=mt.STRING;break}if("?"===t){e.push(at.PRINT);break}s.backup();{const t=this.readToken(s);t===at.REM&&(i=mt.COMMENT),t===at.DATA&&(i=mt.DATA),e.push(t)}break;case mt.COMMENT:e.push(t.charCodeAt(0));break;case mt.STRING:'"'===t&&(i=mt.NORMAL),e.push(t.charCodeAt(0));break;case mt.DATA:":"===t&&(i=mt.NORMAL),'"'===t&&(i=mt.DATA_QUOTE),e.push(t.charCodeAt(0));break;case mt.DATA_QUOTE:'"'===t&&(i=mt.DATA),e.push(t.charCodeAt(0))}}this.lines.set(r,e)}compile(t){const e=t.split(/[\r\n]+/g);for(;e.length;){const t=e.shift();this.compileLine(t)}}program(t=2049){const e=[],s=[...this.lines.keys()].sort();for(const i of s){const s=this.lines.get(i)||[],r=t+e.length+4+s.length+1;e.push(255&r,r>>8),e.push(255&i,i>>8),e.push(...s),e.push(0)}return e.push(0,0),new Uint8Array(e)}}const At="mono_screen",bt="full_page",_t="show_scanlines";class wt{constructor(t){this.vm=t,this.enterFullScreen=()=>{const t=document.getElementById("screen");document.fullscreenEnabled?document.fullscreenElement?document.exitFullscreen():t.requestFullscreen():t.webkitRequestFullScreen&&(document.webkitIsFullScreen?document.webkitCancelFullScreen():t.webkitRequestFullScreen())}}getOptions(){return[{name:"Screen",options:[{name:At,label:"Mono Screen",type:w,defaultVal:!1},{name:_t,label:"Show Scanlines",type:w,defaultVal:!1},{name:"gl_canvas",label:"GL Renderer *",type:w,defaultVal:!0}]}]}setOption(t,e){switch(t){case At:this.vm.mono(e);break;case bt:this.setFullPage(e);break;case _t:this.vm.scanlines(e)}}setFullPage(t){t?document.body.classList.add("full-page"):document.body.classList.remove("full-page")}}const yt="accelerator_toggle";class St{constructor(t,e){this.io=t,this.e=e}getOptions(){return[{name:"Emulator type",options:this.e?[{name:"computer_type2e",label:" *",type:y,defaultVal:"apple2enh",values:[{value:"apple2enh",name:"Enhanced Apple //e"},{value:"apple2e",name:"Apple //e"},{value:"apple2rm",name:"Enhanced Apple //e (Reactive Micro)"},{value:"apple2ex",name:"Apple //e Extended Debugging"}]}]:[{name:"computer_type2",label:" *",type:y,defaultVal:"apple2plus",values:[{value:"apple2plus",name:"Apple ][+"}]}]},{name:"CPU",options:[{name:yt,label:"Accelerated",type:w,defaultVal:!1}]}]}setOption(t,e){if(t===yt){const t=e?4092:1023;this.io.updateKHz(t)}}}let Et=!1,Rt=Date.now(),Tt=0,vt=0,Pt=0,Ct=document.location.hash,It=[];const Ot=new class{constructor(){this.prefs=new s,this.options={},this.handlers={},this.sections=[]}addOptions(t){const e=t.getOptions();for(const s of e){const{options:e}=s;for(const s of e){const{name:e}=s;this.handlers[e]=t,this.options[e]=s;const i=this.getOption(e);null!=i&&t.setOption(e,i)}this.sections.push(s)}}getOption(t){const e=this.options[t];if(e){const{name:t,defaultVal:s,type:i}=e,r=String(s),a=this.prefs.readPref(t,r);return i===w?"true"===a:a}}setOption(t,e){if(t in this.options){const s=this.handlers[t],i=this.options[t];this.prefs.writePref(t,String(e)),i.type===w?s.setOption(t,Boolean(e)):s.setOption(t,String(e))}}getOptions(){return this.options}getSections(){return this.sections}},kt=new class{constructor(t){this.options=t,this.openModal=()=>{const t=document.querySelector("#options-modal-content");if(t){t.innerHTML="";for(const e of this.options.getSections()){const{name:s,options:i}=e,r=document.createElement("h3");r.textContent=s,t.appendChild(r);const a=document.createElement("ul");for(const t of i){const{name:e,label:s,type:i}=t,r=t=>{const{target:s}=t;i===w?this.options.setOption(e,s.checked):this.options.setOption(e,s.value)},n=document.createElement("li");let o;switch(i){case w:{const t=document.createElement("input"),s=this.options.getOption(e);t.setAttribute("type","checkbox"),t.checked=s,o=t}break;case y:{const s=t,i=document.createElement("select"),r=this.options.getOption(e);for(const t of s.values){const e=document.createElement("option");e.value=t.value,e.textContent=t.name,e.selected=t.value===r,i.appendChild(e)}o=i}break;default:{const t=document.createElement("input"),s=this.options.getOption(e);t.value=s,o=t}}o.id=e,o.addEventListener("change",r),n.appendChild(o);const h=document.createElement("label");h.textContent=s,h.setAttribute("for",e),n.appendChild(h),a.appendChild(n)}t.appendChild(a)}const e=document.createElement("i");e.textContent="* Reload page to take effect",t.append(e)}else console.error("Cannot find target div#options-modal-content");f.show("options-modal")}}}(Ot),Mt=/#([0-9a-f]{2})([0-9a-f]{4})$/i,Dt=["bin"],Lt=[...z,...st,...Dt],Nt=.9,xt={"Local Saves":[]},Bt={},Ft=[],Ut=[];let Xt,zt,Ht,Gt,Zt,Yt,Wt,Kt,jt,qt,Vt,Qt,Jt,$t,te,ee=1;const se=new class{driveLight(t,e){const s=document.querySelector(`#disk${t}`);s&&(s.style.backgroundImage=e?"url(css/red-on-16.png)":"url(css/red-off-16.png)")}dirty(t,e){}label(t,e,s){const i=document.querySelector(`#disk-label${t}`);let r="";return i&&(r=i.innerText,e&&(r=`${e||""} ${s?`- ${s}`:""}`,i.innerText=r)),r}};function ie(){P(lt.decompilerFromMemory(zt).list({apple2:$t?"e":"plus"}))}function re(t){const e=zt.read(nt)+(zt.read(nt+1)<<8);pt.compileToMemory(zt,t,e),ie()}function ae(t,e){ee=parseInt(t,10),e.metaKey&&M(D,ee)?f.show("http-modal"):(Ut[ee]&&(document.querySelector("#category_select").value=Ut[ee],ve()),f.show("load-modal"))}function ne(t,e){const s=parseInt(t,10),i=Yt.getBinary(s),r=document.querySelector("#local_save_link");if(!i)return void alert(`No data from drive ${s}`);const{data:a}=i,n=new Blob([a],{type:"application/octet-stream"});r.href=window.URL.createObjectURL(n),r.download=se.label(s)+".dsk",e.metaKey?function(t){const e=window.open("","_blank");e.document.title=se.label(t),e.document.write("<pre>"),e.document.write(Yt.getJSON(t,!0)),e.document.write("</pre>"),e.document.close()}(s):(document.querySelector("#save_name").value=se.label(s),f.show("save-modal"))}function oe(t){document.querySelector("#alert-modal .message").innerText=t,f.show("alert-modal")}function he(t){var e,s,i;console.log("Opening image at",t);const r=`images/thumbs/${t}`,a=r.replace("thumbs/",""),n=null===(e=document.querySelector(`figure.thumbnail-figure img[src='${r}']`))||void 0===e?void 0:e.parentElement,o=(null===(s=null==n?void 0:n.querySelector("img"))||void 0===s?void 0:s.getAttribute("alt"))||"",h=(null===(i=null==n?void 0:n.querySelector("figcaption"))||void 0===i?void 0:i.textContent)||"Image";document.querySelector("#image-modal .modal__title").innerText=h;const d=document.querySelector("#image-modal .modal-image-fullsize");d.alt=h,d.src=a,document.querySelector("#image-modal .modal-image-caption").innerText=o,f.show("image-modal")}function de(t,e){e.preventDefault(),e.dataTransfer.dropEffect="copy"}function ce(t,e){const s=e.dataTransfer;if(s.items)for(let t=0;t<s.items.length;t++)s.items.remove(t);else s.clearData()}function le(t,e){e.preventDefault(),e.stopPropagation(),t<1&&(t=Yt.getMetadata(1)?Yt.getMetadata(2)?1:2:1);const s=e.dataTransfer;if(1===s.files.length){const i=e.shiftKey;be(t,s.files[0],{runOnLoad:i})}else if(2===s.files.length)be(1,s.files[0]),be(2,s.files[1]);else for(let e=0;e<s.items.length;e++)"text/uri-list"===s.items[e].type&&s.items[e].getAsString((function(e){const s=Be().split("|");s[t-1]=e,document.location.hash=s.join("|")}))}function me(){document.querySelector("#loading-modal .meter").style.display="none",f.show("loading-modal")}function ue(){f.close("loading-modal"),Et||te.then((()=>{Xt.run()})).catch(console.error)}function fe(t,e){me(),fetch(e).then((function(t){if(t.ok)return t.json();throw new Error("Error loading: "+t.statusText)})).then((function(e){"binary"===e.type?function(t){const e=Math.min(t.length,65536-t.start);for(let s=0;s<e;s++){const e=t.start+s;zt.write(e,t.data[s])}zt.reset(),zt.setPC(t.start)}(e):M(z,e.type)&&function(t,e){let s=e.name;const i=e.category;e.disk&&(s+=" - "+e.disk),Ut[t]=i,Ft[t]=s,Yt.setDisk(t,e),V(e.gamepad)}(t,e),V(e.gamepad),ue()})).catch((function(t){ue(),oe(t.message),console.error(t)}))}function ge(t){f.close("load-modal");const e=document.querySelector("#disk_select").value;let s;e&&e.length&&(s="string"==typeof e?e:e[0]);const i=document.querySelector("#local_file").files;if(i&&1===i.length){const e=t.shiftKey;be(ee,i[0],{runOnLoad:e})}else if(s){let t;if(f.close("load-modal"),"local:"===s.slice(0,6))t=s.slice(6),"__manage"===t?f.show("manage-modal"):function(t,e){const s=JSON.parse(window.localStorage.getItem("diskIndex")||"{}");s[e]&&(Yt.setJSON(t,s[e]),se.label(t,e),se.dirty(t,!1))}(ee,t);else{const e=/json\/disks\/(.*).json$/.exec(s);t=e?e[1]:s;const i=Be().split("|");i[ee-1]=t,document.location.hash=i.join("|")}}}function pe(){const t=document.querySelector("#save_name").value;!function(t,e){const s=JSON.parse(window.localStorage.getItem("diskIndex")||"{}"),i=Yt.getJSON(t);s[e]=i,window.localStorage.setItem("diskIndex",JSON.stringify(s)),se.label(t,e),se.dirty(t,!1),Ie()}(ee,t),f.close("save-modal"),window.setTimeout((()=>oe("Saved")),0)}function Ae(t){window.confirm("Delete "+t+"?")&&function(t){const e=JSON.parse(window.localStorage.getItem("diskIndex")||"{}");e[t]&&(delete e[t],oe("Deleted")),window.localStorage.setItem("diskIndex",JSON.stringify(e)),Ie()}(t)}function be(t,e,s={}){const i=e.name.split("."),r=i[i.length-1].toLowerCase(),a=e.name.match(Mt);let n,o;if(a&&3===a.length&&([,n,o]=a),M(z,r))!function(t,e){me();const s=new FileReader;s.onload=function(){const s=this.result,i=e.name.split("."),r=i.pop().toLowerCase(),a=i.join("."),n=Be().split("|");n[t-1]="",document.location.hash=n.join("|"),M(z,r)&&(s.byteLength>=819200?M(X,r)&&Wt.setBinary(t,a,r,s)?V():oe(`Unable to load ${a}`):M(U,r)&&Yt.setBinary(t,a,r,s)?V():oe(`Unable to load ${a}`)),ue()},s.readAsArrayBuffer(e)}(t,e);else if(M(st,r))Zt.doLoadLocalTape(e);else if(Dt.includes(r)||"06"===n||s.address){const t=void 0!==o?{address:parseInt(o,16)}:{};_e(e,Object.assign(Object.assign({},s),t))}else{const t=document.querySelector("#local_file_address"),i=null==t?void 0:t.value;if(i){const t=parseInt(i,16);if(isNaN(t))return void oe("Invalid address: "+i);_e(e,Object.assign({address:t},s))}else oe("Unknown file type: "+r)}}function _e(t,e){me();const s=new FileReader;s.onload=function(){const t=this.result;let{address:s}=e;s=null!=s?s:8192;const i=new Uint8Array(t);for(let e=0;e<t.byteLength;e++)zt.write(s>>8,255&s,i[e]),s++;e.runOnLoad&&(zt.reset(),zt.setPC(s)),ue()},s.readAsArrayBuffer(t)}function we(t,e){e||f.close("http-modal"),me();const s=document.querySelector("#http_url");(e=e||s.value)&&fetch(e).then((function(t){if(t.ok){const e=t.body.getReader();let s=0;const i=[],r=parseInt(t.headers.get("content-length"),10);return e.read().then((function t(a){if(a.done){const t=new Uint8Array(s);let e=0;for(let s=0;s<i.length;s++)t.set(i[s],e),e+=i[s].length;return Promise.resolve(t.buffer)}return s+=a.value.length,r&&function(t,e){if(e){const s=document.querySelector("#loading-modal .meter"),i=document.querySelector("#loading-modal .progress");s.style.display="block",i.style.width=t/e*s.clientWidth+"px"}}(s,r),i.push(a.value),e.read().then(t)}))}throw new Error("Error loading: "+t.statusText)})).then((function(s){const i=e.split("/").pop().split("."),r=i.pop().toLowerCase(),a=decodeURIComponent(i.join("."));if(!M(z,r))throw new Error(`Extension ${r} not recognized.`);s.byteLength>=819200?M(X,r)&&(Wt.setBinary(t,a,r,s),V()):M(U,r)&&Yt.setBinary(t,a,r,s)&&V(),ue()})).catch((t=>{ue(),oe(t.message),console.error(t)}))}let ye=0;function Se(){const t=Date.now(),e=t-Rt,s=zt.getCycles();let i,r,a;const n=document.querySelector("#khz");switch(ye){case 0:i=s-Tt,a=Math.trunc(i/e),n.innerText=`${a} kHz`;break;case 1:i=Ht.renderedFrames-Pt,r=Math.trunc(i/(e/1e3)),n.innerText=`${r} rps`;break;default:i=Ht.frames-vt,r=Math.trunc(i/(e/1e3)),n.innerText=`${r} fps`}Rt=t,Tt=s,Pt=Ht.renderedFrames,vt=Ht.frames}function Ee(){ye=++ye%3}function Re(){const t=!jt.isEnabled();Ot.setOption(I,t)}function Te(){Xt.reset()}function ve(){const t=document.querySelector("#disk_select"),e=document.querySelector("#category_select");t.innerHTML="";const s=xt[e.value];if(s)for(let e=0;e<s.length;e++){const i=s[e];let r=i.name;i.disk&&(r+=` - ${i.disk}`);const a=document.createElement("option");a.value=i.filename,a.innerText=r,t.append(a),Ft[ee]===r&&(a.selected=!0)}}function Pe(){document.querySelector("#local_file").value=""}function Ce(t){ge(t)}function Ie(){const t=JSON.parse(window.localStorage.getItem("diskIndex")||"{}"),e=Object.keys(t),s=xt["Local Saves"]=[],i=document.querySelector("#manage-modal-content");i.innerHTML="",e.forEach((function(t){s.push({category:"Local Saves",name:t,filename:"local:"+t}),i.innerHTML='<span class="local_save">'+t+' <a href="#" onclick="Apple2.doDelete(\''+t+"')\">Delete</a><br /></span>"})),s.push({category:"Local Saves",name:"Manage Saves...",filename:"local:__manage"})}void 0!==window.localStorage&&document.querySelectorAll(".disksave").forEach((function(t){t.style.display="inline-block"}));const Oe=document.querySelector("#category_select");function ke(t){const e=t.split("|");for(let t=0;t<Math.min(2,e.length);t++){const s=t+1;if(!M(D,s))break;const i=e[t];if(i!==It[t])if(i.indexOf("://")>0){const t=i.split(".");"json"===t[t.length-1].toLowerCase()?fe(s,i):we(s,i)}else i&&fe(s,"json/disks/"+i+".json")}It=e}function Me(){if(document.location.hash!==Ct){Ct=document.location.hash;const t=Be();t&&ke(t)}}function De(){const t=document.querySelector("#pause-run i");Et?(te.then((()=>{Xt.run()})).catch(console.error),t.classList.remove("fa-play"),t.classList.add("fa-pause")):(Xt.stop(),t.classList.remove("fa-pause"),t.classList.add("fa-play")),Et=!Et}function Le(){kt.openModal()}function Ne(){const t=Kt.getRawOutput(),e=document.querySelector("#raw_printer_output"),s=new Blob([t],{type:"application/octet-stream"});e.href=window.URL.createObjectURL(s),e.download="raw_printer_output.bin",f.show("printer-modal")}function xe(){Kt.clear()}function Be(){const t=new RegExp("#(.*)"),e=decodeURIComponent(window.location.hash),s=t.exec(e);return s?s[1]:""}function Fe(){const t=document.querySelector("#emulator");if(t){const e=Math.min(window.innerHeight*Nt,t.clientHeight),s=e/t.clientHeight;t.style.setProperty("--scale",`${s}`);const i=e-t.clientHeight;t.style.setProperty("margin-bottom",`${i}px`)}}function Ue(t,e,s,i,r){window.addEventListener("load",(()=>{!function(t,e,s,i,r){var a;Xt=t,zt=Xt.getCPU(),Jt=Xt.getIO(),Ht=t.getStats(),Gt=t.getVideoModes(),Zt=new it(Jt),Yt=e,Wt=s,Kt=i,$t=r,Vt=new St(Jt,r),Ot.addOptions(Vt),qt=new wt(Gt),Ot.addOptions(qt),jt=new k(Jt),Ot.addOptions(jt),te=Promise.all([jt.ready,t.ready]),f.init(),Qt=new et(zt,Jt,r),Qt.create("#keyboard"),Qt.setFunction("F1",(()=>zt.reset())),Qt.setFunction("F2",(t=>{t.shiftKey?Ot.setOption(bt,!Ot.getOption(bt)):qt.enterFullScreen()})),Qt.setFunction("F3",(()=>Jt.keyDown(27))),Qt.setFunction("F4",kt.openModal),Qt.setFunction("F6",(()=>{var t;window.localStorage.setItem("state",(t=Xt.getState(),JSON.stringify(t,((t,e)=>e instanceof Uint8Array?b+p(e):e))))})),Qt.setFunction("F8",(()=>{const t=window.localStorage.getItem("state");if(t){const e="state.json";let s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),s.setAttribute("download",e),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}})),Qt.setFunction("F9",(()=>{const t=window.localStorage.getItem("state");t&&Xt.setState(_(t))})),function(){let t,e="";for(let s=0;s<window.disk_index.length;s++){const i=window.disk_index[s],r=i.category,a=i.name,n=i.disk;i.e&&!$t||(r!==e&&(t=document.createElement("option"),t.value=r,t.innerText=r,Oe.append(t),xt[r]=[],e=r),xt[r].push(i),n&&(Bt[a]||(Bt[a]=[]),Bt[a].push(i)))}t=document.createElement("option"),t.innerText="Local Saves",Oe.append(t),Ie()}();const n=document.querySelector("#screen"),o=t=>{const e=(t.clipboardData||window.clipboardData).getData("text");Jt.setKeyBuffer(e),t.preventDefault()},h=t=>{t.clipboardData.setData("text/plain",Gt.getText()),t.preventDefault()};window.addEventListener("paste",(t=>{document.activeElement&&document.activeElement!==document.body||o(t)})),window.addEventListener("copy",(t=>{document.activeElement&&document.activeElement!==document.body||h(t)})),n.addEventListener("copy",(t=>{h(t)})),n.addEventListener("paste",(t=>{o(t)})),navigator.standalone&&document.body.classList.add("standalone"),zt.reset();const d=new URLSearchParams(window.location.search).get("disk")||Be();d?(Xt.stop(),ke(d)):te.then((()=>{Xt.run()})).catch(console.error),null===(a=document.querySelector("#local_file"))||void 0===a||a.addEventListener("change",(t=>{const e=t.target,s=document.querySelector("#local_file_address_input"),i=e.value.split("."),r=i[i.length-1];Lt.includes(r)?s.style.display="none":s.style.display="inline-block"})),window.addEventListener("resize",(()=>{Fe()})),Fe()}(t,e,s,i,r)}))}class Xe{constructor(t){this._lineBuffer="",this._rawLen=0,this._raw=new Uint8Array(1024),this.paper=document.querySelector(t),this.newLine()}newLine(){this._line=document.createElement("div"),this._line.classList.add("line"),this._line.innerText=this._lineBuffer,this.paper.append(this._line),this._lineBuffer=""}putChar(t){const e=127&t,s=t>=32,i=String.fromCharCode(e);if("\r"===i?this.newLine():"\n"===i||("\t"===i?this._lineBuffer+="        ":4===e?this._lineBuffer=this._lineBuffer.slice(0,-1):s&&(this._lineBuffer+=i)),this._line.innerText=this._lineBuffer,this._raw[this._rawLen]=t,this._rawLen++,this._rawLen>this._raw.length){const t=new Uint8Array(2*this._raw.length);t.set(this._raw),this._raw=t}}clear(){this._lineBuffer="",this.paper.innerHTML="",this.newLine(),this._raw=new Uint8Array(1024),this._rawLen=0}hasPrintout(){return this.paper.innerText.length>0}getRawOutput(){return this._raw.slice(0,this._rawLen)}}let ze=!1;class He{constructor(t){this.canvas=t,this.setMouse=t=>{this.mouse=t},this.mouseMode=t=>{!function(t){ze=t}(t),t?this.canvas.classList.add("mouseMode"):this.canvas.classList.remove("mouseMode")};const e=t=>{const{targetTouches:e,target:s}=t;if(e.length<1)return;const i=s.getBoundingClientRect(),r=(i.width-560)/2+i.left,a=(i.height-384)/2+i.top,{clientX:n,clientY:o}=e[0],h=n-r,d=o-a;this.mouse.setMouseXY(Math.max(Math.min(h,559),0),Math.max(Math.min(d,383),0),560,384)};"ontouchstart"in window?(this.canvas.addEventListener("touchmove",(t=>{e(t)})),this.canvas.addEventListener("touchstart",(t=>{e(t),setTimeout((()=>this.mouse.setMouseDown(!0)),20)})),this.canvas.addEventListener("touchend",(t=>{e(t),setTimeout((()=>this.mouse.setMouseDown(!1)),20)})),this.canvas.addEventListener("touchcancel",(t=>{e(t),this.mouse.setMouseDown(!1)}))):(this.canvas.addEventListener("mousemove",(t=>{const{offsetX:e,offsetY:s,target:i}=t;this.mouse.setMouseXY(e,s,i.clientWidth,i.clientHeight)})),this.canvas.addEventListener("mousedown",(()=>{this.mouse.setMouseDown(!0)})),this.canvas.addEventListener("mouseup",(()=>{this.mouse.setMouseDown(!1)})))}}const Ge=[0,7,14,6,13,5,12,4,11,3,10,2,9,1,8,15],Ze=[0,13,11,9,7,5,3,1,14,12,10,8,6,4,2,15],Ye=[0,8,1,9,2,10,3,11,4,12,5,13,6,14,7,15],We=[0,2,4,6,8,10,12,14,1,3,5,7,9,11,13,15],Ke=[0,10,7,4,1,11,8,5,2,12,9,6,3],je=[0,1,2,3,4,5,6,7,8,9,10,11,12],qe=[171,173,174,175,181,182,183,186,187,189,190,191,214,215,218,219,221,222,223,234,235,237,238,239,245,246,247,250,251,253,254,255],Ve=[0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,0,0,0,0,0,4,5,6,0,0,7,8,0,9,10,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,13,0,0,14,15,0,16,17,18,0,0,0,0,0,0,0,0,0,0,19,20,0,21,22,23,0,0,0,0,0,24,25,26,0,0,27,28,0,29,30,31],Qe=[150,151,154,155,157,158,159,166,167,171,172,173,174,175,178,179,180,181,182,183,185,186,187,188,189,190,191,203,205,206,207,211,214,215,217,218,219,220,221,222,223,229,230,231,233,234,235,236,237,238,239,242,243,244,245,246,247,249,250,251,252,253,254,255],Je=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,3,0,4,5,6,0,0,0,0,0,0,7,8,0,0,0,9,10,11,12,13,0,0,14,15,16,17,18,19,0,20,21,22,23,24,25,26,0,0,0,0,0,0,0,0,0,0,0,27,0,28,29,30,0,0,0,31,0,0,32,33,0,34,35,36,37,38,39,40,0,0,0,0,0,41,42,43,0,44,45,46,47,48,49,50,0,0,51,52,53,54,55,56,0,57,58,59,60,61,62,63];function $e(t){let e=170&t,s=85&t;return e>>=1,e|=170,s|=170,[e,s]}function ts(t,e){return(t<<1|1)&e}function es(t,e,s,i){let r,a=[];r=0===s?128:0===e?40:38;for(let t=0;t<r;t++)a.push(255);const n=t^e^s;a=a.concat([213,170,150]),a=a.concat($e(t)),a=a.concat($e(e)),a=a.concat($e(s)),a=a.concat($e(n)),a=a.concat([222,170,235]);for(let t=0;t<5;t++)a.push(255);a=a.concat([213,170,173]);const o=[];for(let t=0;t<342;t++)o[t]=0;let h=85;for(let t=257;t>=0;t--){let e=i[t%256],s=o[0+h];s=s<<1|1&e,e>>=1,s=s<<1|1&e,e>>=1,o[86+t]=e,o[0+h]=s,--h<0&&(h=85)}let d=0;for(let t=0;t<342;t++){const e=o[t];a.push(Qe[d^e]),d=e}return a.push(Qe[d]),a=a.concat([222,170,235]),a.push(255),a}function ss(t,e,s,i){let r,a=[];r=0===s?128:0===e?40:38;for(let t=0;t<r;t++)a.push(255);const n=t^e^s;a=a.concat([213,170,181]),a=a.concat($e(t)),a=a.concat($e(e)),a=a.concat($e(s)),a=a.concat($e(n)),a=a.concat([222,170,235]);for(let t=0;t<5;t++)a.push(255);a=a.concat([213,170,173]);const o=[];let h=0;for(let t=50;t>=0;t--){const e=i[h]>>3,s=7&i[h];h++;const r=i[h]>>3,a=7&i[h];h++;const n=i[h]>>3,d=7&i[h];h++;const c=i[h]>>3,l=7&i[h];h++;const m=i[h]>>3,u=7&i[h];h++,o[t+0]=e,o[t+51]=r,o[t+102]=n,o[t+153]=c,o[t+204]=m,o[t+256]=s<<2|(4&l)>>1|(4&u)>>2,o[t+307]=a<<2|2&l|(2&u)>>1,o[t+358]=d<<2|(1&l)<<1|1&u}o[255]=i[h]>>3,o[409]=7&i[h];let d=0;for(let t=409;t>=256;t--){const e=o[t];a.push(qe[d^e]),d=e}for(let t=0;t<256;t++){const e=o[t];a.push(qe[d^e]),d=e}return a.push(qe[d]),a=a.concat([222,170,235]),a.push(255),a}var is;!function(t){t[t.START_OF_FIELD_MARKER_FIRST_NIBBLE=0]="START_OF_FIELD_MARKER_FIRST_NIBBLE",t[t.START_OF_FIELD_MARKER_SECOND_NIBBLE=1]="START_OF_FIELD_MARKER_SECOND_NIBBLE",t[t.FIELD_TYPE_MARKER=2]="FIELD_TYPE_MARKER",t[t.ADDRESS_FIELD=3]="ADDRESS_FIELD",t[t.ADDRESS_FIELD_13=4]="ADDRESS_FIELD_13",t[t.DATA_FIELD_6AND2=5]="DATA_FIELD_6AND2",t[t.DATA_FIELD_5AND3=6]="DATA_FIELD_5AND3"}(is||(is={}));class rs extends Error{constructor(t,e,s){super(`Error finding track ${t} (${C(t)}), sector ${e} (${C(e)}): `+(s instanceof Error?`${s.message}`:`${String(s)}`))}}class as extends Error{constructor(t,e){super(`Expected: ${C(t)}, received: ${C(e)}`)}}class ns extends Error{constructor(t,e,s){super(`Error reading track ${t} (${C(t)}), sector ${e} (${C(e)}): `+(s instanceof Error?`${s.message}`:`${String(s)}`))}}function os(t,e,s){const i=function(t,e,s){const i=t.tracks[e];let r=16,a=is.START_OF_FIELD_MARKER_FIRST_NIBBLE,n=0,o=0;function h(){const t=i[n++];return n>=i.length&&(n=0,o++),t}function d(t){n+=t,n>=i.length&&(n%=i.length,o++)}let c,l=0,m=0,u=0;for(;o<4;){let t;switch(a){case is.START_OF_FIELD_MARKER_FIRST_NIBBLE:t=h(),a=213===t?is.START_OF_FIELD_MARKER_SECOND_NIBBLE:is.START_OF_FIELD_MARKER_FIRST_NIBBLE;break;case is.START_OF_FIELD_MARKER_SECOND_NIBBLE:t=h(),a=170===t?is.FIELD_TYPE_MARKER:is.START_OF_FIELD_MARKER_FIRST_NIBBLE;break;case is.FIELD_TYPE_MARKER:switch(t=h(),t){case 150:a=is.ADDRESS_FIELD,r=16;break;case 181:a=is.ADDRESS_FIELD,r=13;break;case 173:a=16===r?is.DATA_FIELD_6AND2:is.DATA_FIELD_5AND3;break;default:a=is.START_OF_FIELD_MARKER_FIRST_NIBBLE}break;case is.ADDRESS_FIELD:u=ts(h(),h()),l=ts(h(),h()),m=ts(h(),h()),c=ts(h(),h()),c!==(u^l^m)&&P("Invalid header checksum:",C(u),C(l),C(m),C(c)),d(3),a=0;break;case is.DATA_FIELD_6AND2:if(m===s&&l===e){const t=n;let i=0;for(let t=0;t<342;t++)i=Je[h()-128]^i;const a=Je[h()-128]^i;if(!a)return{track:e,sector:s,nibble:t,sectors:r};P("Invalid data checksum:",C(i),C(e),C(s),C(a)),d(3)}else d(345);a=is.START_OF_FIELD_MARKER_FIRST_NIBBLE;break;case is.DATA_FIELD_5AND3:if(m===s&&l===e){const t=n;let i=0;for(let t=0;t<410;t++)i=Ve[h()-160]^i;const a=Ve[h()-160]^i;if(!a)return{track:e,sector:s,nibble:t,sectors:r};P("Invalid data checksum:",C(i),C(e),C(s),C(a)),d(3)}else d(410);a=is.START_OF_FIELD_MARKER_FIRST_NIBBLE;break;default:a=is.START_OF_FIELD_MARKER_FIRST_NIBBLE}}throw new rs(e,s,`too many retries (${o})`)}(t,e,s),{nibble:r,sectors:a}=i,n=t.tracks[e];let o=r;const h=()=>{const t=n[o++];return o>=n.length&&(o=0),t};try{return 13===a?function(t){const e=new Uint8Array(256);let s,i=0;s=Ve[t()-160]^i,i=s,e[255]=7&s;for(let r=152;r>=0;r--){s=Ve[t()-160]^i,i=s;const a=Math.floor(r/51)+5*(50-r%51),n=3+5*(50-r%51),o=4+5*(50-r%51),h=2-Math.floor(r/51);e[a]=(28&s)>>2,e[n]^=(2&s)>>1<<h,e[o]^=(1&s)<<h}for(let r=0;r<255;r++)s=Ve[t()-160]^i,i=s,e[Math.floor(r/51)+5*(50-r%51)]^=s<<3;s=Ve[t()-160]^i,i=s,e[255]^=s<<3;const r=Ve[t()-160]^i;if(r)throw new as(i,r^i);return e}(h):function(t){const e=new Uint8Array(256),s=[];let i,r=0;for(let e=85;e>=0;e--)i=Je[t()-128]^r,s[e]=i,r=i;for(let s=0;s<256;s++)i=Je[t()-128]^r,e[s]=i,r=i;const a=Je[t()-128]^r;if(a)throw new as(r,a^r);for(let t=0,i=85;t<256;t++)e[t]<<=1,0!=(1&s[i])&&(e[t]|=1),s[i]>>=1,e[t]<<=1,0!=(1&s[i])&&(e[t]|=1),s[i]>>=1,--i<0&&(i=85);return e}(h)}catch(t){throw new ns(e,s,t)}}function hs(t,e){let s=0,i=!0;for(;e<t.length&&(t[e]?(s=s<<1|1,i=!1):i||(s<<=1),!(128&s));)e+=1;return{nibble:s,offset:e}}function ds(t){const{data:e,name:s,side:i,rawData:r,volume:a,readOnly:n}=t,o={format:"dsk",encoding:N,metadata:{name:s,side:i},volume:a,readOnly:n,tracks:[]};for(let t=0;t<35;t++){let s=[];for(let i=0;i<16;i++){const n=Ge[i];let o;if(r){const e=256*(16*t+n);o=new Uint8Array(r.slice(e,e+256))}else{if(!e)throw new Error("Requires data or rawData");o=new Uint8Array(e[t][n])}s=s.concat(es(a,t,i,o))}o.tracks[t]=v(s)}return o}function cs(t){const{data:e,name:s,side:i,rawData:r,volume:a,readOnly:n}=t,o={format:"nib",encoding:N,metadata:{name:s,side:i},volume:a||254,readOnly:n||!1,tracks:[]};for(let t=0;t<35;t++){let s;if(r){const e=6656*t;s=new Uint8Array(r.slice(e,e+6656))}else{if(!e)throw new Error("Requires data or rawData");s=e[t][0]}o.tracks[t]=s}return o}function ls(t){const{data:e,name:s,side:i,rawData:r,volume:a,readOnly:n}=t,o={format:"po",encoding:N,metadata:{name:s,side:i},volume:a||254,tracks:[],readOnly:n||!1};for(let t=0;t<35;t++){let s=[];for(let i=0;i<16;i++){const n=Ye[i];let o;if(r){const e=256*(16*t+n);o=new Uint8Array(r.slice(e,e+256))}else{if(!e)throw new Error("Requires data or rawData");o=e[t][n]}s=s.concat(es(a,t,i,o))}o.tracks[t]=v(s)}return o}const ms={SIGNATURE:0,CREATOR:4,HEADER_LENGTH:8,VERSION:10,FORMAT:12,FLAGS:16,BLOCKS:20,DATA_OFFSET:24,DATA_LENGTH:28,COMMENT:32,COMMENT_LENGTH:36,CREATOR_DATA:40,CREATOR_DATA_LENGTH:44,PADDING:48},us={READ_ONLY:2147483648,VOLUME_VALID:256,VOLUME_MASK:255};var fs;function gs(t){const e=new DataView(t),s=new TextDecoder("ascii"),i=s.decode(t.slice(ms.SIGNATURE,ms.SIGNATURE+4));if("2IMG"!==i)throw new Error(`Unrecognized 2mg signature: ${i}`);const r=s.decode(t.slice(ms.CREATOR,ms.CREATOR+4)),a=e.getInt16(ms.HEADER_LENGTH,!0);if(64!==a)throw new Error(`2mg header length is incorrect ${a} !== 64`);const n=e.getInt32(ms.FORMAT,!0),o=e.getInt32(ms.FLAGS,!0),h=e.getInt32(ms.BLOCKS,!0),d=e.getInt32(ms.DATA_OFFSET,!0),c=e.getInt32(ms.DATA_LENGTH,!0),l=e.getInt32(ms.COMMENT,!0),m=e.getInt32(ms.COMMENT_LENGTH,!0),u=e.getInt32(ms.CREATOR_DATA,!0),f=e.getInt32(ms.CREATOR_DATA_LENGTH,!0);if(n===fs.ProDOS&&512*h!==c)throw new Error(`2mg blocks does not match disk data length: ${h} * 512 !== ${c}`);if(d<a)throw new Error(`2mg data offset is less than header length: ${d} < ${a}`);if(d+c>e.byteLength)throw new Error(`2mg data extends beyond disk image: ${d} + ${c} > ${e.byteLength}`);const g=d+c;if(l&&l<g)throw new Error(`2mg comment is before the end of the disk data: ${l} < ${d} + ${c}`);const p=l?l+m:g;if(p>e.byteLength)throw new Error(`2mg comment extends beyond disk image: ${p} > ${e.byteLength}`);if(u&&u<p)throw new Error(`2mg creator data is before the end of the comment: ${u} < ${p}`);const A=u?u+f:p;if(A>e.byteLength)throw new Error(`2mg creator data extends beyond disk image: ${A} > ${e.byteLength}`);const b={};l&&(b.comment=new TextDecoder("utf-8").decode(new Uint8Array(t,l,m))),u&&(b.creatorData=new Uint8Array(t,u,f));const _=0!=(o&us.READ_ONLY);let w=n===fs.DOS?254:0;return o&us.VOLUME_VALID&&(w=o&us.VOLUME_MASK),Object.assign({bytes:c,creator:r,format:n,offset:d,readOnly:_,volume:w},b)}!function(t){t[t.DOS=0]="DOS",t[t.ProDOS=1]="ProDOS",t[t.NIB=2]="NIB"}(fs||(fs={}));const ps=0,As=12,bs=828002135,_s=844779351,ws=168626943;function ys(t,e,s){const i=new Uint8Array(t.buffer.slice(t.byteOffset+e,t.byteOffset+s));return String.fromCharCode(...i)}class Ss{constructor(t){this.sides=0,this.bootSector=0,this.bitTiming=0,this.compatibleHardware=0,this.requiredRAM=0,this.largestTrack=0,this.version=t.getUint8(0),this.diskType=t.getUint8(1),this.writeProtected=t.getUint8(2),this.synchronized=t.getUint8(3),this.cleaned=t.getUint8(4),this.creator=ys(t,5,37),this.version>1&&(this.sides=t.getUint8(37),this.bootSector=t.getUint8(38),this.bitTiming=t.getUint8(39),this.compatibleHardware=t.getUint16(40,!0),this.requiredRAM=t.getUint16(42,!0),this.largestTrack=t.getUint16(44,!0))}}class Es{constructor(t){this.trackMap=[];for(let e=0;e<160;e++)this.trackMap.push(t.getUint8(e))}}class Rs{}class Ts extends Rs{constructor(t){super(),this.rawTracks=[],this.tracks=[];for(let e=0,s=0;s<t.byteLength;s+=6656,e++){let i=[];const r=[],a=t.buffer.slice(t.byteOffset+s,t.byteOffset+s+6656),n=new Uint8Array(a),o=new DataView(a).getUint16(6648,!0);for(let t=0;t<o;t++){const e=t>>3,s=7-(7&t);r[t]=n[e]>>s&1?1:0}i=[];let h=0;for(;h<r.length;){const t=hs(r,h);if(!t.nibble)break;i.push(t.nibble),h=t.offset+1}this.tracks[e]=new Uint8Array(i),this.rawTracks[e]=new Uint8Array(r)}}}class vs extends Rs{constructor(t){let e;for(super(),this.trks=[],e=0;e<160;e++){const s=t.getUint16(8*e,!0),i=t.getUint16(8*e+2,!0),r=t.getUint32(8*e+4,!0);if(0===r)break;this.trks.push({startBlock:s,blockCount:i,bitCount:r})}this.tracks=[],this.rawTracks=[];const s=t.buffer;for(e=0;e<this.trks.length;e++){const t=this.trks[e];let i=[];const r=[],a=512*t.startBlock,n=a+512*t.blockCount,o=s.slice(a,n),h=new Uint8Array(o);for(let e=0;e<t.bitCount;e++){const t=e>>3,s=7-(7&e);r[e]=h[t]>>s&1?1:0}i=[];let d=0;for(;d<r.length;){const t=hs(r,d);if(!t.nibble)break;i.push(t.nibble),d=t.offset+1}this.tracks[e]=new Uint8Array(i),this.rawTracks[e]=new Uint8Array(r)}}}class Ps{constructor(t){const e=ys(t,0,t.byteLength).split("\n");this.values=e.reduce((function(t,e){const s=e.split("\t");return t[s[0]]=s[1],t}),{})}}function Cs(t,e){let s=null;switch(t){case"2mg":s=function(t){let e,{rawData:s}=t;if(!s)throw new Error("Requires rawData");const{bytes:i,format:r,offset:a,readOnly:n,volume:o}=gs(s);switch(s=s.slice(a,a+i),t=Object.assign(Object.assign({},t),{rawData:s,readOnly:n,volume:o}),r){case fs.ProDOS:e=ls(t);break;case fs.NIB:e=cs(t);break;case fs.DOS:default:e=ds(t)}return e}(e);break;case"d13":s=function(t){const{data:e,name:s,side:i,rawData:r,volume:a,readOnly:n}=t,o={format:"d13",encoding:N,metadata:{name:s,side:i},volume:a,readOnly:n,tracks:[]};if(!e&&!r)throw new Error("data or rawData required");for(let t=0;t<35;t++){let s=[];for(let i=0;i<13;i++){const n=Ke[i];let o;if(r){const e=256*(13*t+n);o=new Uint8Array(r.slice(e,e+256))}else{if(!e)throw new Error("Requires data or rawData");o=e[t][n]}s=s.concat(ss(a,t,n,o))}o.tracks.push(new Uint8Array(s))}return o}(e);break;case"do":case"dsk":s=ds(e);break;case"nib":s=cs(e);break;case"po":s=ls(e);break;case"woz":s=function(t){const{rawData:e}=t;if(!e)throw new Error("Requires rawData");const s=new DataView(e,0);let i,r=0;const a={};function n(){if(r>=s.byteLength)return null;const t=s.getUint32(r,!0),e=s.getUint32(r+4,!0),i=new DataView(s.buffer,r+8,e);return r+=e+8,{type:t,size:e,data:i}}if(function(){switch(s.getUint32(ps+0,!0)){case bs:i=1;break;case _s:i=2;break;default:return!1}return s.getUint32(ps+4,!0)===ws}()){r=As;let t=n();for(;t;){switch(t.type){case 1330007625:a.info=new Ss(t.data);break;case 1346456916:a.tmap=new Es(t.data);break;case 1397445204:a.trks=1===i?new Ts(t.data):new vs(t.data);break;case 1096041805:a.meta=new Ps(t.data);break;case 1414091351:break;default:P("Unsupported chunk",C(t.type,8))}t=n()}}else P("Invalid woz header");const{meta:o,tmap:h,trks:d,info:c}=a;return{encoding:x,format:"woz",trackMap:(null==h?void 0:h.trackMap)||[],rawTracks:(null==d?void 0:d.rawTracks)||[],readOnly:!0,metadata:{name:(null==o?void 0:o.values.title)||t.name,side:(null==o?void 0:o.values.side_name)||(null==o?void 0:o.values.side)},info:c}}(e)}return s}const Is=new Uint8Array([162,32,160,0,162,3,134,60,138,10,36,60,240,16,5,60,73,255,41,126,176,8,74,208,251,152,157,86,3,200,232,16,229,32,88,255,186,189,0,1,10,10,10,10,133,43,170,189,142,192,189,140,192,189,138,192,189,137,192,160,80,189,128,192,152,41,3,10,5,43,170,189,129,192,169,86,32,168,252,136,16,235,133,38,133,61,133,65,169,8,133,39,24,8,189,140,192,16,251,73,213,208,247,189,140,192,16,251,201,170,208,243,234,189,140,192,16,251,201,150,240,9,40,144,223,73,173,240,37,208,217,160,3,133,64,189,140,192,16,251,42,133,60,189,140,192,16,251,37,60,136,208,236,40,197,61,208,190,165,64,197,65,208,184,176,183,160,86,132,60,188,140,192,16,251,89,214,2,164,60,136,153,0,3,208,238,132,60,188,140,192,16,251,89,214,2,164,60,145,38,200,208,239,188,140,192,16,251,89,214,2,208,135,160,0,162,86,202,48,251,177,38,94,0,3,42,94,0,3,42,145,38,200,208,238,230,39,230,61,165,61,205,0,8,166,43,144,219,76,1,8,0,0,0,0,0]),Os=new Uint8Array([162,32,160,0,169,3,133,60,24,136,152,36,60,240,245,38,60,144,248,192,213,240,237,202,138,153,0,8,208,230,32,88,255,186,189,0,1,72,10,10,10,10,133,43,170,169,208,72,189,142,192,189,140,192,189,138,192,189,137,192,160,80,189,128,192,152,41,3,10,5,43,170,189,129,192,169,86,32,168,252,136,16,235,169,3,133,39,169,0,133,38,133,61,24,8,189,140,192,16,251,73,213,208,247,189,140,192,16,251,201,170,208,243,234,189,140,192,16,251,201,181,240,9,40,144,223,73,173,240,31,208,217,160,3,132,42,189,140,192,16,251,42,133,60,189,140,192,16,251,37,60,136,208,238,40,197,61,208,190,176,189,160,154,132,60,188,140,192,16,251,89,0,8,164,60,136,153,0,8,208,238,132,60,188,140,192,16,251,89,0,8,164,60,145,38,200,208,239,188,140,192,16,251,89,0,8,208,141,96,168,162,0,185,0,8,74,62,204,3,74,62,153,3,133,60,177,38,10,10,10,5,60,145,38,200,232,224,51,208,228,198,42,208,222,204,0,3,208,3,76,1,3,76,45,255,255]);class ks{constructor(t){this.drive=t}tick(){}onQ6Low(){}onQ6High(t){}onDriveOn(){}onDriveOff(){}clampTrack(){this.drive.track<0&&(this.drive.track=0),this.drive.track>34&&(this.drive.track=34)}getState(){return{}}setState(t){}}class Ms{constructor(t,e,s,i){this.driveNo=t,this.drive=e,this.disk=s,this.controller=i}debug(...t){}isOn(){return this.controller.on&&this.controller.driveNo===this.driveNo}isWriteProtected(){return this.drive.readOnly}}class Ds extends Ms{constructor(t,e,s,i,r){super(t,e,s,i),this.disk=s,this.onDirty=r,this.skip=0,this.nibbleCount=0}tick(){}onQ6Low(){const t=this.drive,e=this.disk;if(this.isOn()&&(this.skip||this.controller.q7)){const s=e.tracks[t.track>>2];s&&s.length&&(t.head>=s.length&&(t.head=0),this.controller.q7?e.readOnly||(s[t.head]=this.controller.bus,t.dirty=!0,this.onDirty()):(this.controller.latch=s[t.head],this.nibbleCount++),++t.head)}else this.controller.latch=0;this.skip=++this.skip%2}onQ6High(t){const e=this.drive;t&&!this.controller.q7&&(e.readOnly?(this.controller.latch=255,this.debug("Setting readOnly")):(this.controller.latch>>=1,this.debug("Clearing readOnly")))}onDriveOn(){this.nibbleCount=0}onDriveOff(){this.debug("nibbles read",this.nibbleCount)}clampTrack(){this.drive.track<0&&(this.drive.track=0),this.drive.track>139&&(this.drive.track=139)}getState(){const{skip:t,nibbleCount:e}=this;return{skip:t,nibbleCount:e}}setState(t){this.skip=t.skip,this.nibbleCount=t.nibbleCount}}class Ls extends Ms{constructor(t,e,s,i,r,a){super(t,e,s,i),this.disk=s,this.onDirty=r,this.io=a,this.lastCycles=0,this.zeros=0,this.state=2,this.clock=0}onDriveOn(){this.lastCycles=this.io.cycles()}onDriveOff(){}moveHead(){const t=this.io.cycles();let e=2*(t-this.lastCycles);this.lastCycles=t;const s=this.drive,i=this.disk,r=this.controller,a=i.rawTracks[i.trackMap[s.track]]||[0];for(;e-- >0;){let t=0;4===this.clock&&(t=a[s.head],t?this.zeros=0:++this.zeros>2&&(t=Math.random()>=.5?1:0));let e=0;e|=t?0:1,e|=128&r.latch?2:0,e|=r.q6?4:0,e|=r.q7?8:0,e|=this.state<<4;const i=Ns[r.sectors][e];switch(this.debug(`clock: ${this.clock} state: ${C(this.state)} pulse: ${t} command: ${C(i)} q6: ${r.q6} latch: ${C(r.latch)}`),15&i){case 0:r.latch=0;break;case 8:break;case 9:r.latch=r.latch<<1&255;break;case 10:r.latch>>=1,this.isWriteProtected()&&(r.latch|=128);break;case 11:r.latch=r.bus,this.debug("Loading",C(r.latch),"from bus");break;case 13:r.latch=255&(r.latch<<1|1);break;default:this.debug(`unknown command: ${C(15&i)}`)}this.state=i>>4&15,4===this.clock&&this.isOn()&&(r.q7&&(a[s.head]=8&this.state?1:0,this.debug("Wrote",8&this.state?1:0),s.dirty=!0,this.onDirty()),++s.head>=a.length&&(s.head=0)),++this.clock>7&&(this.clock=0)}}tick(){this.moveHead()}onQ6High(t){}onQ6Low(){}clampTrack(){this.drive.track<0&&(this.drive.track=0);const t=this.disk.trackMap.length-1;this.drive.track>t&&(this.drive.track=t)}getState(){const{clock:t,state:e,lastCycles:s,zeros:i}=this;return{clock:t,state:e,lastCycles:s,zeros:i}}setState(t){this.clock=t.clock,this.state=t.state,this.lastCycles=t.lastCycles,this.zeros=t.zeros}}const Ns={13:[216,24,24,8,10,10,10,10,24,24,24,24,24,24,24,24,216,45,40,40,10,10,10,10,40,40,40,40,40,40,40,40,216,56,56,56,10,10,10,10,57,57,57,57,59,59,59,59,216,72,216,72,10,10,10,10,72,72,72,72,72,72,72,72,216,88,216,88,10,10,10,10,88,88,88,88,88,88,88,88,216,104,216,104,10,10,10,10,104,104,104,104,104,104,104,104,216,120,216,120,10,10,10,10,120,120,120,120,120,120,120,120,216,136,216,136,10,10,10,10,8,8,136,136,8,8,136,136,216,152,216,152,10,10,10,10,152,152,152,152,152,152,152,152,216,9,216,168,10,10,10,10,168,168,168,168,168,168,168,168,205,189,216,184,10,10,10,10,185,185,185,185,187,187,187,187,217,57,216,200,10,10,10,10,200,200,200,200,200,200,200,200,217,217,216,160,10,10,10,10,216,216,216,216,216,216,216,216,29,13,232,232,10,10,10,10,232,232,232,232,232,232,232,232,253,253,248,248,10,10,10,10,248,248,248,248,248,248,248,248,221,77,224,224,10,10,10,10,136,136,8,8,136,136,8,8],16:[24,24,24,24,10,10,10,10,24,24,24,24,24,24,24,24,45,45,56,56,10,10,10,10,40,40,40,40,40,40,40,40,216,56,8,40,10,10,10,10,57,57,57,57,59,59,59,59,216,72,72,72,10,10,10,10,72,72,72,72,72,72,72,72,216,88,216,88,10,10,10,10,88,88,88,88,88,88,88,88,216,104,216,104,10,10,10,10,104,104,104,104,104,104,104,104,216,120,216,120,10,10,10,10,120,120,120,120,120,120,120,120,216,136,216,136,10,10,10,10,8,8,136,136,8,8,136,136,216,152,216,152,10,10,10,10,152,152,152,152,152,152,152,152,216,41,216,168,10,10,10,10,168,168,168,168,168,168,168,168,205,189,216,184,10,10,10,10,185,185,185,185,187,187,187,187,217,89,216,200,10,10,10,10,200,200,200,200,200,200,200,200,217,217,216,160,10,10,10,10,216,216,216,216,216,216,216,216,216,8,232,232,10,10,10,10,232,232,232,232,232,232,232,232,253,253,248,248,10,10,10,10,248,248,248,248,248,248,248,248,221,77,224,224,10,10,10,10,136,136,8,8,136,136,8,8]},xs={13:Os,16:Is},Bs=[[0,1,2,-1],[-1,0,1,2],[-2,-1,0,1],[1,-2,-1,0]];function Fs(t){if(H(t)){const{encoding:e,metadata:s,readOnly:i}=t;return{encoding:e,metadata:Object.assign({},s),readOnly:i}}if(G(t)){const{format:e,encoding:s,metadata:i,readOnly:r,volume:a,tracks:n}=t,o={format:e,encoding:s,volume:a,tracks:[],readOnly:r,metadata:Object.assign({},i)};for(let t=0;t<n.length;t++)o.tracks.push(new Uint8Array(n[t]));return o}if(Z(t)){const{format:e,encoding:s,metadata:i,readOnly:r,trackMap:a,rawTracks:n}=t,o={format:e,encoding:s,readOnly:r,trackMap:[],rawTracks:[],metadata:Object.assign({},i),info:t.info};o.trackMap=[...a];for(let t=0;t<n.length;t++)o.rawTracks.push(new Uint8Array(n[t]));return o}throw new Error("Unknown drive state")}class Us{constructor(t,e,s=16){this.io=t,this.callbacks=e,this.sectors=s,this.drives={1:{track:0,head:0,phase:0,readOnly:!1,dirty:!1},2:{track:0,head:0,phase:0,readOnly:!1,dirty:!1}},this.disks={1:{encoding:L,readOnly:!1,metadata:{name:"Disk 1"}},2:{encoding:L,readOnly:!1,metadata:{name:"Disk 2"}}},this.driver={1:new ks(this.drives[1]),2:new ks(this.drives[2])},this.offTimeout=null,this.debug("Disk ]["),this.state={sectors:s,bus:0,latch:0,driveNo:1,on:!1,q6:!1,q7:!1,clock:0,state:2},this.updateActiveDrive(),this.initWorker()}updateActiveDrive(){this.curDrive=this.drives[this.state.driveNo],this.curDriver=this.driver[this.state.driveNo]}debug(...t){}head(){return this.curDrive.head}setPhase(t,e){this.state.on?(this.debug(`phase ${t}${e?" on":" off"}`),e&&(this.curDrive.track+=2*Bs[this.curDrive.phase][t],this.curDrive.phase=t),this.curDriver.clampTrack()):this.debug(`ignoring phase ${t}${e?" on":" off"}`)}access(t,e){const s=this.state;let i=0;const r=void 0===e;switch(143&t){case 128:this.setPhase(0,!1);break;case 129:this.setPhase(0,!0);break;case 130:this.setPhase(1,!1);break;case 131:this.setPhase(1,!0);break;case 132:this.setPhase(2,!1);break;case 133:this.setPhase(2,!0);break;case 134:this.setPhase(3,!1);break;case 135:this.setPhase(3,!0);break;case 136:this.offTimeout||s.on&&(this.offTimeout=window.setTimeout((()=>{this.debug("Drive Off"),s.on=!1,this.callbacks.driveLight(s.driveNo,!1),this.curDriver.onDriveOff()}),1e3));break;case 137:this.offTimeout&&(window.clearTimeout(this.offTimeout),this.offTimeout=null),s.on||(this.debug("Drive On"),s.on=!0,this.callbacks.driveLight(s.driveNo,!0),this.curDriver.onDriveOn());break;case 138:this.debug("Disk 1"),s.driveNo=1,this.updateActiveDrive(),s.on&&(this.callbacks.driveLight(2,!1),this.callbacks.driveLight(1,!0));break;case 139:this.debug("Disk 2"),s.driveNo=2,this.updateActiveDrive(),s.on&&(this.callbacks.driveLight(1,!1),this.callbacks.driveLight(2,!0));break;case 140:s.q6=!1,this.curDriver.onQ6Low();break;case 141:s.q6=!0,this.curDriver.onQ6High(r);break;case 142:this.debug("Read Mode"),s.q7=!1;break;case 143:this.debug("Write Mode"),s.q7=!0}return this.tick(),r?i=0==(1&t)?s.latch:0:s.bus=e,i}updateDirty(t,e){this.drives[t].dirty=e,this.callbacks.dirty&&this.callbacks.dirty(t,e)}ioSwitch(t,e){return this.access(t,e)}read(t,e){return xs[this.sectors][e]}write(){}reset(){const t=this.state;t.on&&(this.callbacks.driveLight(t.driveNo,!1),t.q7=!1,t.on=!1,t.driveNo=1),this.updateActiveDrive()}tick(){this.curDriver.tick()}getDriveState(t){const e=this.drives[t],s=this.disks[t],i=this.driver[t],{readOnly:r,track:a,head:n,phase:o,dirty:h}=e;return{disk:Fs(s),driver:i.getState(),readOnly:r,track:a,head:n,phase:o,dirty:h}}getState(){const t={drives:[],controllerState:Object.assign({},this.state)};return t.drives[1]=this.getDriveState(1),t.drives[2]=this.getDriveState(2),t}setDriveState(t,e){const{track:s,head:i,phase:r,readOnly:a,dirty:n}=e;this.drives[t]={track:s,head:i,phase:r,readOnly:a,dirty:n};const o=Fs(e.disk);this.setDiskInternal(t,o),this.driver[t].setState(e.driver)}setState(t){this.state=Object.assign({},t.controllerState);for(const e of D){this.setDriveState(e,t.drives[e]);const{name:s,side:i}=t.drives[e].disk.metadata,{dirty:r}=t.drives[e];this.callbacks.label(e,s,i),this.callbacks.driveLight(e,this.state.on),this.callbacks.dirty(e,r)}this.updateActiveDrive()}getMetadata(t){const{track:e,head:s,phase:i,readOnly:r,dirty:a}=this.drives[t];return{track:e,head:s,phase:i,readOnly:r,dirty:a}}rwts(t,e,s){const i=this.disks[t];if(!G(i))throw new Error("Can't read WOZ disks");return os(i,e,s)}setDisk(t,e){if(this.worker){const s={type:"PROCESS_JSON_DISK",payload:{driveNo:t,jsonDisk:e}};return this.worker.postMessage(s),!0}{const s=function(t){const e=t.type,s=t.readOnly,i=t.name,r=t.disk;if(M(F,e)){let a;if("base64"===t.encoding){a=[];for(let e=0;e<t.data.length;e++)if(a[e]=[],"nib"===t.type)a[e][0]=A(t.data[e]);else for(let s=0;s<t.data[e].length;s++)a[e][s]=A(t.data[e][s])}else a=t.data;return Cs(e,{volume:t.volume||254,readOnly:s,name:i,side:r,data:a})}return null}(e);if(s)return this.insertDisk(t,s),!0}return!1}getJSON(t,e=!1){const s=this.disks[t];if(!G(s))throw new Error("Can't save WOZ disks to JSON");return function(t,e){const s=[];let i="dsk";for(let e=0;e<t.tracks.length;e++)if(s[e]=[],"nib"===t.format)i="nib",s[e]=p(t.tracks[e]);else for(let i=0;i<16;i++){const r="po"===t.format?We[i]:Ze[i];s[e][i]=p(os(t,e,r))}return JSON.stringify({type:i,encoding:"base64",volume:t.volume,data:s,readOnly:t.readOnly},void 0,e?"    ":void 0)}(s,e)}setJSON(t,e){if(this.worker){const s={type:"PROCESS_JSON",payload:{driveNo:t,json:e}};this.worker.postMessage(s)}else{const s=function(t){const e=[],s=JSON.parse(t),i=s.volume||254,r=s.readOnly||!1;for(let t=0;t<s.data.length;t++){let r=[];for(let e=0;e<s.data[t].length;e++){const a="po"===s.type?Ye[e]:Ge[e],n=A(s.data[t][a]);r=r.concat(es(i,t,e,n))}e[t]=v(r)}if(a=s.type,!F.includes(a))throw new Error(`JSON disks of type ${s.type} are not supported`);var a;return{volume:i,format:s.type,encoding:N,metadata:{name:s.name},tracks:e,readOnly:r}}(e);this.insertDisk(t,s)}return!0}setBinary(t,e,s,i){const r={name:e,rawData:i,readOnly:!1,volume:254};if(this.worker){const e={type:"PROCESS_BINARY",payload:{driveNo:t,fmt:s,options:r}};return this.worker.postMessage(e),!0}{const e=Cs(s,r);if(e)return this.insertDisk(t,e),!0}return!1}initWorker(){if(window.Worker)try{this.worker=new Worker("dist/format_worker.bundle.js"),this.worker.addEventListener("message",(t=>{const{data:e}=t;if("DISK_PROCESSED"===e.type){const{driveNo:t,disk:s}=e.payload;s&&this.insertDisk(t,s)}}))}catch(t){console.error(t)}}setDiskInternal(t,e){if(this.disks[t]=e,H(e))this.driver[t]=new ks(this.drives[t]);else if(G(e))this.driver[t]=new Ds(t,this.drives[t],e,this.state,(()=>this.updateDirty(t,!0)));else{if(!Z(e))throw new Error(`Unknown disk format ${e.encoding}`);this.driver[t]=new Ls(t,this.drives[t],e,this.state,(()=>this.updateDirty(t,!0)),this.io)}this.updateActiveDrive()}insertDisk(t,e){this.setDiskInternal(t,e),this.drives[t].head=0;const{name:s,side:i}=e.metadata;this.updateDirty(t,this.drives[t].dirty),this.callbacks.label(t,s,i)}getBinary(t,e){const s=this.disks[t];if(!G(s))return null;const{format:i,readOnly:r,tracks:a,volume:n}=s,{name:o}=s.metadata,h="nib"===i?a.reduce(((t,e)=>t+e.length),0):this.sectors*a.length*256,d=new Uint8Array(h);e=null!=e?e:i;let c=0;for(let t=0;t<a.length;t++)if("nib"===e)d.set(a[t],c),c+=a[t].length;else{let r,a;"d13"===e?(r=13,a=je):(r=16,a="po"===i?We:Ze);for(let i=0;i<r;i++){const r=a[i],n=os(Object.assign(Object.assign({},s),{format:e}),t,r);d.set(n,c),c+=n.length}}return{ext:e,metadata:{name:o},data:d.buffer,readOnly:r,volume:n}}getBase64(t){const e=this.disks[t];if(!G(e))return null;const s=[];for(let t=0;t<e.tracks.length;t++)if(G(e))s[t]=p(e.tracks[t]);else{const i=[];for(let s=0;s<16;s++)i[s]=p(os(e,t,s));s[t]=i}return s}}const Xs=new Uint8Array([24,176,56,72,138,72,152,72,8,120,32,88,255,186,104,104,104,104,168,202,154,104,40,170,144,56,189,184,5,16,25,152,41,127,73,48,201,10,144,59,201,120,176,41,73,61,240,33,152,41,159,157,56,6,144,126,189,184,6,48,20,165,36,221,56,7,176,13,201,17,176,9,9,240,61,56,7,101,36,133,36,74,56,176,109,24,106,61,184,6,144,2,73,129,157,184,6,208,83,160,10,125,56,5,136,208,250,157,184,4,157,56,5,56,176,67,197,36,144,58,104,168,104,170,104,76,240,253,144,254,176,254,153,128,192,144,55,73,7,168,73,10,10,208,6,184,133,36,157,56,7,189,184,6,74,112,2,176,35,10,10,169,39,176,207,189,56,7,253,184,4,201,248,144,3,105,39,172,169,0,133,36,24,126,184,5,104,168,104,170,104,96,144,39,176,0,16,17,169,137,157,56,6,157,184,6,169,40,157,184,4,169,2,133,54,152,93,56,6,10,240,144,94,184,5,152,72,138,10,10,10,10,168,189,56,7,197,36,104,176,5,72,41,128,9,32,44,88,255,240,3,254,56,7,112,132]);class zs{constructor(t){this.cbs=t,P("Parallel card")}access(t,e){return 128==(143&t)?this.cbs.putChar&&e&&this.cbs.putChar(e):P("Parallel card unknown softswitch",t),0}ioSwitch(t,e){return this.access(t,e)}read(t,e){return Xs[e]}write(){}getState(){return{}}setState(t){}}const Hs=new Uint8Array([67,79,80,89,82,73,71,72,84,32,40,67,41,32,49,57,56,54,45,56,57,32,65,80,80,76,73,69,68,32,69,78,71,73,78,69,69,82,73,78,71,0,66,79,66,32,83,65,78,68,69,82,45,67,69,68,69,82,76,79,70,0,77,73,67,72,65,69,76,32,87,73,76,75,83,0,83,84,69,86,69,78,32,77,65,76,69,67,72,69,75,0,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,201,32,201,0,201,3,201,0,176,49,32,22,193,76,155,193,32,22,193,76,159,193,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,193,174,255,207,14,159,192,162,152,140,248,7,142,120,7,76,223,201,169,193,197,57,8,32,22,193,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,193,76,186,250,185,56,4,201,1,208,42,32,123,193,24,144,36,32,154,202,32,235,202,160,193,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,16,76,1,8,96,160,3,208,2,160,5,162,3,185,213,193,149,66,136,202,16,247,8,120,142,159,192,162,152,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,159,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,193,76,0,200,32,40,193,76,232,203,201,16,240,4,170,160,15,96,104,104,32,40,193,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,194,76,155,194,32,22,194,76,159,194,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,194,174,255,207,14,175,192,162,168,140,248,7,142,120,7,76,223,201,169,194,197,57,8,32,22,194,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,194,76,186,250,185,56,4,201,1,208,42,32,123,194,24,144,36,32,154,202,32,235,202,160,194,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,32,76,1,8,96,160,3,208,2,160,5,162,3,185,213,194,149,66,136,202,16,247,8,120,142,175,192,162,168,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,175,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,194,76,0,200,32,40,194,76,232,203,201,32,240,4,170,160,15,96,104,104,32,40,194,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,195,76,155,195,32,22,195,76,159,195,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,195,174,255,207,14,191,192,162,184,140,248,7,142,120,7,76,223,201,169,195,197,57,8,32,22,195,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,195,76,186,250,185,56,4,201,1,208,42,32,123,195,24,144,36,32,154,202,32,235,202,160,195,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,48,76,1,8,96,160,3,208,2,160,5,162,3,185,213,195,149,66,136,202,16,247,8,120,142,191,192,162,184,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,191,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,195,76,0,200,32,40,195,76,232,203,201,48,240,4,170,160,15,96,104,104,32,40,195,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,196,76,155,196,32,22,196,76,159,196,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,196,174,255,207,14,207,192,162,200,140,248,7,142,120,7,76,223,201,169,196,197,57,8,32,22,196,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,196,76,186,250,185,56,4,201,1,208,42,32,123,196,24,144,36,32,154,202,32,235,202,160,196,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,64,76,1,8,96,160,3,208,2,160,5,162,3,185,213,196,149,66,136,202,16,247,8,120,142,207,192,162,200,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,207,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,196,76,0,200,32,40,196,76,232,203,201,64,240,4,170,160,15,96,104,104,32,40,196,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,197,76,155,197,32,22,197,76,159,197,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,197,174,255,207,14,223,192,162,216,140,248,7,142,120,7,76,223,201,169,197,197,57,8,32,22,197,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,197,76,186,250,185,56,4,201,1,208,42,32,123,197,24,144,36,32,154,202,32,235,202,160,197,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,80,76,1,8,96,160,3,208,2,160,5,162,3,185,213,197,149,66,136,202,16,247,8,120,142,223,192,162,216,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,223,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,197,76,0,200,32,40,197,76,232,203,201,80,240,4,170,160,15,96,104,104,32,40,197,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,198,76,155,198,32,22,198,76,159,198,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,198,174,255,207,14,239,192,162,232,140,248,7,142,120,7,76,223,201,169,198,197,57,8,32,22,198,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,198,76,186,250,185,56,4,201,1,208,42,32,123,198,24,144,36,32,154,202,32,235,202,160,198,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,96,76,1,8,96,160,3,208,2,160,5,162,3,185,213,198,149,66,136,202,16,247,8,120,142,239,192,162,232,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,239,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,198,76,0,200,32,40,198,76,232,203,201,96,240,4,170,160,15,96,104,104,32,40,198,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,199,76,155,199,32,22,199,76,159,199,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,199,174,255,207,14,255,192,162,248,140,248,7,142,120,7,76,223,201,169,199,197,57,8,32,22,199,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,199,76,186,250,185,56,4,201,1,208,42,32,123,199,24,144,36,32,154,202,32,235,202,160,199,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,112,76,1,8,96,160,3,208,2,160,5,162,3,185,213,199,149,66,136,202,16,247,8,120,142,255,192,162,248,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,255,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,199,76,0,200,32,40,199,76,232,203,201,112,240,4,170,160,15,96,104,104,32,40,199,76,111,204,174,1,0,0,79,219,32,153,205,162,9,181,66,72,202,16,250,186,189,12,1,133,70,189,11,1,133,69,160,3,177,69,153,65,0,254,11,1,208,3,254,12,1,136,208,240,140,248,4,140,120,5,140,248,5,170,201,10,176,40,189,135,200,209,67,208,36,160,8,177,67,153,67,0,136,208,248,74,208,17,174,120,7,164,66,169,200,72,185,125,200,72,70,68,165,71,96,169,17,44,169,1,44,169,4,141,248,4,162,0,104,149,66,232,224,10,144,248,172,248,5,174,120,5,173,248,4,208,1,24,96,202,163,181,144,156,144,147,147,152,150,3,3,3,1,3,1,1,1,4,4,76,102,200,76,94,200,176,44,176,24,144,247,240,242,169,33,76,99,200,144,238,32,12,201,176,29,173,19,192,6,75,10,102,75,76,35,201,144,220,32,12,201,176,11,173,20,192,6,75,10,102,75,76,130,201,76,125,201,176,19,208,208,160,8,140,120,5,136,145,69,208,251,169,1,145,69,76,102,200,240,7,160,25,201,3,208,183,44,160,4,140,120,5,136,185,198,201,192,2,208,14,174,248,7,189,184,5,74,145,69,136,189,56,6,106,145,69,136,16,230,76,102,200,10,133,74,165,72,42,176,14,133,75,165,73,201,1,176,6,133,71,169,2,133,72,96,32,100,201,176,85,44,20,192,8,10,144,3,141,5,192,165,72,141,248,5,240,14,189,251,191,145,69,200,208,248,230,70,198,72,208,242,165,71,240,13,141,120,5,189,251,191,145,69,200,196,71,208,246,141,4,192,40,16,3,141,5,192,76,102,200,165,73,157,248,191,165,74,157,249,191,165,75,41,127,157,250,191,32,157,202,160,0,165,75,96,169,45,76,99,200,32,100,201,176,246,44,19,192,8,141,2,192,10,144,3,141,3,192,165,72,141,248,5,240,14,177,69,157,251,191,200,208,248,230,70,198,72,208,242,165,71,141,120,5,240,10,177,69,157,251,191,200,196,71,208,246,141,2,192,40,16,3,141,3,192,76,102,200,248,0,0,0,7,82,65,77,67,65,82,68,32,32,32,32,32,32,32,32,32,0,0,0,0,172,248,7,32,142,202,189,251,191,201,174,208,69,93,251,191,201,90,208,62,189,251,191,153,56,4,73,90,221,251,191,208,49,189,251,191,153,184,3,185,56,4,157,248,191,189,251,191,153,184,4,189,251,191,153,56,5,189,251,191,153,184,5,189,251,191,153,56,6,189,251,191,153,184,6,189,251,191,153,56,7,96,185,184,6,89,56,7,201,90,240,56,32,142,202,169,4,157,249,191,189,251,191,93,251,191,93,251,191,93,251,191,162,76,201,3,240,12,162,0,201,6,240,6,162,51,201,190,208,9,138,153,184,6,73,90,153,56,7,32,0,203,172,248,7,153,184,3,185,184,3,10,153,184,5,169,0,153,56,6,153,56,5,153,184,4,169,1,153,56,4,96,174,120,7,169,0,157,248,191,157,249,191,157,250,191,96,32,142,202,172,248,7,185,184,3,201,9,189,250,191,176,2,41,15,72,208,30,185,56,4,201,8,208,23,189,249,191,201,2,176,16,9,254,157,249,191,185,184,3,233,0,42,157,250,191,104,96,189,249,191,217,56,6,104,72,249,184,5,176,241,189,249,191,121,56,5,157,249,191,104,121,184,4,157,250,191,96,160,0,189,251,191,153,0,8,200,208,247,189,251,191,153,0,9,200,208,247,96,32,139,202,168,221,250,191,208,2,160,2,25,149,203,133,63,133,62,157,250,191,189,251,191,222,248,191,72,165,63,157,251,191,222,248,191,57,149,203,240,20,165,63,56,249,152,203,76,14,203,24,165,63,121,152,203,133,63,157,250,191,189,251,191,197,63,208,63,73,255,222,248,191,157,251,191,222,248,191,221,251,191,208,47,222,248,191,165,63,57,149,203,217,149,203,208,209,165,62,157,250,191,104,157,251,191,222,248,191,24,165,62,121,152,203,133,62,57,149,203,208,231,165,63,136,16,140,74,105,2,96,222,248,191,56,165,63,240,214,249,152,203,133,63,76,97,203,234,234,12,48,192,4,16,64,162,4,160,0,169,0,72,56,165,62,253,222,203,72,165,63,253,227,203,144,10,133,63,104,133,62,104,105,0,208,231,104,104,208,8,136,16,5,138,240,2,169,16,200,73,176,32,237,253,202,16,208,169,203,76,237,253,8,8,32,56,80,104,128,152,176,200,4,40,144,160,64,0,0,1,15,156,164,66,200,240,107,32,153,205,160,43,176,24,160,40,165,67,48,18,164,66,240,17,136,240,30,136,240,57,136,240,20,160,1,44,160,39,152,56,96,172,248,7,32,228,207,172,120,4,174,248,4,169,0,24,96,32,88,204,176,230,160,0,189,251,191,145,68,200,208,248,230,69,189,251,191,145,68,200,208,248,198,69,152,24,96,32,88,204,176,200,160,0,177,68,157,251,191,200,208,248,230,69,177,68,157,251,191,200,208,248,240,224,169,0,157,248,191,165,70,10,157,249,191,165,71,42,176,6,157,250,191,32,157,202,96,32,86,205,160,16,176,106,32,251,204,160,2,177,72,133,62,73,1,240,5,144,88,32,22,205,160,14,169,254,145,72,160,4,132,63,177,72,221,53,205,176,68,74,102,63,74,102,63,74,102,63,224,1,240,3,74,102,63,72,200,177,72,221,55,205,176,43,5,63,72,32,139,202,104,157,249,191,104,157,250,191,32,157,202,176,24,160,8,177,72,133,62,200,177,72,133,63,160,12,177,72,168,240,29,136,240,18,136,240,5,56,160,128,208,19,177,62,157,251,191,200,208,248,240,8,189,251,191,145,62,200,208,248,24,152,160,13,145,72,96,172,248,7,162,3,185,56,6,221,49,205,185,184,5,253,45,205,176,4,202,16,239,96,138,74,170,96,24,172,248,7,185,56,5,125,59,205,153,56,5,185,184,4,125,57,205,153,184,4,96,2,4,6,12,48,96,64,128,35,50,16,32,2,6,48,64,172,248,7,32,228,207,201,16,176,5,173,120,4,240,9,185,56,7,73,90,217,184,6,56,96,32,61,205,144,60,208,6,201,51,208,54,24,96,169,51,153,184,6,32,251,204,48,42,144,34,185,56,5,72,185,184,4,72,142,248,4,32,22,205,188,226,207,32,251,205,174,248,4,172,248,7,104,153,184,4,104,153,56,5,188,226,207,76,193,205,56,96,32,61,205,144,18,208,18,201,205,208,2,24,96,32,236,205,208,5,217,184,6,240,244,56,96,32,236,205,208,249,153,184,6,160,0,10,208,2,160,135,32,251,205,32,142,202,172,248,7,185,56,4,201,1,240,17,24,105,4,157,248,191,185,184,6,157,251,191,73,90,157,251,191,185,184,6,73,90,153,56,7,24,96,173,0,191,240,2,201,76,96,174,120,7,32,103,206,200,185,48,207,208,244,96,41,15,157,251,191,169,0,157,251,191,96,152,72,173,248,4,201,1,173,120,4,233,0,74,74,74,74,168,169,255,133,62,169,3,74,102,62,136,16,250,157,251,191,165,62,157,251,191,104,168,96,32,83,206,169,1,72,32,6,206,169,17,157,251,191,104,72,157,251,191,32,83,206,104,24,105,1,201,31,144,231,96,169,0,44,169,255,157,251,191,221,248,191,208,248,106,144,3,157,251,191,96,201,64,176,35,201,48,176,62,201,32,176,142,201,16,176,149,201,4,240,74,176,8,201,2,144,88,240,208,176,209,201,6,144,73,240,169,76,244,206,72,41,63,240,24,104,72,41,192,10,240,8,169,255,176,4,200,185,48,207,157,251,191,104,56,233,1,208,227,104,96,41,15,72,169,255,157,251,191,157,251,191,32,6,206,157,251,191,104,56,233,1,208,235,96,173,248,4,157,251,191,173,120,4,157,251,191,96,173,248,7,73,240,208,245,169,0,157,248,191,200,185,48,207,157,249,191,200,185,48,207,157,250,191,152,72,32,157,202,104,168,96,152,72,172,120,4,240,13,234,152,72,160,32,32,39,207,104,168,136,208,244,173,248,4,72,74,74,74,240,4,168,32,39,207,104,41,7,168,169,0,56,106,136,16,251,10,157,251,191,104,168,96,169,255,157,251,191,136,208,250,96,1,0,0,2,2,1,2,0,2,2,32,35,68,244,82,65,77,5,153,67,195,39,13,32,38,4,2,2,34,36,2,2,35,37,2,2,36,32,2,2,7,2,2,1,12,0,16,0,1,0,0,2,1,4,0,68,2,15,32,147,1,16,1,71,51,17,15,4,0,0,254,160,65,122,136,72,17,1,0,0,35,16,0,1,136,63,132,63,50,2,6,0,1,0,0,2,1,4,0,68,2,15,32,147,1,32,2,71,51,17,31,4,0,0,254,160,65,122,136,72,17,1,0,0,50,32,0,1,132,200,248,132,3,6,0,1,0,0,2,2,1,2,0,2,2,130,65,6,131,68,4,82,65,77,5,131,4,2,2,2,2,2,2,2,2,2,2,2,2,0,68,174,244,8,82,2,2,0,48,92,185,184,5,74,141,120,4,185,56,6,106,141,248,4,96,255,255,255,255,255,255,255,255,255,255,255,255,255,67,79,80,89,82,73,71,72,84,32,40,67,41,32,49,57,56,54,45,56,57,32,65,80,80,76,73,69,68,32,69,78,71,73,78,69,69,82,73,78,71,0,66,79,66,32,83,65,78,68,69,82,45,67,69,68,69,82,76,79,70,0,77,73,67,72,65,69,76,32,87,73,76,75,83,0,83,84,69,86,69,78,32,77,65,76,69,67,72,69,75,0,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,201,32,201,0,201,3,201,0,176,49,32,22,193,76,155,193,32,22,193,76,159,193,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,193,174,255,207,14,159,192,162,152,140,248,7,142,120,7,76,223,201,169,193,197,57,8,32,22,193,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,193,76,186,250,185,56,4,201,1,208,42,32,123,193,24,144,36,32,154,202,32,235,202,160,193,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,16,76,1,8,96,160,3,208,2,160,5,162,3,185,213,193,149,66,136,202,16,247,8,120,142,159,192,162,152,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,159,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,193,76,0,200,32,40,193,76,232,203,201,16,240,4,170,160,15,96,104,104,32,40,193,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,194,76,155,194,32,22,194,76,159,194,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,194,174,255,207,14,175,192,162,168,140,248,7,142,120,7,76,223,201,169,194,197,57,8,32,22,194,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,194,76,186,250,185,56,4,201,1,208,42,32,123,194,24,144,36,32,154,202,32,235,202,160,194,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,32,76,1,8,96,160,3,208,2,160,5,162,3,185,213,194,149,66,136,202,16,247,8,120,142,175,192,162,168,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,175,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,194,76,0,200,32,40,194,76,232,203,201,32,240,4,170,160,15,96,104,104,32,40,194,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,195,76,155,195,32,22,195,76,159,195,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,195,174,255,207,14,191,192,162,184,140,248,7,142,120,7,76,223,201,169,195,197,57,8,32,22,195,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,195,76,186,250,185,56,4,201,1,208,42,32,123,195,24,144,36,32,154,202,32,235,202,160,195,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,48,76,1,8,96,160,3,208,2,160,5,162,3,185,213,195,149,66,136,202,16,247,8,120,142,191,192,162,184,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,191,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,195,76,0,200,32,40,195,76,232,203,201,48,240,4,170,160,15,96,104,104,32,40,195,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,196,76,155,196,32,22,196,76,159,196,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,196,174,255,207,14,207,192,162,200,140,248,7,142,120,7,76,223,201,169,196,197,57,8,32,22,196,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,196,76,186,250,185,56,4,201,1,208,42,32,123,196,24,144,36,32,154,202,32,235,202,160,196,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,64,76,1,8,96,160,3,208,2,160,5,162,3,185,213,196,149,66,136,202,16,247,8,120,142,207,192,162,200,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,207,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,196,76,0,200,32,40,196,76,232,203,201,64,240,4,170,160,15,96,104,104,32,40,196,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,197,76,155,197,32,22,197,76,159,197,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,197,174,255,207,14,223,192,162,216,140,248,7,142,120,7,76,223,201,169,197,197,57,8,32,22,197,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,197,76,186,250,185,56,4,201,1,208,42,32,123,197,24,144,36,32,154,202,32,235,202,160,197,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,80,76,1,8,96,160,3,208,2,160,5,162,3,185,213,197,149,66,136,202,16,247,8,120,142,223,192,162,216,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,223,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,197,76,0,200,32,40,197,76,232,203,201,80,240,4,170,160,15,96,104,104,32,40,197,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,198,76,155,198,32,22,198,76,159,198,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,198,174,255,207,14,239,192,162,232,140,248,7,142,120,7,76,223,201,169,198,197,57,8,32,22,198,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,198,76,186,250,185,56,4,201,1,208,42,32,123,198,24,144,36,32,154,202,32,235,202,160,198,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,96,76,1,8,96,160,3,208,2,160,5,162,3,185,213,198,149,66,136,202,16,247,8,120,142,239,192,162,232,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,239,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,198,76,0,200,32,40,198,76,232,203,201,96,240,4,170,160,15,96,104,104,32,40,198,76,111,204,174,1,0,0,79,219,201,32,201,0,201,3,201,0,176,49,32,22,199,76,155,199,32,22,199,76,159,199,141,12,192,141,0,192,141,14,192,32,47,251,32,147,254,32,137,254,160,199,174,255,207,14,255,192,162,248,140,248,7,142,120,7,76,223,201,169,199,197,57,8,32,22,199,40,208,26,32,236,205,240,21,169,32,141,18,189,169,234,141,19,189,140,20,189,162,0,169,141,141,0,2,96,165,0,208,10,196,1,208,6,32,123,199,76,186,250,185,56,4,201,1,208,42,32,123,199,24,144,36,32,154,202,32,235,202,160,199,173,1,8,240,18,185,56,7,73,90,217,184,6,208,8,141,0,191,162,112,76,1,8,96,160,3,208,2,160,5,162,3,185,213,199,149,66,136,202,16,247,8,120,142,255,192,162,248,160,0,132,62,169,10,133,63,177,66,145,62,200,208,4,230,63,230,67,196,68,165,67,229,69,144,237,14,255,192,40,76,0,10,0,200,38,203,244,207,184,80,6,32,40,199,76,0,200,32,40,199,76,232,203,201,112,240,4,170,160,15,96,104,104,32,40,199,76,111,204,174,1,0,0,79,219,142,43,13,32,88,252,160,0,32,125,12,32,0,203,141,42,13,160,0,140,47,13,10,144,2,136,152,132,62,133,63,32,155,203,160,33,32,125,12,32,139,202,157,251,191,169,4,157,249,191,169,255,157,251,191,172,248,7,153,184,6,169,0,133,36,160,39,32,125,12,173,47,13,32,218,253,160,44,32,125,12,165,36,24,101,40,141,229,10,169,0,101,41,141,230,10,160,8,136,136,140,41,13,32,228,10,32,232,10,176,17,172,41,13,208,238,238,47,13,173,0,192,16,193,141,16,192,96,152,72,160,53,32,125,12,169,8,56,237,41,13,74,168,9,176,32,237,253,192,3,176,2,104,96,160,66,32,125,12,174,120,7,189,248,191,222,248,191,41,127,208,13,189,249,191,222,249,191,41,127,208,3,222,250,191,189,250,191,172,42,13,192,9,176,2,41,15,32,218,253,189,249,191,32,218,253,189,248,191,32,218,253,169,173,32,237,253,104,93,251,191,32,218,253,32,142,253,96,238,0,4,96,185,245,10,72,185,244,10,72,174,43,13,96,227,11,128,11,29,11,251,10,160,0,152,32,10,13,93,250,191,41,15,208,19,152,221,249,191,208,13,221,248,191,208,8,32,228,10,200,208,228,24,96,56,96,169,0,160,240,32,10,13,173,40,13,32,107,11,141,40,13,173,39,13,32,107,11,141,39,13,32,19,13,238,40,13,208,12,238,39,13,208,7,238,38,13,208,2,24,96,32,228,10,189,251,191,189,250,191,77,38,13,208,16,189,249,191,205,39,13,208,8,189,248,191,205,40,13,240,188,56,96,201,16,144,6,201,112,176,3,169,112,96,201,144,144,251,201,240,176,247,169,240,96,173,42,13,240,14,169,0,141,48,13,32,150,11,32,150,11,32,150,11,24,96,32,142,202,168,152,157,251,191,32,190,11,208,247,32,228,10,152,32,10,13,152,221,251,191,208,10,32,190,11,208,245,56,110,48,13,96,104,104,56,96,44,48,13,16,24,238,38,13,254,250,191,173,38,13,74,205,42,13,144,9,160,0,96,238,39,13,254,249,191,238,40,13,200,96,0,85,170,255,173,42,13,240,19,160,3,185,224,11,141,44,13,32,254,11,32,46,12,176,4,136,16,239,24,96,32,109,12,32,10,12,206,45,13,208,248,96,152,72,173,44,13,160,0,140,46,13,157,251,191,157,251,191,157,251,191,157,251,191,200,208,241,32,228,10,238,46,13,208,233,104,168,96,32,109,12,32,60,12,176,5,206,45,13,208,246,96,152,72,173,44,13,160,0,140,46,13,221,251,191,208,30,221,251,191,208,25,221,251,191,208,20,221,251,191,208,15,200,208,233,32,228,10,238,46,13,208,225,104,168,24,96,168,104,56,96,173,42,13,74,141,45,13,76,142,202,8,32,237,253,40,36,24,32,143,12,189,161,12,208,241,32,143,12,189,176,12,208,233,96,185,192,12,176,7,74,74,74,74,170,56,96,200,41,15,170,24,96,0,141,210,193,205,174,212,201,211,160,199,207,204,196,197,206,0,194,195,198,200,208,217,218,205,209,213,214,177,180,186,48,96,108,126,217,239,167,254,226,127,169,35,64,67,3,107,41,110,134,144,192,213,14,17,78,75,32,121,135,8,224,249,1,144,32,118,232,17,1,6,56,128,249,1,153,153,110,134,127,169,85,80,25,17,3,50,217,4,55,192,178,229,151,208,249,1,153,147,221,46,136,15,144,25,141,40,13,141,39,13,140,38,13,173,40,13,157,248,191,173,39,13,157,249,191,173,38,13,157,250,191,96,32,139,202,189,251,191,201,174,208,17,93,251,191,201,90,208,10,189,251,191,93,251,191,201,90,240,80,172,248,7,185,184,6,89,56,7,201,90,208,23,32,88,252,160,136,32,142,12,169,191,32,237,253,32,151,14,201,217,240,3,76,6,14,32,139,202,160,170,32,251,205,32,139,202,169,4,157,248,191,172,248,7,185,184,3,72,157,251,191,169,10,157,248,191,104,10,56,233,1,157,251,191,169,252,157,251,191,32,142,202,32,235,202,173,2,8,141,1,9,32,88,252,78,0,9,169,0,133,36,133,37,160,0,32,142,12,173,248,7,73,112,32,237,253,32,142,253,32,142,253,160,0,32,3,12,200,192,9,144,248,160,20,32,142,12,160,89,44,0,9,16,2,160,39,32,142,12,32,66,252,32,151,14,201,177,144,20,201,186,176,16,233,176,32,129,12,141,1,9,44,0,9,48,177,76,246,13,141,2,9,160,6,44,0,9,16,2,160,253,200,200,200,185,247,10,240,14,205,2,9,208,243,185,249,10,72,185,248,10,72,96,32,226,251,76,125,10,206,80,11,195,244,11,211,112,11,141,21,11,136,56,11,139,56,11,138,72,11,149,72,11,155,42,11,210,35,11,0,44,0,9,48,3,76,246,13,32,232,13,76,122,10,56,110,0,9,76,125,10,44,0,9,16,3,76,0,10,32,215,13,76,54,14,173,1,9,56,233,24,201,224,176,3,141,1,9,76,125,10,173,1,9,24,105,24,144,238,160,118,32,142,12,162,16,32,79,14,176,17,162,0,172,1,9,189,8,9,153,8,8,200,232,224,16,144,244,76,125,10,32,67,14,240,116,152,24,105,24,168,192,224,176,107,32,70,14,240,102,160,127,32,142,12,162,6,32,79,14,32,161,14,14,4,9,46,5,9,14,4,9,46,5,9,24,172,1,9,185,3,8,121,27,8,141,6,9,185,2,8,121,26,8,141,7,9,56,173,6,9,237,4,9,72,173,7,9,237,5,9,144,35,153,26,8,104,153,27,8,24,173,4,9,153,3,8,121,1,8,153,25,8,173,5,9,153,2,8,121,0,8,153,24,8,76,125,10,104,160,213,44,160,201,32,142,12,32,12,253,76,125,10,32,67,14,208,6,174,1,9,254,5,8,76,125,10,152,72,32,129,12,72,162,255,205,1,9,208,2,162,63,134,50,32,121,12,152,24,105,177,32,237,253,32,121,12,104,72,168,162,16,185,8,8,208,2,169,160,32,237,253,200,202,208,242,32,121,12,104,72,168,185,2,8,133,63,185,3,8,133,62,32,155,203,169,255,133,50,32,121,12,104,168,185,5,8,73,90,217,4,8,240,2,169,1,160,4,217,111,12,240,3,136,208,248,185,116,12,168,32,142,12,104,168,96,76,0,51,205,223,233,245,228,239,169,160,32,237,253,76,237,253,141,2,9,10,109,2,9,10,10,10,105,8,96,24,32,172,12,189,190,12,208,9,32,172,12,189,205,12,208,1,96,8,48,3,32,121,12,32,237,253,40,208,227,185,221,12,176,7,74,74,74,74,170,56,96,200,41,15,170,24,96,0,141,1,199,204,201,212,195,200,160,210,197,193,211,207,206,0,198,208,213,196,205,173,177,185,189,194,209,215,218,217,26,192,96,44,118,234,144,60,166,86,94,253,34,41,157,78,105,10,144,25,16,77,185,202,174,13,217,234,144,128,112,153,110,157,180,183,97,16,25,240,175,192,107,151,140,243,178,41,171,96,165,253,108,68,151,140,243,189,29,10,213,14,185,120,207,59,34,155,215,10,2,234,59,105,120,207,59,209,112,167,75,202,144,60,166,86,94,240,25,171,96,160,190,230,150,139,144,60,166,86,94,242,154,10,171,126,240,37,48,74,177,189,112,160,192,69,96,25,17,251,13,159,192,107,144,169,1,17,251,13,157,80,235,144,169,1,16,220,175,95,48,121,95,214,196,69,243,144,60,166,86,94,253,144,91,214,174,15,209,104,185,5,90,183,110,160,240,121,62,156,139,192,80,25,17,124,255,230,144,190,230,150,140,105,3,202,101,101,239,16,190,230,144,42,224,105,212,230,144,169,1,17,124,255,230,151,140,243,185,213,14,176,25,17,213,14,185,110,233,76,163,176,25,116,188,169,16,25,5,237,153,145,1,3,174,5,237,16,25,112,48,112,105,145,1,3,205,124,65,1,173,1,9,141,2,8,73,90,141,3,8,32,232,13,76,223,201,32,139,202,168,185,0,8,157,251,191,200,208,247,96,32,215,13,32,67,14,208,11,185,2,8,25,3,8,240,3,32,39,14,160,174,32,142,12,162,1,32,79,14,176,33,173,8,9,201,177,144,242,201,184,176,238,105,16,168,169,0,240,8,174,120,7,172,248,7,169,123,132,1,133,0,108,0,0,162,2,169,0,157,0,8,202,16,250,108,252,255,172,1,9,185,4,8,89,5,8,201,90,96,142,3,9,169,160,157,8,9,202,16,250,232,32,151,14,201,136,240,34,201,141,240,28,201,155,240,25,201,160,176,6,32,226,251,76,91,14,236,3,9,176,245,157,8,9,32,237,253,232,208,217,24,96,138,240,212,202,198,36,169,160,157,8,9,32,237,253,198,36,76,91,14,32,12,253,201,224,144,2,41,223,96,169,0,168,170,141,4,9,142,5,9,169,10,141,2,9,162,0,185,8,9,73,176,201,10,144,1,96,109,4,9,72,138,109,5,9,170,104,206,2,9,208,241,200,208,215,255,255,255,255,255,255,255,255,255,255,255,255]);class Gs{constructor(t){this.firmware=0,this.ramlo=0,this.rammid=0,this.ramhi=0,this.loc=0,P("RAMFactor card"),this.mem=R(t);for(let e=0;e<t;e++)this.mem[e]=0}sethi(t){this.ramhi=255&t}setmid(t){0!=(128&this.rammid)&&0==(128&t)&&this.sethi(this.ramhi+1),this.rammid=255&t}setlo(t){0!=(128&this.ramlo)&&0==(128&t)&&this.setmid(this.rammid+1),this.ramlo=255&t}access(t,e){let s=0;switch(143&t){case 128:case 132:void 0!==e?this.setlo(e):s=this.ramlo;break;case 129:case 133:void 0!==e?this.setmid(e):s=this.rammid;break;case 130:case 134:void 0!==e?this.sethi(e):(s=this.ramhi,s|=240);break;case 131:case 135:void 0!==e?this.mem[this.loc%this.mem.length]=e:s=this.mem[this.loc%this.mem.length],this.setlo(this.ramlo+1);break;case 143:void 0!==e?this.firmware=1&e:s=this.firmware}return this.loc=this.ramhi<<16|this.rammid<<8|this.ramlo,s}ioSwitch(t,e){return this.access(t,e)}read(t,e){return Hs[this.firmware<<12|t-192<<8|e]}write(){}reset(){this.firmware=0}getState(){return{loc:this.loc,firmware:this.firmware,mem:new Uint8Array(this.mem)}}setState(t){this.loc=t.loc,this.firmware=t.firmware,this.mem=new Uint8Array(t.mem),this.ramhi=this.loc>>16&255,this.rammid=this.loc>>8&255,this.ramlo=255&this.loc}}const Zs=new Uint8Array([162,32,162,0,162,3,162,0,32,88,255,186,189,0,1,141,248,7,10,10,10,10,168,185,128,192,74,176,17,165,0,208,10,165,1,205,248,7,208,3,76,186,250,76,0,224,162,1,134,66,202,134,70,134,71,134,68,162,8,134,69,173,248,7,72,72,169,71,72,184,80,11,104,10,10,10,10,170,76,1,8,0,0,96,0,0,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,215,83]),Ys="6502",Ws="rockwell65c02",Ks="wdc65c02",js=[Ws,Ks],qs={accumulator:1,implied:1,immediate:2,absolute:3,zeroPage:2,relative:2,absoluteX:3,absoluteY:3,zeroPageX:2,zeroPageY:2,absoluteIndirect:3,zeroPageXIndirect:2,zeroPageIndirectY:2,zeroPageIndirect:2,absoluteXIndirect:3,zeroPage_relative:3},Vs=128,Qs=64,Js=16,$s={read:function(){return 0},write:function(){}};class ti{constructor({flavor:t}={}){this.pc=0,this.sr=32,this.ar=0,this.xr=0,this.yr=0,this.sp=255,this.addr=0,this.memPages=new Array(256),this.resetHandlers=[],this.cycles=0,this.sync=!1,this.wait=!1,this.stop=!1,this.implied=()=>{this.readByte(this.pc)},this.readImmediate=()=>this.readBytePC(),this.readAbsolute=()=>this.readByte(this.readWordPC()),this.readZeroPage=()=>this.readByte(this.readBytePC()),this.readAbsoluteX=()=>{const t=this.readWordPC(),e=this.addr,s=t+this.xr&65535;return this.workCycleIndexedRead(e,t,s),this.readByte(s)},this.readAbsoluteY=()=>{const t=this.readWordPC(),e=this.addr,s=t+this.yr&65535;return this.workCycleIndexedRead(e,t,s),this.readByte(s)},this.readZeroPageX=()=>{const t=this.readBytePC();return this.readByte(t),this.readByte(t+this.xr&255)},this.readZeroPageY=()=>{const t=this.readBytePC();return this.readByte(t),this.readByte(t+this.yr&255)},this.readZeroPageXIndirect=()=>{const t=this.readBytePC();this.readByte(t);const e=this.readZPWord(t+this.xr&255);return this.readByte(e)},this.readZeroPageIndirectY=()=>{const t=this.readBytePC(),e=this.addr,s=this.readZPWord(t),i=s+this.yr&65535;return this.workCycleIndexedRead(e,s,i),this.readByte(i)},this.readZeroPageIndirect=()=>this.readByte(this.readZPWord(this.readBytePC())),this.writeAbsolute=t=>{this.writeByte(this.readWordPC(),t)},this.writeZeroPage=t=>{this.writeByte(this.readBytePC(),t)},this.writeAbsoluteX=t=>{const e=this.readWordPC(),s=this.addr,i=e+this.xr&65535;this.workCycleIndexedWrite(s,e,i),this.writeByte(i,t)},this.writeAbsoluteY=t=>{const e=this.readWordPC(),s=this.addr,i=e+this.yr&65535;this.workCycleIndexedWrite(s,e,i),this.writeByte(i,t)},this.writeZeroPageX=t=>{const e=this.readBytePC();this.readByte(e),this.writeByte(e+this.xr&255,t)},this.writeZeroPageY=t=>{const e=this.readBytePC();this.readByte(e),this.writeByte(e+this.yr&255,t)},this.writeZeroPageXIndirect=t=>{const e=this.readBytePC();this.readByte(e);const s=this.readZPWord(e+this.xr&255);this.writeByte(s,t)},this.writeZeroPageIndirectY=t=>{const e=this.readBytePC(),s=this.addr,i=this.readZPWord(e),r=i+this.yr&65535;this.workCycleIndexedWrite(s,i,r),this.writeByte(r,t)},this.writeZeroPageIndirect=t=>{this.writeByte(this.readZPWord(this.readBytePC()),t)},this.readAddrZeroPage=()=>this.readBytePC(),this.readAddrZeroPageX=()=>{const t=this.readBytePC();return this.readByte(t),t+this.xr&255},this.readAddrAbsolute=()=>this.readWordPC(),this.readAddrAbsoluteIndirectBug=()=>{const t=this.readWordPC(),e=65280&t,s=255&t,i=this.readByte(t);return this.readByte(e|s+1&255)<<8|i},this.readAddrAbsoluteIndirect=()=>{const t=this.readWord(this.readWordPC());return this.readByte(this.addr),t},this.readAddrAbsoluteX=t=>{let e=this.readWordPC();const s=65280&e;if(e=e+this.xr&65535,this.is65C02)((null==t?void 0:t.inc)||s!==(65280&e))&&this.readByte(this.addr);else{const t=255&e;this.readByte(s|t)}return e},this.readAddrAbsoluteY=()=>{let t=this.readWordPC();const e=65280&t;t=t+this.yr&65535;const s=255&t;return this.readByte(e|s),t},this.readAddrZeroPageXIndirect=()=>{const t=this.readBytePC();return this.readByte(t),this.readZPWord(t+this.xr&255)},this.readAddrZeroPageIndirectY=()=>{const t=this.readBytePC(),e=this.readZPWord(t),s=e+this.yr&65535,i=65280&e,r=255&s;return this.readByte(i|r),s},this.readAddrAbsoluteXIndirect=()=>{const t=this.readBytePC(),e=this.addr,s=(this.readBytePC()<<8|t)+this.xr&65535;return this.readByte(e),this.readWord(s)},this.readNop=()=>{this.readWordPC(),this.readByte(this.addr)},this.readNopImplied=()=>{},this.brk=t=>{t(),this.pushWord(this.pc),this.pushByte(this.sr|Js),this.is65C02&&this.setFlag(8,!1),this.setFlag(4,!0),this.pc=this.readWord(65534)},this.stp=()=>{this.stop=!0,this.readByte(this.pc),this.readByte(this.pc)},this.wai=()=>{this.wait=!0,this.readByte(this.pc),this.readByte(this.pc)},this.lda=t=>{this.ar=this.testNZ(t())},this.ldx=t=>{this.xr=this.testNZ(t())},this.ldy=t=>{this.yr=this.testNZ(t())},this.sta=t=>{t(this.ar)},this.stx=t=>{t(this.xr)},this.sty=t=>{t(this.yr)},this.stz=t=>{t(0)},this.adc=t=>{this.ar=this.add(this.ar,t(),!1)},this.sbc=t=>{this.ar=this.add(this.ar,255^t(),!0)},this.incA=()=>{this.readByte(this.pc),this.ar=this.increment(this.ar)},this.inc=t=>{const e=t({inc:!0}),s=this.readByte(e);this.workCycle(e,s);const i=this.increment(s);this.writeByte(e,i)},this.inx=()=>{this.readByte(this.pc),this.xr=this.increment(this.xr)},this.iny=()=>{this.readByte(this.pc),this.yr=this.increment(this.yr)},this.decA=()=>{this.readByte(this.pc),this.ar=this.decrement(this.ar)},this.dec=t=>{const e=t({inc:!0}),s=this.readByte(e);this.workCycle(e,s);const i=this.decrement(s);this.writeByte(e,i)},this.dex=()=>{this.readByte(this.pc),this.xr=this.decrement(this.xr)},this.dey=()=>{this.readByte(this.pc),this.yr=this.decrement(this.yr)},this.shiftLeft=t=>(this.setFlag(1,!!(128&t)),this.testNZ(t<<1&255)),this.aslA=()=>{this.readByte(this.pc),this.ar=this.shiftLeft(this.ar)},this.asl=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.shiftLeft(s);this.writeByte(e,i)},this.shiftRight=t=>(this.setFlag(1,!!(1&t)),this.testNZ(t>>1)),this.lsrA=()=>{this.readByte(this.pc),this.ar=this.shiftRight(this.ar)},this.lsr=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.shiftRight(s);this.writeByte(e,i)},this.rotateLeft=t=>{const e=1&this.sr;return this.setFlag(1,!!(128&t)),this.testNZ(255&(t<<1|(e?1:0)))},this.rolA=()=>{this.readByte(this.pc),this.ar=this.rotateLeft(this.ar)},this.rol=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.rotateLeft(s);this.writeByte(e,i)},this.rorA=()=>{this.readByte(this.pc),this.ar=this.rotateRight(this.ar)},this.ror=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.rotateRight(s);this.writeByte(e,i)},this.and=t=>{this.ar=this.testNZ(this.ar&t())},this.ora=t=>{this.ar=this.testNZ(this.ar|t())},this.eor=t=>{this.ar=this.testNZ(this.ar^t())},this.rmb=t=>{const e=1<<t^255,s=this.readBytePC();let i=this.readByte(s);this.readByte(s),i&=e,this.writeByte(s,i)},this.smb=t=>{const e=1<<t,s=this.readBytePC();let i=this.readByte(s);this.readByte(s),i|=e,this.writeByte(s,i)},this.trb=t=>{const e=t(),s=this.readByte(e);this.testZ(s&this.ar),this.readByte(e),this.writeByte(e,s&~this.ar)},this.tsb=t=>{const e=t(),s=this.readByte(e);this.testZ(s&this.ar),this.readByte(e),this.writeByte(e,s|this.ar)},this.bit=t=>{const e=t();this.setFlag(2,0==(e&this.ar)),this.setFlag(Vs,!!(128&e)),this.setFlag(Qs,!!(64&e))},this.bitI=t=>{const e=t();this.setFlag(2,0==(e&this.ar))},this.cmp=t=>{this.compare(this.ar,t())},this.cpx=t=>{this.compare(this.xr,t())},this.cpy=t=>{this.compare(this.yr,t())},this.brs=t=>{const e=this.readBytePC();if(0!=(t&this.sr)){this.readByte(this.pc);const t=65280&this.pc;this.pc+=e>127?e-256:e,this.pc&=65535;const s=65280&this.pc,i=255&this.pc;s!==t&&this.readByte(t|i)}},this.brc=t=>{const e=this.readBytePC();if(0==(t&this.sr)){this.readByte(this.pc);const t=65280&this.pc;this.pc+=e>127?e-256:e,this.pc&=65535;const s=65280&this.pc,i=255&this.pc;s!==t&&this.readByte(t|i)}},this.bbr=t=>{const e=this.readBytePC(),s=this.readByte(e);this.writeByte(e,s);const i=this.readBytePC(),r=65280&this.pc;let a=this.pc+(i>127?i-256:i);a&=65535;const n=255&a;this.readByte(r|n),0==(1<<t&s)&&(this.pc=a)},this.bbs=t=>{const e=this.readBytePC(),s=this.readByte(e);this.writeByte(e,s);const i=this.readBytePC(),r=65280&this.pc;let a=this.pc+(i>127?i-256:i);a&=65535;const n=255&a;this.readByte(r|n),0!=(1<<t&s)&&(this.pc=a)},this.tax=()=>{this.readByte(this.pc),this.testNZ(this.xr=this.ar)},this.txa=()=>{this.readByte(this.pc),this.testNZ(this.ar=this.xr)},this.tay=()=>{this.readByte(this.pc),this.testNZ(this.yr=this.ar)},this.tya=()=>{this.readByte(this.pc),this.testNZ(this.ar=this.yr)},this.tsx=()=>{this.readByte(this.pc),this.testNZ(this.xr=this.sp)},this.txs=()=>{this.readByte(this.pc),this.sp=this.xr},this.pha=()=>{this.readByte(this.pc),this.pushByte(this.ar)},this.pla=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.testNZ(this.ar=this.pullByte())},this.phx=()=>{this.readByte(this.pc),this.pushByte(this.xr)},this.plx=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.testNZ(this.xr=this.pullByte())},this.phy=()=>{this.readByte(this.pc),this.pushByte(this.yr)},this.ply=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.testNZ(this.yr=this.pullByte())},this.php=()=>{this.readByte(this.pc),this.pushByte(this.sr|Js)},this.plp=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.sr=-17&this.pullByte()|32},this.jmp=t=>{this.pc=t()},this.jsr=()=>{const t=this.readBytePC();this.readByte(256|this.sp),this.pushWord(this.pc);const e=this.readBytePC();this.pc=65535&(e<<8|t)},this.rts=()=>{this.readByte(this.pc),this.readByte(256|this.sp);const t=this.pullWordRaw();this.readByte(t),this.pc=t+1&65535},this.rti=()=>{this.readByte(this.pc),this.readByte(256|this.sp),this.sr=-17&this.pullByte()|32,this.pc=this.pullWordRaw()},this.set=t=>{this.readByte(this.pc),this.sr|=t},this.clr=t=>{this.readByte(this.pc),this.sr&=~t},this.nop=t=>{t()},this.aso=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.shiftLeft(s);this.writeByte(e,i),this.ar|=i,this.testNZ(this.ar)},this.rla=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.rotateLeft(s);this.writeByte(e,i),this.ar&=i,this.testNZ(this.ar)},this.lse=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.shiftRight(s);this.writeByte(e,i),this.ar^=i,this.testNZ(this.ar)},this.rra=t=>{const e=t(),s=this.readByte(e);this.workCycle(e,s);const i=this.rotateRight(s);this.writeByte(e,i),this.ar=this.add(this.ar,i,!1)},this.axs=t=>{t(this.ar&this.xr)},this.lax=t=>{const e=t();this.ar=e,this.xr=e,this.testNZ(e)},this.dcm=t=>{const e=t({inc:!0}),s=this.readByte(e);this.workCycle(e,s);const i=this.decrement(s);this.writeByte(e,i),this.compare(this.ar,i)},this.ins=t=>{const e=t({inc:!0}),s=this.readByte(e);this.workCycle(e,s);const i=this.increment(s);this.writeByte(e,i),this.ar=this.add(this.ar,255^i,!0)},this.alr=t=>{const e=t()&this.ar;this.ar=this.shiftRight(e)},this.arr=t=>{const e=t()&this.ar,s=e>>4,i=15&e,r=e>>7,a=e>>6&1;this.ar=this.rotateRight(e);let n=!!r;const o=!!(r^a);8&this.sr&&(i+(1&i)>5&&(this.ar=240&this.ar|this.ar+6&15),s+(1&s)>5&&(n=!0,this.ar=this.ar+96&255)),this.setFlag(Qs,o),this.setFlag(1,n)},this.xaa=t=>{const e=t();this.ar=238&this.xr|this.xr&this.ar&17,this.ar=this.testNZ(this.ar&e)},this.oal=t=>{this.ar|=238;const e=this.testNZ(this.ar&t());this.ar=e,this.xr=e},this.sax=t=>{const e=this.xr&this.ar;let s=t();s^=255;const i=e+s+1;this.setFlag(1,i>255),this.xr=this.testNZ(255&i)},this.tas=t=>{const e=t();let s=this.xr&this.ar;this.sp=s,s=s&1+(e>>8)&255,this.writeByte(e,s)},this.say=t=>{const e=t(),s=e>>8,i=this.yr&s+1&255;this.writeByte(e,i)},this.xas=t=>{const e=t(),s=e>>8,i=this.xr&s+1&255;this.writeByte(e,i)},this.axa=t=>{const e=t();let s=this.xr&this.ar;s=s&1+(e>>8)&255,this.writeByte(e,s)},this.anc=t=>{this.ar=this.testNZ(this.ar&t());const e=!!(128&this.ar);this.setFlag(1,e)},this.las=t=>{const e=this.sp&t();this.sp=e,this.xr=e,this.ar=this.testNZ(e)},this.skp=t=>{t()},this.hlt=t=>{this.readByte(this.pc),this.readByte(this.pc),this.pc=65535&--this.pc,this.stop=!0},this.OPS_6502={169:{name:"LDA",fn:()=>this.lda(this.readImmediate),mode:"immediate"},165:{name:"LDA",fn:()=>this.lda(this.readZeroPage),mode:"zeroPage"},181:{name:"LDA",fn:()=>this.lda(this.readZeroPageX),mode:"zeroPageX"},173:{name:"LDA",fn:()=>this.lda(this.readAbsolute),mode:"absolute"},189:{name:"LDA",fn:()=>this.lda(this.readAbsoluteX),mode:"absoluteX"},185:{name:"LDA",fn:()=>this.lda(this.readAbsoluteY),mode:"absoluteY"},161:{name:"LDA",fn:()=>this.lda(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},177:{name:"LDA",fn:()=>this.lda(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},162:{name:"LDX",fn:()=>this.ldx(this.readImmediate),mode:"immediate"},166:{name:"LDX",fn:()=>this.ldx(this.readZeroPage),mode:"zeroPage"},182:{name:"LDX",fn:()=>this.ldx(this.readZeroPageY),mode:"zeroPageY"},174:{name:"LDX",fn:()=>this.ldx(this.readAbsolute),mode:"absolute"},190:{name:"LDX",fn:()=>this.ldx(this.readAbsoluteY),mode:"absoluteY"},160:{name:"LDY",fn:()=>this.ldy(this.readImmediate),mode:"immediate"},164:{name:"LDY",fn:()=>this.ldy(this.readZeroPage),mode:"zeroPage"},180:{name:"LDY",fn:()=>this.ldy(this.readZeroPageX),mode:"zeroPageX"},172:{name:"LDY",fn:()=>this.ldy(this.readAbsolute),mode:"absolute"},188:{name:"LDY",fn:()=>this.ldy(this.readAbsoluteX),mode:"absoluteX"},133:{name:"STA",fn:()=>this.sta(this.writeZeroPage),mode:"zeroPage"},149:{name:"STA",fn:()=>this.sta(this.writeZeroPageX),mode:"zeroPageX"},141:{name:"STA",fn:()=>this.sta(this.writeAbsolute),mode:"absolute"},157:{name:"STA",fn:()=>this.sta(this.writeAbsoluteX),mode:"absoluteX"},153:{name:"STA",fn:()=>this.sta(this.writeAbsoluteY),mode:"absoluteY"},129:{name:"STA",fn:()=>this.sta(this.writeZeroPageXIndirect),mode:"zeroPageXIndirect"},145:{name:"STA",fn:()=>this.sta(this.writeZeroPageIndirectY),mode:"zeroPageIndirectY"},134:{name:"STX",fn:()=>this.stx(this.writeZeroPage),mode:"zeroPage"},150:{name:"STX",fn:()=>this.stx(this.writeZeroPageY),mode:"zeroPageY"},142:{name:"STX",fn:()=>this.stx(this.writeAbsolute),mode:"absolute"},132:{name:"STY",fn:()=>this.sty(this.writeZeroPage),mode:"zeroPage"},148:{name:"STY",fn:()=>this.sty(this.writeZeroPageX),mode:"zeroPageX"},140:{name:"STY",fn:()=>this.sty(this.writeAbsolute),mode:"absolute"},105:{name:"ADC",fn:()=>this.adc(this.readImmediate),mode:"immediate"},101:{name:"ADC",fn:()=>this.adc(this.readZeroPage),mode:"zeroPage"},117:{name:"ADC",fn:()=>this.adc(this.readZeroPageX),mode:"zeroPageX"},109:{name:"ADC",fn:()=>this.adc(this.readAbsolute),mode:"absolute"},125:{name:"ADC",fn:()=>this.adc(this.readAbsoluteX),mode:"absoluteX"},121:{name:"ADC",fn:()=>this.adc(this.readAbsoluteY),mode:"absoluteY"},97:{name:"ADC",fn:()=>this.adc(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},113:{name:"ADC",fn:()=>this.adc(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},233:{name:"SBC",fn:()=>this.sbc(this.readImmediate),mode:"immediate"},229:{name:"SBC",fn:()=>this.sbc(this.readZeroPage),mode:"zeroPage"},245:{name:"SBC",fn:()=>this.sbc(this.readZeroPageX),mode:"zeroPageX"},237:{name:"SBC",fn:()=>this.sbc(this.readAbsolute),mode:"absolute"},253:{name:"SBC",fn:()=>this.sbc(this.readAbsoluteX),mode:"absoluteX"},249:{name:"SBC",fn:()=>this.sbc(this.readAbsoluteY),mode:"absoluteY"},225:{name:"SBC",fn:()=>this.sbc(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},241:{name:"SBC",fn:()=>this.sbc(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},230:{name:"INC",fn:()=>this.inc(this.readAddrZeroPage),mode:"zeroPage"},246:{name:"INC",fn:()=>this.inc(this.readAddrZeroPageX),mode:"zeroPageX"},238:{name:"INC",fn:()=>this.inc(this.readAddrAbsolute),mode:"absolute"},254:{name:"INC",fn:()=>this.inc(this.readAddrAbsoluteX),mode:"absoluteX"},232:{name:"INX",fn:()=>this.inx(),mode:"implied"},200:{name:"INY",fn:()=>this.iny(),mode:"implied"},198:{name:"DEC",fn:()=>this.dec(this.readAddrZeroPage),mode:"zeroPage"},214:{name:"DEC",fn:()=>this.dec(this.readAddrZeroPageX),mode:"zeroPageX"},206:{name:"DEC",fn:()=>this.dec(this.readAddrAbsolute),mode:"absolute"},222:{name:"DEC",fn:()=>this.dec(this.readAddrAbsoluteX),mode:"absoluteX"},202:{name:"DEX",fn:()=>this.dex(),mode:"implied"},136:{name:"DEY",fn:()=>this.dey(),mode:"implied"},10:{name:"ASL",fn:()=>this.aslA(),mode:"accumulator"},6:{name:"ASL",fn:()=>this.asl(this.readAddrZeroPage),mode:"zeroPage"},22:{name:"ASL",fn:()=>this.asl(this.readAddrZeroPageX),mode:"zeroPageX"},14:{name:"ASL",fn:()=>this.asl(this.readAddrAbsolute),mode:"absolute"},30:{name:"ASL",fn:()=>this.asl(this.readAddrAbsoluteX),mode:"absoluteX"},74:{name:"LSR",fn:()=>this.lsrA(),mode:"accumulator"},70:{name:"LSR",fn:()=>this.lsr(this.readAddrZeroPage),mode:"zeroPage"},86:{name:"LSR",fn:()=>this.lsr(this.readAddrZeroPageX),mode:"zeroPageX"},78:{name:"LSR",fn:()=>this.lsr(this.readAddrAbsolute),mode:"absolute"},94:{name:"LSR",fn:()=>this.lsr(this.readAddrAbsoluteX),mode:"absoluteX"},42:{name:"ROL",fn:()=>this.rolA(),mode:"accumulator"},38:{name:"ROL",fn:()=>this.rol(this.readAddrZeroPage),mode:"zeroPage"},54:{name:"ROL",fn:()=>this.rol(this.readAddrZeroPageX),mode:"zeroPageX"},46:{name:"ROL",fn:()=>this.rol(this.readAddrAbsolute),mode:"absolute"},62:{name:"ROL",fn:()=>this.rol(this.readAddrAbsoluteX),mode:"absoluteX"},106:{name:"ROR",fn:()=>this.rorA(),mode:"accumulator"},102:{name:"ROR",fn:()=>this.ror(this.readAddrZeroPage),mode:"zeroPage"},118:{name:"ROR",fn:()=>this.ror(this.readAddrZeroPageX),mode:"zeroPageX"},110:{name:"ROR",fn:()=>this.ror(this.readAddrAbsolute),mode:"absolute"},126:{name:"ROR",fn:()=>this.ror(this.readAddrAbsoluteX),mode:"absoluteX"},41:{name:"AND",fn:()=>this.and(this.readImmediate),mode:"immediate"},37:{name:"AND",fn:()=>this.and(this.readZeroPage),mode:"zeroPage"},53:{name:"AND",fn:()=>this.and(this.readZeroPageX),mode:"zeroPageX"},45:{name:"AND",fn:()=>this.and(this.readAbsolute),mode:"absolute"},61:{name:"AND",fn:()=>this.and(this.readAbsoluteX),mode:"absoluteX"},57:{name:"AND",fn:()=>this.and(this.readAbsoluteY),mode:"absoluteY"},33:{name:"AND",fn:()=>this.and(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},49:{name:"AND",fn:()=>this.and(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},9:{name:"ORA",fn:()=>this.ora(this.readImmediate),mode:"immediate"},5:{name:"ORA",fn:()=>this.ora(this.readZeroPage),mode:"zeroPage"},21:{name:"ORA",fn:()=>this.ora(this.readZeroPageX),mode:"zeroPageX"},13:{name:"ORA",fn:()=>this.ora(this.readAbsolute),mode:"absolute"},29:{name:"ORA",fn:()=>this.ora(this.readAbsoluteX),mode:"absoluteX"},25:{name:"ORA",fn:()=>this.ora(this.readAbsoluteY),mode:"absoluteY"},1:{name:"ORA",fn:()=>this.ora(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},17:{name:"ORA",fn:()=>this.ora(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},73:{name:"EOR",fn:()=>this.eor(this.readImmediate),mode:"immediate"},69:{name:"EOR",fn:()=>this.eor(this.readZeroPage),mode:"zeroPage"},85:{name:"EOR",fn:()=>this.eor(this.readZeroPageX),mode:"zeroPageX"},77:{name:"EOR",fn:()=>this.eor(this.readAbsolute),mode:"absolute"},93:{name:"EOR",fn:()=>this.eor(this.readAbsoluteX),mode:"absoluteX"},89:{name:"EOR",fn:()=>this.eor(this.readAbsoluteY),mode:"absoluteY"},65:{name:"EOR",fn:()=>this.eor(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},81:{name:"EOR",fn:()=>this.eor(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},201:{name:"CMP",fn:()=>this.cmp(this.readImmediate),mode:"immediate"},197:{name:"CMP",fn:()=>this.cmp(this.readZeroPage),mode:"zeroPage"},213:{name:"CMP",fn:()=>this.cmp(this.readZeroPageX),mode:"zeroPageX"},205:{name:"CMP",fn:()=>this.cmp(this.readAbsolute),mode:"absolute"},221:{name:"CMP",fn:()=>this.cmp(this.readAbsoluteX),mode:"absoluteX"},217:{name:"CMP",fn:()=>this.cmp(this.readAbsoluteY),mode:"absoluteY"},193:{name:"CMP",fn:()=>this.cmp(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},209:{name:"CMP",fn:()=>this.cmp(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},224:{name:"CPX",fn:()=>this.cpx(this.readImmediate),mode:"immediate"},228:{name:"CPX",fn:()=>this.cpx(this.readZeroPage),mode:"zeroPage"},236:{name:"CPX",fn:()=>this.cpx(this.readAbsolute),mode:"absolute"},192:{name:"CPY",fn:()=>this.cpy(this.readImmediate),mode:"immediate"},196:{name:"CPY",fn:()=>this.cpy(this.readZeroPage),mode:"zeroPage"},204:{name:"CPY",fn:()=>this.cpy(this.readAbsolute),mode:"absolute"},36:{name:"BIT",fn:()=>this.bit(this.readZeroPage),mode:"zeroPage"},44:{name:"BIT",fn:()=>this.bit(this.readAbsolute),mode:"absolute"},144:{name:"BCC",fn:()=>this.brc(1),mode:"relative"},176:{name:"BCS",fn:()=>this.brs(1),mode:"relative"},240:{name:"BEQ",fn:()=>this.brs(2),mode:"relative"},48:{name:"BMI",fn:()=>this.brs(Vs),mode:"relative"},208:{name:"BNE",fn:()=>this.brc(2),mode:"relative"},16:{name:"BPL",fn:()=>this.brc(Vs),mode:"relative"},80:{name:"BVC",fn:()=>this.brc(Qs),mode:"relative"},112:{name:"BVS",fn:()=>this.brs(Qs),mode:"relative"},170:{name:"TAX",fn:()=>this.tax(),mode:"implied"},138:{name:"TXA",fn:()=>this.txa(),mode:"implied"},168:{name:"TAY",fn:()=>this.tay(),mode:"implied"},152:{name:"TYA",fn:()=>this.tya(),mode:"implied"},186:{name:"TSX",fn:()=>this.tsx(),mode:"implied"},154:{name:"TXS",fn:()=>this.txs(),mode:"implied"},72:{name:"PHA",fn:()=>this.pha(),mode:"implied"},104:{name:"PLA",fn:()=>this.pla(),mode:"implied"},8:{name:"PHP",fn:()=>this.php(),mode:"implied"},40:{name:"PLP",fn:()=>this.plp(),mode:"implied"},76:{name:"JMP",fn:()=>this.jmp(this.readAddrAbsolute),mode:"absolute"},108:{name:"JMP",fn:()=>this.jmp(this.readAddrAbsoluteIndirectBug),mode:"absoluteIndirect"},32:{name:"JSR",fn:()=>this.jsr(),mode:"absolute"},96:{name:"RTS",fn:()=>this.rts(),mode:"implied"},64:{name:"RTI",fn:()=>this.rti(),mode:"implied"},56:{name:"SEC",fn:()=>this.set(1),mode:"implied"},248:{name:"SED",fn:()=>this.set(8),mode:"implied"},120:{name:"SEI",fn:()=>this.set(4),mode:"implied"},24:{name:"CLC",fn:()=>this.clr(1),mode:"implied"},216:{name:"CLD",fn:()=>this.clr(8),mode:"implied"},88:{name:"CLI",fn:()=>this.clr(4),mode:"implied"},184:{name:"CLV",fn:()=>this.clr(Qs),mode:"implied"},234:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},0:{name:"BRK",fn:()=>this.brk(this.readImmediate),mode:"immediate"}},this.OPS_65C02={26:{name:"INC",fn:()=>this.incA(),mode:"accumulator"},58:{name:"DEC",fn:()=>this.decA(),mode:"accumulator"},18:{name:"ORA",fn:()=>this.ora(this.readZeroPageIndirect),mode:"zeroPageIndirect"},50:{name:"AND",fn:()=>this.and(this.readZeroPageIndirect),mode:"zeroPageIndirect"},82:{name:"EOR",fn:()=>this.eor(this.readZeroPageIndirect),mode:"zeroPageIndirect"},114:{name:"ADC",fn:()=>this.adc(this.readZeroPageIndirect),mode:"zeroPageIndirect"},146:{name:"STA",fn:()=>this.sta(this.writeZeroPageIndirect),mode:"zeroPageIndirect"},178:{name:"LDA",fn:()=>this.lda(this.readZeroPageIndirect),mode:"zeroPageIndirect"},210:{name:"CMP",fn:()=>this.cmp(this.readZeroPageIndirect),mode:"zeroPageIndirect"},242:{name:"SBC",fn:()=>this.sbc(this.readZeroPageIndirect),mode:"zeroPageIndirect"},52:{name:"BIT",fn:()=>this.bit(this.readZeroPageX),mode:"zeroPageX"},60:{name:"BIT",fn:()=>this.bit(this.readAbsoluteX),mode:"absoluteX"},137:{name:"BIT",fn:()=>this.bitI(this.readImmediate),mode:"immediate"},108:{name:"JMP",fn:()=>this.jmp(this.readAddrAbsoluteIndirect),mode:"absoluteIndirect"},124:{name:"JMP",fn:()=>this.jmp(this.readAddrAbsoluteXIndirect),mode:"absoluteXIndirect"},15:{name:"BBR0",fn:()=>this.bbr(0),mode:"zeroPage_relative"},31:{name:"BBR1",fn:()=>this.bbr(1),mode:"zeroPage_relative"},47:{name:"BBR2",fn:()=>this.bbr(2),mode:"zeroPage_relative"},63:{name:"BBR3",fn:()=>this.bbr(3),mode:"zeroPage_relative"},79:{name:"BBR4",fn:()=>this.bbr(4),mode:"zeroPage_relative"},95:{name:"BBR5",fn:()=>this.bbr(5),mode:"zeroPage_relative"},111:{name:"BBR6",fn:()=>this.bbr(6),mode:"zeroPage_relative"},127:{name:"BBR7",fn:()=>this.bbr(7),mode:"zeroPage_relative"},143:{name:"BBS0",fn:()=>this.bbs(0),mode:"zeroPage_relative"},159:{name:"BBS1",fn:()=>this.bbs(1),mode:"zeroPage_relative"},175:{name:"BBS2",fn:()=>this.bbs(2),mode:"zeroPage_relative"},191:{name:"BBS3",fn:()=>this.bbs(3),mode:"zeroPage_relative"},207:{name:"BBS4",fn:()=>this.bbs(4),mode:"zeroPage_relative"},223:{name:"BBS5",fn:()=>this.bbs(5),mode:"zeroPage_relative"},239:{name:"BBS6",fn:()=>this.bbs(6),mode:"zeroPage_relative"},255:{name:"BBS7",fn:()=>this.bbs(7),mode:"zeroPage_relative"},128:{name:"BRA",fn:()=>this.brc(0),mode:"relative"},2:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},34:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},66:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},68:{name:"NOP",fn:()=>this.nop(this.readZeroPage),mode:"immediate"},84:{name:"NOP",fn:()=>this.nop(this.readZeroPageX),mode:"immediate"},98:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},130:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},194:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},212:{name:"NOP",fn:()=>this.nop(this.readZeroPageX),mode:"immediate"},226:{name:"NOP",fn:()=>this.nop(this.readImmediate),mode:"immediate"},244:{name:"NOP",fn:()=>this.nop(this.readZeroPageX),mode:"immediate"},92:{name:"NOP",fn:()=>this.nop(this.readNop),mode:"absolute"},220:{name:"NOP",fn:()=>this.nop(this.readNop),mode:"absolute"},252:{name:"NOP",fn:()=>this.nop(this.readNop),mode:"absolute"},218:{name:"PHX",fn:()=>this.phx(),mode:"implied"},90:{name:"PHY",fn:()=>this.phy(),mode:"implied"},250:{name:"PLX",fn:()=>this.plx(),mode:"implied"},122:{name:"PLY",fn:()=>this.ply(),mode:"implied"},7:{name:"RMB0",fn:()=>this.rmb(0),mode:"zeroPage"},23:{name:"RMB1",fn:()=>this.rmb(1),mode:"zeroPage"},39:{name:"RMB2",fn:()=>this.rmb(2),mode:"zeroPage"},55:{name:"RMB3",fn:()=>this.rmb(3),mode:"zeroPage"},71:{name:"RMB4",fn:()=>this.rmb(4),mode:"zeroPage"},87:{name:"RMB5",fn:()=>this.rmb(5),mode:"zeroPage"},103:{name:"RMB6",fn:()=>this.rmb(6),mode:"zeroPage"},119:{name:"RMB7",fn:()=>this.rmb(7),mode:"zeroPage"},135:{name:"SMB0",fn:()=>this.smb(0),mode:"zeroPage"},151:{name:"SMB1",fn:()=>this.smb(1),mode:"zeroPage"},167:{name:"SMB2",fn:()=>this.smb(2),mode:"zeroPage"},183:{name:"SMB3",fn:()=>this.smb(3),mode:"zeroPage"},199:{name:"SMB4",fn:()=>this.smb(4),mode:"zeroPage"},215:{name:"SMB5",fn:()=>this.smb(5),mode:"zeroPage"},231:{name:"SMB6",fn:()=>this.smb(6),mode:"zeroPage"},247:{name:"SMB7",fn:()=>this.smb(7),mode:"zeroPage"},100:{name:"STZ",fn:()=>this.stz(this.writeZeroPage),mode:"zeroPage"},116:{name:"STZ",fn:()=>this.stz(this.writeZeroPageX),mode:"zeroPageX"},156:{name:"STZ",fn:()=>this.stz(this.writeAbsolute),mode:"absolute"},158:{name:"STZ",fn:()=>this.stz(this.writeAbsoluteX),mode:"absoluteX"},20:{name:"TRB",fn:()=>this.trb(this.readAddrZeroPage),mode:"zeroPage"},28:{name:"TRB",fn:()=>this.trb(this.readAddrAbsolute),mode:"absolute"},4:{name:"TSB",fn:()=>this.tsb(this.readAddrZeroPage),mode:"zeroPage"},12:{name:"TSB",fn:()=>this.tsb(this.readAddrAbsolute),mode:"absolute"}},this.OPS_NMOS_6502={15:{name:"ASO",fn:()=>this.aso(this.readAddrAbsolute),mode:"absolute"},31:{name:"ASO",fn:()=>this.aso(this.readAddrAbsoluteX),mode:"absoluteX"},27:{name:"ASO",fn:()=>this.aso(this.readAddrAbsoluteY),mode:"absoluteY"},7:{name:"ASO",fn:()=>this.aso(this.readAddrZeroPage),mode:"zeroPage"},23:{name:"ASO",fn:()=>this.aso(this.readAddrZeroPageX),mode:"zeroPageX"},3:{name:"ASO",fn:()=>this.aso(this.readAddrZeroPageXIndirect),mode:"zeroPageXIndirect"},19:{name:"ASO",fn:()=>this.aso(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},47:{name:"RLA",fn:()=>this.rla(this.readAddrAbsolute),mode:"absolute"},63:{name:"RLA",fn:()=>this.rla(this.readAddrAbsoluteX),mode:"absoluteX"},59:{name:"RLA",fn:()=>this.rla(this.readAddrAbsoluteY),mode:"absoluteY"},39:{name:"RLA",fn:()=>this.rla(this.readAddrZeroPage),mode:"zeroPage"},55:{name:"RLA",fn:()=>this.rla(this.readAddrZeroPageX),mode:"zeroPageX"},35:{name:"RLA",fn:()=>this.rla(this.readAddrZeroPageXIndirect),mode:"zeroPageXIndirect"},51:{name:"RLA",fn:()=>this.rla(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},79:{name:"LSE",fn:()=>this.lse(this.readAddrAbsolute),mode:"absolute"},95:{name:"LSE",fn:()=>this.lse(this.readAddrAbsoluteX),mode:"absoluteX"},91:{name:"LSE",fn:()=>this.lse(this.readAddrAbsoluteY),mode:"absoluteY"},71:{name:"LSE",fn:()=>this.lse(this.readAddrZeroPage),mode:"zeroPage"},87:{name:"LSE",fn:()=>this.lse(this.readAddrZeroPageX),mode:"zeroPageX"},67:{name:"LSE",fn:()=>this.lse(this.readAddrZeroPageXIndirect),mode:"zeroPageXIndirect"},83:{name:"LSE",fn:()=>this.lse(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},111:{name:"RRA",fn:()=>this.rra(this.readAddrAbsolute),mode:"absolute"},127:{name:"RRA",fn:()=>this.rra(this.readAddrAbsoluteX),mode:"absoluteX"},123:{name:"RRA",fn:()=>this.rra(this.readAddrAbsoluteY),mode:"absoluteY"},103:{name:"RRA",fn:()=>this.rra(this.readAddrZeroPage),mode:"zeroPage"},119:{name:"RRA",fn:()=>this.rra(this.readAddrZeroPageX),mode:"zeroPageX"},99:{name:"RRA",fn:()=>this.rra(this.readAddrZeroPageXIndirect),mode:"zeroPageXIndirect"},115:{name:"RRA",fn:()=>this.rra(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},143:{name:"AXS",fn:()=>this.axs(this.writeAbsolute),mode:"absolute"},135:{name:"AXS",fn:()=>this.axs(this.writeZeroPage),mode:"zeroPage"},151:{name:"AXS",fn:()=>this.axs(this.writeZeroPageY),mode:"zeroPageY"},131:{name:"AXS",fn:()=>this.axs(this.writeZeroPageXIndirect),mode:"zeroPageXIndirect"},175:{name:"LAX",fn:()=>this.lax(this.readAbsolute),mode:"absolute"},191:{name:"LAX",fn:()=>this.lax(this.readAbsoluteY),mode:"absoluteY"},167:{name:"LAX",fn:()=>this.lax(this.readZeroPage),mode:"zeroPage"},183:{name:"LAX",fn:()=>this.lax(this.readZeroPageY),mode:"zeroPageY"},163:{name:"LAX",fn:()=>this.lax(this.readZeroPageXIndirect),mode:"zeroPageXIndirect"},179:{name:"LAX",fn:()=>this.lax(this.readZeroPageIndirectY),mode:"zeroPageIndirectY"},207:{name:"DCM",fn:()=>this.dcm(this.readAddrAbsolute),mode:"absolute"},223:{name:"DCM",fn:()=>this.dcm(this.readAddrAbsoluteX),mode:"absoluteX"},219:{name:"DCM",fn:()=>this.dcm(this.readAddrAbsoluteY),mode:"absoluteY"},199:{name:"DCM",fn:()=>this.dcm(this.readAddrZeroPage),mode:"zeroPage"},215:{name:"DCM",fn:()=>this.dcm(this.readAddrZeroPageX),mode:"zeroPageX"},195:{name:"DCM",fn:()=>this.dcm(this.readAddrZeroPageXIndirect),mode:"zeroPageXIndirect"},211:{name:"DCM",fn:()=>this.dcm(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},239:{name:"INS",fn:()=>this.ins(this.readAddrAbsolute),mode:"absolute"},255:{name:"INS",fn:()=>this.ins(this.readAddrAbsoluteX),mode:"absoluteX"},251:{name:"INS",fn:()=>this.ins(this.readAddrAbsoluteY),mode:"absoluteY"},231:{name:"INS",fn:()=>this.ins(this.readAddrZeroPage),mode:"zeroPage"},247:{name:"INS",fn:()=>this.ins(this.readAddrZeroPageX),mode:"zeroPageX"},227:{name:"INS",fn:()=>this.ins(this.readAddrZeroPageXIndirect),mode:"zeroPageXIndirect"},243:{name:"INS",fn:()=>this.ins(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},75:{name:"ALR",fn:()=>this.alr(this.readImmediate),mode:"immediate"},107:{name:"ARR",fn:()=>this.arr(this.readImmediate),mode:"immediate"},139:{name:"XAA",fn:()=>this.xaa(this.readImmediate),mode:"immediate"},171:{name:"OAL",fn:()=>this.oal(this.readImmediate),mode:"immediate"},203:{name:"SAX",fn:()=>this.sax(this.readImmediate),mode:"immediate"},26:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},58:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},90:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},122:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},218:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},250:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},128:{name:"SKB",fn:()=>this.skp(this.readImmediate),mode:"immediate"},130:{name:"SKB",fn:()=>this.skp(this.readImmediate),mode:"immediate"},137:{name:"SKB",fn:()=>this.skp(this.readImmediate),mode:"immediate"},194:{name:"SKB",fn:()=>this.skp(this.readImmediate),mode:"immediate"},226:{name:"SKB",fn:()=>this.skp(this.readImmediate),mode:"immediate"},4:{name:"SKB",fn:()=>this.skp(this.readZeroPage),mode:"zeroPage"},20:{name:"SKB",fn:()=>this.skp(this.readZeroPageX),mode:"zeroPageX"},52:{name:"SKB",fn:()=>this.skp(this.readZeroPageX),mode:"zeroPageX"},68:{name:"SKB",fn:()=>this.skp(this.readZeroPage),mode:"zeroPage"},84:{name:"SKB",fn:()=>this.skp(this.readZeroPageX),mode:"zeroPageX"},100:{name:"SKB",fn:()=>this.skp(this.readZeroPage),mode:"zeroPage"},116:{name:"SKB",fn:()=>this.skp(this.readZeroPageX),mode:"zeroPageX"},212:{name:"SKB",fn:()=>this.skp(this.readZeroPageX),mode:"zeroPageX"},244:{name:"SKB",fn:()=>this.skp(this.readZeroPageX),mode:"zeroPageX"},12:{name:"SKW",fn:()=>this.skp(this.readAddrAbsolute),mode:"absolute"},28:{name:"SKW",fn:()=>this.skp(this.readAddrAbsoluteX),mode:"absoluteX"},60:{name:"SKW",fn:()=>this.skp(this.readAddrAbsoluteX),mode:"absoluteX"},92:{name:"SKW",fn:()=>this.skp(this.readAddrAbsoluteX),mode:"absoluteX"},124:{name:"SKW",fn:()=>this.skp(this.readAddrAbsoluteX),mode:"absoluteX"},220:{name:"SKW",fn:()=>this.skp(this.readAddrAbsoluteX),mode:"absoluteX"},252:{name:"SKW",fn:()=>this.skp(this.readAddrAbsoluteX),mode:"absoluteX"},2:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},18:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},34:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},50:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},66:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},82:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},98:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},114:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},146:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},178:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},210:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},242:{name:"HLT",fn:()=>this.hlt(this.readNopImplied),mode:"implied"},155:{name:"TAS",fn:()=>this.tas(this.readAddrAbsoluteY),mode:"absoluteY"},156:{name:"SAY",fn:()=>this.say(this.readAddrAbsoluteX),mode:"absoluteX"},158:{name:"XAS",fn:()=>this.xas(this.readAddrAbsoluteY),mode:"absoluteY"},159:{name:"AXA",fn:()=>this.axa(this.readAddrAbsoluteY),mode:"absoluteY"},147:{name:"AXA",fn:()=>this.axa(this.readAddrZeroPageIndirectY),mode:"zeroPageIndirectY"},43:{name:"ANC",fn:()=>this.anc(this.readImmediate),mode:"immediate"},11:{name:"ANC",fn:()=>this.anc(this.readImmediate),mode:"immediate"},187:{name:"LAS",fn:()=>this.las(this.readAbsoluteY),mode:"absoluteY"},235:{name:"SBC",fn:()=>this.sbc(this.readImmediate),mode:"immediate"}},this.OPS_ROCKWELL_65C02={203:{name:"NOP",fn:()=>this.nop(this.implied),mode:"implied"},219:{name:"NOP",fn:()=>this.nop(this.readZeroPageX),mode:"immediate"}},this.OPS_WDC_65C02={203:{name:"WAI",fn:()=>this.wai(),mode:"implied"},219:{name:"STP",fn:()=>this.stp(),mode:"implied"}},this.flavor=null!=t?t:Ys,this.is65C02=!!t&&js.includes(t),this.memPages.fill($s),this.memPages.fill($s);let e=Object.assign({},this.OPS_6502);switch(this.flavor){case Ks:e=Object.assign(Object.assign(Object.assign({},e),this.OPS_65C02),this.OPS_WDC_65C02);break;case Ws:e=Object.assign(Object.assign(Object.assign({},e),this.OPS_65C02),this.OPS_ROCKWELL_65C02);break;default:e=Object.assign(Object.assign({},e),this.OPS_NMOS_6502)}this.opary=new Array(256);for(let t=0;t<256;t++)this.opary[t]=e[t]||this.unknown(t)}setFlag(t,e){this.sr=e?this.sr|t:this.sr&~t}testNZ(t){return this.sr=0===t?2|this.sr:-3&this.sr,this.sr=128&t?this.sr|Vs:-129&this.sr,t}testZ(t){return this.sr=0===t?2|this.sr:-3&this.sr,t}add(t,e,s){const i=t>>7,r=e>>7,a=1&this.sr;let n,o,h,d,c;const l=s=>{d=(255&s)>>7,o=s>>8,c=!(t+e+a&255),h=i^r^d^o};return n=(15&t)+(15&e)+a,0!=(8&this.sr)?(s?(n<16&&(n=n-6&15),n+=(240&t)+(240&e),l(n),n<256&&(n+=160)):(n>9&&(n=16+(n+6&15)),n+=(240&t)+(240&e),l(n),n>=160&&(n+=96)),(t=>{if(this.is65C02){const e=255&t;d=e>>7,c=!e,"immediate"===this.op.mode?this.flavor===Ks?this.readByte(s?184:127):this.readByte(s?177:89):this.readByte(this.addr)}s||(o=t>>8)})(n)):(n+=(240&t)+(240&e),l(n)),n&=255,this.setFlag(Vs,!!d),this.setFlag(Qs,!!h),this.setFlag(2,!!c),this.setFlag(1,!!o),n}increment(t){return this.testNZ(t+1&255)}decrement(t){return this.testNZ(t+255&255)}readBytePC(){const t=this.readByte(this.pc);return this.pc=this.pc+1&65535,t}readByte(t){this.addr=t;const e=t>>8,s=255&t,i=this.memPages[e].read(e,s);return this.cycles++,i}writeByte(t,e){this.addr=t;const s=t>>8,i=255&t;this.memPages[s].write(s,i,e),this.cycles++}readWord(t){return this.readByte(t)|this.readByte(t+1)<<8}readWordPC(){return this.readBytePC()|this.readBytePC()<<8}readZPWord(t){const e=this.readByte(255&t);return this.readByte(t+1&255)<<8|e}pushByte(t){this.writeByte(256|this.sp,t),this.sp=this.sp+255&255}pushWord(t){this.pushByte(t>>8),this.pushByte(255&t)}pullByte(){return this.sp=this.sp+1&255,this.readByte(256|this.sp)}pullWordRaw(){const t=this.pullByte();return this.pullByte()<<8|t}workCycle(t,e){this.is65C02?this.readByte(t):this.writeByte(t,e)}workCycleIndexedWrite(t,e,s){const i=65280&e;if(this.is65C02)this.readByte(t);else{const t=255&s;this.readByte(i|t)}}workCycleIndexedRead(t,e,s){const i=65280&e;if((65280&s)!==i)if(this.is65C02)this.readByte(t);else{const t=255&s;this.readByte(i|t)}}rotateRight(t){const e=1&this.sr;return this.setFlag(1,!!(1&t)),this.testNZ(t>>1|(e?128:0))}compare(t,e){const s=t+(e^=255)+1;this.setFlag(1,s>255),this.testNZ(255&s)}unknown(t){let e;if(!this.is65C02)throw new Error(`Missing ${C(t)}`);return e={name:"NOP",fn:()=>this.nop(this.readNopImplied),mode:"implied"},e}step(t){this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.fn(),null==t||t(this)}stepN(t,e){for(let s=0;s<t;s++)if(this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.fn(),null==e?void 0:e(this))return}stepCycles(t){const e=this.cycles+t;for(;this.cycles<e;)this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.fn()}stepCyclesDebug(t,e){const s=this.cycles+t;for(;this.cycles<s;)if(this.sync=!0,this.op=this.opary[this.readBytePC()],this.sync=!1,this.op.fn(),null==e?void 0:e(this))return}addPageHandler(t){for(let e=t.start();e<=t.end();e++)this.memPages[e]=t;void 0!==t.reset&&this.resetHandlers.push(t)}reset(){this.sr=32,this.sp=255,this.ar=0,this.yr=0,this.xr=0,this.pc=this.readWord(65532),this.wait=!1,this.stop=!1;for(let t=0;t<this.resetHandlers.length;t++)this.resetHandlers[t].reset()}irq(){0==(4&this.sr)&&(this.pushWord(this.pc),this.pushByte(-17&this.sr),this.is65C02&&this.setFlag(8,!1),this.setFlag(4,!0),this.pc=this.readWord(65534),this.wait=!1)}nmi(){this.pushWord(this.pc),this.pushByte(-17&this.sr),this.is65C02&&this.setFlag(8,!1),this.setFlag(4,!0),this.pc=this.readWord(65530),this.wait=!1}getPC(){return this.pc}setPC(t){this.pc=t}getDebugInfo(){const t=this.read(this.pc),e=this.opary[t],s=qs[e.mode],i=new Array(s);i[0]=t;for(let t=1;t<s;t++)i[t]=this.read(this.pc+t);return{pc:this.pc,ar:this.ar,xr:this.xr,yr:this.yr,sr:this.sr,sp:this.sp,cmd:i}}getSync(){return this.sync}getStop(){return this.stop}getWait(){return this.wait}getCycles(){return this.cycles}getOpInfo(t){return this.opary[t]}getState(){return{a:this.ar,x:this.xr,y:this.yr,s:this.sr,pc:this.pc,sp:this.sp,cycles:this.cycles}}setState(t){this.ar=t.a,this.xr=t.x,this.yr=t.y,this.sr=t.s,this.pc=t.pc,this.sp=t.sp,this.cycles=t.cycles}read(t,e){let s,i;return void 0!==e?(s=255&t,i=255&e):(s=t>>8&255,i=255&t),this.memPages[s].read(s,i)}write(t,e,s){let i,r,a;void 0!==s?(i=255&t,r=255&e,a=255&s):(i=t>>8&255,r=255&t,a=255&e),this.memPages[i].write(i,r,a)}}const ei="SMARTPORT.J.S";class si{constructor(t,e,s){this.cpu=t,void 0===s?(this.lo=255&e,this.hi=e>>8):(this.lo=e,this.hi=s)}loByte(){return this.lo}hiByte(){return this.hi}inc(t){return new si(this.cpu,(this.hi<<8|this.lo)+t&65535)}readByte(){return this.cpu.read(this.hi,this.lo)}readWord(){const t=this.readByte();return this.inc(1).readByte()<<8|t}readAddress(){const t=this.readByte(),e=this.inc(1).readByte();return new si(this.cpu,t,e)}writeByte(t){this.cpu.write(this.hi,this.lo,t)}writeWord(t){this.writeByte(255&t),this.inc(1).writeByte(t>>8)}writeAddress(t){this.writeByte(t.loByte()),this.inc(1).writeByte(t.hiByte())}toString(){return"$"+C(this.hi)+C(this.lo)}}class ii{constructor(t,e,s){if(this.cpu=t,this.callbacks=e,this.disks=[],this.busy=[],this.busyTimeout=[],this.ext=[],this.metadata=[],null==s?void 0:s.block){const t=new Uint8Array(Zs);t[7]=60,this.rom=t,P("DumbPort card")}else P("SmartPort card"),this.rom=Zs}debug(...t){}driveLight(t){var e;this.busy[t]||(this.busy[t]=!0,null===(e=this.callbacks)||void 0===e||e.driveLight(t,!0)),clearTimeout(this.busyTimeout[t]),this.busyTimeout[t]=setTimeout((()=>{var e;this.busy[t]=!1,null===(e=this.callbacks)||void 0===e||e.driveLight(t,!1)}),100)}dumpBlock(t,e){let s,i,r="";for(let a=0;a<32;a++){for(r+=C(a<<4,4)+": ",i=0;i<16;i++)s=this.disks[t].blocks[e][16*a+i],8===i&&(r+=" "),r+=C(s)+" ";for(r+="        ",i=0;i<16;i++)s=127&this.disks[t].blocks[e][16*a+i],8===i&&(r+=" "),r+=s>=32&&s<127?String.fromCharCode(s):".";r+="\n"}return r}getDeviceInfo(t,e){if(this.disks[e]){const s=this.disks[e].blocks.length;t.x=255&s,t.y=s>>8,t.a=0,t.s&=-2}else t.a=40,t.s|=1}readBlock(t,e,s,i){var r;if(this.debug(`read drive=${e}`),this.debug(`read buffer=${i.toString()}`),this.debug(`read block=$${C(s)}`),!(null===(r=this.disks[e])||void 0===r?void 0:r.blocks.length))return P("Drive",e,"is empty"),t.a=47,void(t.s|=1);this.driveLight(e);for(let t=0;t<512;t++)i.writeByte(this.disks[e].blocks[s][t]),i=i.inc(1);t.a=0,t.s&=-2}writeBlock(t,e,s,i){var r;if(this.debug(`write drive=${e}`),this.debug(`write buffer=${i.toString()}`),this.debug(`write block=$${C(s)}`),!(null===(r=this.disks[e])||void 0===r?void 0:r.blocks.length))return P("Drive",e,"is empty"),t.a=47,void(t.s|=1);if(this.disks[e].readOnly)return P("Drive",e,"is write protected"),t.a=43,void(t.s|=1);this.driveLight(e);for(let t=0;t<512;t++)this.disks[e].blocks[s][t]=i.readByte(),i=i.inc(1);t.a=0,t.s&=-2}formatDevice(t,e){var s;if(!(null===(s=this.disks[e])||void 0===s?void 0:s.blocks.length))return P("Drive",e,"is empty"),t.a=47,void(t.s|=1);if(this.disks[e].readOnly)return P("Drive",e,"is write protected"),t.a=43,void(t.s|=1);for(let t=0;t<this.disks[e].blocks.length;t++){this.disks[e].blocks[t]=new Uint8Array;for(let s=0;s<512;s++)this.disks[e].blocks[t][s]=0}t.a=0,t.s&=1}access(t,e){let s;if(128==(143&t)&&void 0===e){s=0;for(let t=0;t<this.disks.length;t++)s<<=1,this.disks[t]&&(s|=1)}return s}ioSwitch(t,e){return this.access(t,e)}read(t,e){var s,i,r,a;const n=this.cpu.getState();let o,h,d,c;const l=this.rom[255],m=l+3;if(e===l&&this.cpu.getSync()){this.debug("block device entry"),o=this.cpu.read(0,66),h=this.cpu.read(0,67);const t=new si(this.cpu,68),e=new si(this.cpu,70),s=128&h?2:1,i=(112&h)>>4;switch(d=t.readAddress(),c=e.readWord(),this.debug(`cmd=${o}`),this.debug("unit=$"+C(h)),this.debug(`slot=${i} drive=${s}`),this.debug(`buffer=${d.toString()} block=$${C(c)}`),o){case 0:this.getDeviceInfo(n,s);break;case 1:this.readBlock(n,s,c,d);break;case 2:this.writeBlock(n,s,c,d);break;case 3:this.formatDevice(n,s)}}else if(e===m&&this.cpu.getSync()){this.debug("smartport entry");const t=new si(this.cpu,n.sp+1,1);let e;const l=t.readAddress();this.debug(`return=${l.toString()}`);const m=l.inc(1);o=m.readByte();const u=m.inc(1).readAddress();this.debug(`cmd=${o}`),this.debug(`cmdListAddr=${u.toString()}`),t.writeAddress(l.inc(3));const f=u.readByte();h=u.inc(1).readByte();const g=h?2:1;let p;switch(d=u.inc(2).readAddress(),this.debug(`parameterCount=${f}`),o){case 0:if(p=u.inc(4).readByte(),this.debug(`info unit=${h}`),this.debug(`info buffer=${d.toString()}`),this.debug(`info status=${p}`),0===h)0===p&&(d.writeByte(2),d.inc(1).writeByte(64),d.inc(2).writeByte(2),d.inc(3).writeByte(0),d.inc(4).writeByte(0),d.inc(5).writeByte(0),d.inc(6).writeByte(0),d.inc(7).writeByte(0),n.x=8,n.y=0,n.a=0,n.s&=-2);else switch(p){case 0:e=null!==(i=null===(s=this.disks[h])||void 0===s?void 0:s.blocks.length)&&void 0!==i?i:0,d.writeByte(240),d.inc(1).writeByte(255&e),d.inc(2).writeByte((65280&e)>>8),d.inc(3).writeByte((16711680&e)>>16),n.x=4,n.y=0,n.a=0,n.s&=-2;break;case 3:e=null!==(a=null===(r=this.disks[h])||void 0===r?void 0:r.blocks.length)&&void 0!==a?a:0,d.writeByte(240),d.inc(1).writeByte(255&e),d.inc(2).writeByte((65280&e)>>8),d.inc(3).writeByte((16711680&e)>>16),d.inc(4).writeByte(ei.length);for(let t=0;t<ei.length;t++)d.inc(5+t).writeByte(ei.charCodeAt(t));d.inc(21).writeByte(7),d.inc(22).writeByte(0),d.inc(23).writeWord(257),n.x=24,n.y=0,n.a=0,n.s&=-2}n.a=0,n.s&=-2;break;case 1:c=u.inc(4).readWord(),this.readBlock(n,g,c,d);break;case 2:c=u.inc(4).readWord(),this.writeBlock(n,g,c,d);break;case 3:this.formatDevice(n,g)}}return this.cpu.setState(n),this.rom[e]}write(){}getState(){return{disks:this.disks.map((t=>({blocks:t.blocks.map((t=>new Uint8Array(t))),encoding:B,format:t.format,readOnly:t.readOnly,metadata:Object.assign({},t.metadata)})))}}setState(t){this.disks=t.disks.map((t=>({blocks:t.blocks.map((t=>new Uint8Array(t))),encoding:B,format:t.format,readOnly:t.readOnly,metadata:Object.assign({},t.metadata)})))}setBinary(t,e,s,i){var r;let a=254,n=!1;if("2mg"===s){const e=gs(i);this.metadata[t]=e;const{bytes:s,offset:r}=e;a=e.volume,n=e.readOnly,i=i.slice(r,r+s)}else this.metadata[t]=null;const o={rawData:i,name:e,readOnly:n,volume:a};return this.ext[t]=s,this.disks[t]=function(t,e){const{rawData:s,readOnly:i,name:r}=e;if(!s)throw new Error("Requires rawData");const a=[];let n=0;for(;n<s.byteLength;)a.push(new Uint8Array(s.slice(n,n+512))),n+=512;return{encoding:B,format:t,blocks:a,metadata:{name:r},readOnly:i}}(s,o),null===(r=this.callbacks)||void 0===r||r.label(t,e),!0}getBinary(t){if(!this.disks[t])return null;const e=this.disks[t],s=this.ext[t],{readOnly:i}=e,{name:r}=e.metadata;let a;if("2mg"===s)a=((t,{blocks:e})=>{const{prefix:s,suffix:i}=((t,{blocks:e})=>{if(t||(t={bytes:512*e,creator:"A2JS",format:fs.ProDOS,offset:64,readOnly:!1,volume:0}),t.format!==fs.ProDOS)throw new Error("Nibble formats not supported yet");if(t.bytes!==512*e)throw new Error("Byte count does not match block count");const s=new Uint8Array(64),i=new DataView(s.buffer),r=(t.volume?t.volume|us.VOLUME_VALID:0)|(t.readOnly?us.READ_ONLY:0),a=s.length,n=512*e;let o=0,h=0,d=new Uint8Array(0);t.comment&&(d=(new TextEncoder).encode(t.comment),o=a+n,h=d.length);let c=0,l=0,m=new Uint8Array(0);t.creatorData&&(m=new Uint8Array(t.creatorData),c=a+n+h,l=t.creatorData.length);const u=new TextEncoder;s.set(u.encode("2IMG"),ms.SIGNATURE),s.set(u.encode(t.creator.slice(0,4)),ms.CREATOR),i.setInt32(ms.HEADER_LENGTH,64,!0),i.setInt16(ms.VERSION,1,!0),i.setInt32(ms.FORMAT,t.format,!0),i.setInt32(ms.FLAGS,r,!0),i.setInt32(ms.BLOCKS,e,!0),i.setInt32(ms.DATA_OFFSET,a,!0),i.setInt32(ms.DATA_LENGTH,n,!0),i.setInt32(ms.COMMENT,o,!0),i.setInt32(ms.COMMENT_LENGTH,h,!0),i.setInt32(ms.CREATOR_DATA,c,!0),i.setInt32(ms.CREATOR_DATA_LENGTH,l,!0);const f=new Uint8Array(h+l);return f.set(d),f.set(m,h),{prefix:s,suffix:f}})(t,{blocks:e.length}),r=s.length+512*e.length+i.length,a=new Uint8Array(r);a.set(s);for(let t=0;t<e.length;t++)a.set(e[t],s.length+512*t);return a.set(i,s.length+512*e.length),a.buffer})(this.metadata[t],e);else{const{blocks:t}=e,s=new Uint8Array(512*t.length);for(let e=0;e<t.length;e++)s.set(t[e],512*e);a=s.buffer}return{metadata:{name:r},ext:s,data:a,readOnly:i}}}const ri=new Uint8Array([8,120,40,44,88,255,112,5,56,176,1,24,184,8,120,72,138,72,152,72,173,255,207,32,26,200,104,104,186,141,248,7,10,10,10,10,141,120,7,104,104,104,168,104,154,9,4,72,40,152,172,120,7,174,248,7,41,127,72,80,14,184,165,54,208,4,228,55,240,10,169,8,133,56,56,144,22,76,80,201,169,11,133,54,169,94,157,184,4,169,10,157,56,4,169,0,157,56,5,104,201,37,240,92,201,38,240,88,201,60,240,84,201,62,240,80,201,35,240,76,201,94,240,90,201,33,240,74,201,42,240,82,162,32,201,44,240,82,162,40,201,46,240,76,162,48,201,47,240,70,174,248,7,72,189,184,4,201,33,240,65,201,94,240,14,104,41,31,10,56,233,1,157,56,4,169,94,208,35,104,56,233,65,48,32,201,22,16,28,170,189,141,203,76,4,203,157,56,5,76,47,201,169,32,32,183,202,169,8,32,183,202,169,33,157,184,4,76,47,201,138,32,183,202,208,247,104,201,13,240,19,201,32,240,68,41,15,32,207,202,240,2,169,10,157,56,7,24,144,53,32,207,202,125,56,7,72,169,9,157,56,6,32,207,202,72,222,56,6,208,247,169,10,157,56,6,104,32,207,202,222,56,6,208,247,169,16,32,183,202,208,178,186,104,104,152,72,104,104,169,141,72,154,174,248,7,172,120,7,189,184,3,221,56,7,208,12,29,56,7,240,7,201,64,208,3,153,128,192,104,168,104,170,104,40,96,104,169,24,32,183,202,169,8,32,183,202,169,9,157,56,6,32,207,202,201,10,48,2,169,0,72,222,56,6,208,241,32,207,202,201,13,48,2,169,0,72,189,56,5,240,4,201,35,208,94,160,0,104,201,10,48,4,200,56,233,10,72,152,162,0,32,166,202,104,32,166,202,172,248,7,185,56,5,208,42,169,175,32,168,202,104,160,4,104,32,166,202,104,32,166,202,136,240,7,169,59,32,168,202,208,238,169,160,141,5,2,185,243,203,240,25,32,168,202,200,208,245,169,0,72,160,5,32,175,202,104,32,166,202,104,32,166,202,136,208,242,76,154,202,104,170,104,10,10,168,138,10,10,72,174,248,7,189,56,5,162,160,201,60,176,2,162,162,138,162,0,32,168,202,185,163,203,200,32,168,202,201,160,208,245,104,168,185,191,203,200,32,168,202,201,160,208,245,104,32,164,202,104,32,166,202,32,179,202,160,3,104,32,164,202,208,3,32,166,202,104,32,166,202,136,240,9,169,186,32,168,202,104,76,41,202,172,248,7,185,56,5,201,37,240,4,201,62,208,80,160,65,173,12,2,201,160,208,2,169,48,10,10,10,10,141,32,2,173,13,2,41,15,13,32,2,201,18,48,2,160,80,201,0,208,4,169,18,208,9,201,19,48,22,248,56,233,18,216,162,12,72,32,255,202,41,15,32,164,202,104,41,15,32,166,202,162,20,32,179,202,152,32,168,202,169,77,32,168,202,138,168,169,141,32,168,202,76,36,201,240,13,9,48,9,128,157,0,2,232,96,169,172,208,245,169,160,208,241,153,128,192,9,4,153,128,192,32,199,202,73,4,153,128,192,32,202,202,72,72,104,104,96,72,169,4,157,184,6,169,0,157,184,5,185,128,192,10,126,184,5,104,72,41,1,153,128,192,9,2,153,128,192,73,2,153,128,192,104,106,72,222,184,6,208,224,104,189,184,5,24,106,106,106,106,96,72,174,248,7,189,56,4,157,184,6,32,80,203,104,72,32,76,203,104,72,73,248,32,76,203,162,160,32,105,203,162,160,32,105,203,160,24,32,96,203,174,248,7,222,184,6,208,218,104,160,188,202,208,253,136,208,250,76,47,201,72,144,5,32,80,203,240,3,32,89,203,104,10,208,241,96,162,80,32,105,203,160,40,208,7,162,24,32,105,203,160,68,162,19,202,208,253,136,208,248,96,172,120,7,169,32,153,128,192,234,234,234,73,32,153,128,192,234,234,234,73,32,153,128,192,234,234,234,73,32,153,128,192,202,208,224,96,100,228,36,164,20,148,84,212,116,244,52,180,4,132,68,196,44,60,92,76,28,12,83,85,78,32,77,79,78,32,84,85,69,32,87,69,68,32,84,72,85,32,70,82,73,32,83,65,84,32,69,82,82,32,74,65,78,32,70,69,66,32,77,65,82,32,65,80,82,32,77,65,89,32,74,85,78,32,74,85,76,32,65,85,71,32,83,69,80,32,79,67,84,32,78,79,86,32,68,69,67,32,174,176,176,176,0,174,176,176,176,0,160,160,193,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]);class ai{constructor(){this.clock=!1,this.strobe=!1,this.shiftMode=!1,this.register=0,this.bits=[],this.command=0,P("Thunderclock")}debug(...t){}calcBits(){const t=t=>{for(let e=0;e<4;e++)this.bits.push(0!=(8&t)),t<<=1},e=e=>{t(Math.floor(e/10)),t(e%10)},s=new Date,i=s.getDate(),r=s.getDay(),a=s.getMonth()+1,n=s.getHours(),o=s.getMinutes(),h=s.getSeconds();this.bits=[],t(a),t(r),e(i),e(n),e(o),e(h)}shift(){this.shiftMode&&(this.bits.pop()?(this.debug("shifting 1"),this.register|=128):(this.debug("shifting 0"),this.register&=127))}access(t,e){if(128==(143&t)&&void 0!==e){const t=!!(4&e);if(t!==this.strobe&&(this.debug("strobe",this.strobe?"high":"low"),t))switch(this.command=24&e,this.command){case 24:this.debug("TIMED"),this.calcBits();break;case 8:this.debug("REGSHIFT"),this.shiftMode=!0,this.shift();break;case 0:this.debug("REGHOLD"),this.shiftMode=!1;break;default:this.debug("Unknown command",C(this.command))}const s=!!(2&e);s!==this.clock&&(this.clock=s,this.debug("clock",this.clock?"high":"low"),s&&this.shift())}return this.register}read(t,e){let s;return s=t<200?ri[e]:ri[t-200<<8|e],s}write(){}ioSwitch(t,e){return this.access(t,e)}getState(){return{}}setState(t){}}const ni=new Uint8Array([0,0,0,0,0,56,0,24,0,0,0,1,32,0,0,0,0,0,32,33,34,35,36,37,38,39,0,0,0,0,0,0,96,96,96,96,96,96,96,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,214,0,0,0,0]);class oi{constructor(t,e){this.cpu=t,this.cbs=e,this.clampXMin=0,this.clampYMin=0,this.clampXMax=1023,this.clampYMax=1023,this.x=0,this.y=0,this.mode=0,this.down=!1,this.lastDown=!1,this.lastX=0,this.lastY=0,this.serve=0,this.shouldIntMove=!1,this.shouldIntPress=!1,this.slot=0,this.cbs.setMouse(this)}ioSwitch(t,e){}read(t,e){let s=this.cpu.getState();const i=(t,e)=>{this.cpu.write(t>>8,(255&t)+this.slot,e)},r=t=>this.cpu.read(t>>8,255&t),a=t=>(t.s&=254,t);if(this.cpu.getSync()){switch(e){case ni[18]:this.mode=s.a,this.cbs.mouseMode(!!(1&this.mode)),s=a(s);break;case ni[19]:i(1912,this.serve),s=a(s),this.serve=0;break;case ni[20]:{const t=this.lastX!==this.x||this.lastY!==this.y,e=(this.down?128:0)|(this.lastDown?64:0)|(t?32:0),r=255&this.x,n=255&this.y,o=this.x>>8,h=this.y>>8;i(1144,r),i(1272,n),i(1400,o),i(1528,h),i(1912,e),i(2040,this.mode),this.lastDown=this.down,this.lastX=this.x,this.lastY=this.y,s=a(s)}break;case ni[21]:P("clearMouse"),s=a(s);break;case ni[22]:P("posMouse"),s=a(s);break;case ni[23]:s.a?(this.clampYMin=r(1144)|r(1400)<<8,this.clampYMax=r(1272)|r(1528)<<8,P("clampMouse Y",this.clampYMin,this.clampYMax)):(this.clampXMin=r(1144)|r(1400)<<8,this.clampXMax=r(1272)|r(1528)<<8,P("clampMouse X",this.clampXMin,this.clampXMax)),s=a(s);break;case ni[24]:P("homeMouse"),this.x=this.clampXMin,this.y=this.clampYMin,s=a(s);break;case ni[25]:this.slot=s.y>>4,P("initMouse slot",this.slot),s=a(s)}this.cpu.setState(s)}return ni[e]}write(){}tick(){8&this.mode&&(this.serve|=8),4&this.mode&&this.shouldIntPress&&(this.serve|=4),2&this.mode&&this.shouldIntMove&&(this.serve|=2),this.serve&&this.cpu.irq(),this.shouldIntMove=!1,this.shouldIntPress=!1}setMouseXY(t,e,s,i){const r=this.clampXMax-this.clampXMin,a=this.clampYMax-this.clampYMin;this.x=t*r/s+this.clampXMin&65535,this.y=e*a/i+this.clampYMin&65535,this.shouldIntMove=!0}setMouseDown(t){this.shouldIntPress=this.down!==t,this.down=t}setState(t){this.clampXMin=t.clampXMin,this.clampYMin=t.clampYMin,this.clampXMax=t.clampXMax,this.clampYMax=t.clampYMax,this.x=t.x,this.y=t.y,this.mode=t.mode,this.down=t.down,this.lastDown=t.lastDown,this.lastX=t.lastX,this.lastY=t.lastY,this.serve=t.serve,this.shouldIntMove=t.shouldIntMove,this.shouldIntPress=t.shouldIntPress,this.slot=t.slot}getState(){return{clampXMin:this.clampXMin,clampYMin:this.clampYMin,clampXMax:this.clampXMax,clampYMax:this.clampYMax,x:this.x,y:this.y,mode:this.mode,down:this.down,lastDown:this.lastDown,lastX:this.lastX,lastY:this.lastY,serve:this.serve,shouldIntMove:this.shouldIntMove,shouldIntPress:this.shouldIntPress,slot:this.slot}}}class hi{constructor(t,e){this.cpu=t,this.vm=e,this._slot=new Array(7).fill(null),this._auxRom=null,this._khz=1023,this._rate=44e3,this._sample_size=4096,this._buffer=[],this._key=0,this._keyDown=!1,this._button=[!1,!1,!1],this._paddle=[0,0,0,0],this._phase=-1,this._sample=[],this._sampleIdx=0,this._sampleTime=0,this._didAudio=!1,this._high=.5,this._low=-.5,this._trigger=0,this._annunciators=[!1,!1,!1,!1],this._tape=[],this._tapeOffset=0,this._tapeNext=0,this._tapeCurrent=!1,this.init()}init(){this._calcSampleRate()}_debug(...t){}_tick(){const t=this.cpu.getCycles(),e=this._didAudio?this._phase>0?this._high:this._low:0;for(;this._sampleTime<t;this._sampleTime+=this._cycles_per_sample)this._sample[this._sampleIdx++]=e,this._sampleIdx===this._sample_size&&(this._audioListener&&this._audioListener(this._sample),this._sample=new Array(this._sample_size),this._sampleIdx=0);this._didAudio=!1}_calcSampleRate(){this._cycles_per_sample=1e3*this._khz/this._rate}_updateKHz(t){this._khz=t,this._calcSampleRate()}_access(t,e){let s=0;const i=this.cpu.getCycles(),r=void 0===e,a=i-this._trigger;switch(t){case 80:this._debug("Graphics Mode"),this.vm.text(!1);break;case 81:this._debug("Text Mode"),this.vm.text(!0);break;case 82:this._debug("Mixed Mode off"),this.vm.mixed(!1);break;case 83:this._debug("Mixed Mode on"),this.vm.mixed(!0);break;case 86:this._debug("LoRes Mode"),this.vm.hires(!1);break;case 87:this._debug("HiRes Mode"),this.vm.hires(!0);break;case 84:this.vm.page(1);break;case 85:this.vm.page(2);break;case 89:this._debug("Annunciator 0 on"),this._annunciators[0]=!0;break;case 91:this._debug("Annunciator 1 on"),this._annunciators[1]=!0;break;case 93:this._debug("Annunciator 2 on"),this._annunciators[2]=!0;break;case 95:this._debug("Annunciator 3 on"),this._annunciators[3]=!0;break;case 88:this._debug("Annunciator 0 off"),this._annunciators[0]=!1;break;case 90:this._debug("Annunciator 1 off"),this._annunciators[1]=!1;break;case 92:this._debug("Annunciator 2 off"),this._annunciators[2]=!1;break;case 94:this._debug("Annunciator 3 off"),this._annunciators[3]=!1;break;case 97:s=this._button[0]?128:0;break;case 98:s=this._button[1]?128:0;break;case 99:s=this._button[2]?128:0;break;case 100:s=a<2756*this._paddle[0]?128:0;break;case 101:s=a<2756*this._paddle[1]?128:0;break;case 102:s=a<2756*this._paddle[2]?128:0;break;case 103:s=a<2756*this._paddle[3]?128:0;break;case 116:void 0!==e&&this._updateKHz(1&e?1023:4096);break;case 96:if(-1===this._tapeOffset&&(this._tapeOffset=0,this._tapeNext=i),this._tapeOffset<this._tape.length)for(this._tapeCurrent=this._tape[this._tapeOffset][1];i>=this._tapeNext;)this._tapeOffset%1e3==0&&P("Read "+this._tapeOffset/1e3),this._tapeCurrent=this._tape[this._tapeOffset][1],this._tapeNext+=this._tape[this._tapeOffset++][0];s=this._tapeCurrent?128:0;break;default:switch(240&t){case 0:s=this._key;break;case 16:if((16===t||r)&&(this._key&=127),this._buffer.length>0){let t=this._buffer.shift();"\n"===t&&(t="\r"),this._key=128|t.charCodeAt(0)}s=127&this._key,16===t&&(s|=this._keyDown?128:0);break;case 32:case 64:break;case 48:this._phase=-this._phase,this._didAudio=!0,this._tick();break;case 112:this._trigger=this.cpu.getCycles()}}return void 0!==e&&(s=void 0),s}start(){return 192}end(){return 207}ioSwitch(t,e){let s;if(t<128)s=this._access(t,e);else{const i=(112&t)>>4,r=this._slot[i];r&&r.ioSwitch&&(s=r.ioSwitch(t,e))}return s}reset(){var t;for(let e=0;e<8;e++){const s=this._slot[e];s&&(null===(t=s.reset)||void 0===t||t.call(s))}this.vm.reset()}blit(){var t;const e=this._slot[3];if(e)return null===(t=e.blit)||void 0===t?void 0:t.call(e)}read(t,e){let s,i,r=0;switch(t){case 192:r=this.ioSwitch(e,void 0)||0;break;case 193:case 194:case 195:case 196:case 197:case 198:case 199:s=15&t,i=this._slot[s],this._auxRom!==i&&(this._auxRom=i),r=i?i.read(t,e):E();break;default:this._auxRom&&(r=this._auxRom.read(t,e))}return r}write(t,e,s){let i,r;switch(t){case 192:this.ioSwitch(e,s);break;case 193:case 194:case 195:case 196:case 197:case 198:case 199:i=15&t,r=this._slot[i],this._auxRom!==r&&(this._auxRom=r),r&&r.write(t,e,s);break;default:this._auxRom&&this._auxRom.write(t,e,s)}}getState(){return{annunciators:this._annunciators,cards:this._slot.map((t=>t?t.getState():null))}}setState(t){this._annunciators=t.annunciators,t.cards.map(((t,e)=>{var s;return null===(s=this._slot[e])||void 0===s?void 0:s.setState(t)}))}setSlot(t,e){this._slot[t]=e}getSlot(t){return this._slot[t]}keyDown(t){this._keyDown=!0,this._key=128|t}keyUp(){this._keyDown=!1}buttonDown(t,e=!0){this._button[t]=e}buttonUp(t){this._button[t]=!1}paddle(t,e){this._paddle[t]=e}updateKHz(t){this._updateKHz(t)}getKHz(){return this._khz}setKeyBuffer(t){if(this._buffer=t.split(""),this._buffer.length>0){this._keyDown=!0;const t=this._buffer.shift();this._key=128|t.charCodeAt(0)}}setTape(t){P(`Tape length: ${t.length}`),this._tape=t,this._tapeOffset=-1}sampleRate(t,e){this._rate=t,this._sample_size=e,this._sample=new Array(this._sample_size),this._sampleIdx=0,this._calcSampleRate()}tick(){var t,e;this._tick();for(let s=0;s<8;s++)null===(e=null===(t=this._slot[s])||void 0===t?void 0:t.tick)||void 0===e||e.call(t)}addSampleListener(t){this._audioListener=t}annunciator(t){return this._annunciators[t]}cycles(){return this.cpu.getCycles()}}const di=t=>[.75*t[0]&255,.75*t[1]&255,.75*t[2]&255],ci=[255,106,60],li=[20,245,60],mi=[20,207,253],ui=[255,68,253],fi=[255,255,255],gi=[0,0,0],pi=[[0,0,0],[227,30,96],[96,78,189],[255,68,253],[0,163,96],[156,156,156],[20,207,253],[208,195,255],[96,114,3],[255,106,60],[156,156,156],[255,160,208],[20,245,60],[208,221,141],[114,255,208],[255,255,255]],Ai=[0,2,4,6,8,5,12,14,1,3,10,7,9,11,13,15],bi=[[0,0,0],[227,30,96],[96,78,189],[255,68,253],[0,163,96],[156,156,156],[20,207,253],[208,195,255],[96,114,3],[255,106,60],[156,156,156],[255,160,208],[20,245,60],[208,221,141],[114,255,208],[255,255,255]],_i={top:193,bottom:-1,left:561,right:-1};class wi{constructor(t,e,s,i){this.vm=t,this.page=e,this.charset=s,this.e=i,this._buffer=[],this._refreshing=!1,this._blink=!1,this.highColorTextMode=!1,this.dirty=Object.assign({},_i),this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=T(4),this._buffer[1]=T(4),this.vm.setLoresPage(e,this)}_drawPixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=t[e+4]=i,t[e+1]=t[e+5]=r,t[e+2]=t[e+6]=a}_drawHalfPixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=i,t[e+1]=r,t[e+2]=a}_checkInverse(t){let e=!1;return this.e?this.vm._80colMode||this.vm.altCharMode||(e=64==(192&t)&&this._blink):e=!(128&t||64&t&&this._blink),e}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,0),write:(t,e,s)=>this._write(t,e,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,1),write:(t,e,s)=>this._write(t,e,s,1)}}_start(){return 4*this.page}_end(){return 4*this.page+3}_read(t,e,s){const i=1023&(t<<8|e);return this._buffer[s][i]}_write(t,e,s,i){const r=1023&(t<<8|e);let a,n;if(this._buffer[i][r]===s&&!this._refreshing)return;this._buffer[i][r]=s;const o=r%128%40,h=e-o,d=24&h|(3&t)<<1|h>>7,c=this.imageData.data;if(d<24&&o<40){let t=d<<3;t<this.dirty.top&&(this.dirty.top=t),t+=8,t>this.dirty.bottom&&(this.dirty.bottom=t);let e=14*o;if(e<this.dirty.left&&(this.dirty.left=e),e+=14,e>this.dirty.right&&(this.dirty.right=e),this.vm.textMode||this.vm.hiresMode||this.vm.mixedMode&&d>19)if(this.vm._80colMode){const t=this._checkInverse(s);a=t?gi:fi,n=t?fi:gi,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let e=4*(14*o+7*(i?0:1)+560*d*8);for(let t=0;t<8;t++){let i=this.charset[8*s+t];for(let t=0;t<7;t++){const t=1&i?n:a;this._drawHalfPixel(c,e,t),i>>=1,e+=4}e+=2212}}else{s=this._buffer[0][r];const t=this._checkInverse(s);a=t?gi:fi,n=t?fi:gi,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let e=4*(14*o+560*d*8);if(this.highColorTextMode&&(a=pi[this._buffer[1][r]>>4],n=pi[15&this._buffer[1][r]]),this.e)for(let t=0;t<8;t++){let i=this.charset[8*s+t];for(let t=0;t<7;t++){const t=1&i?n:a;this._drawPixel(c,e,t),i>>=1,e+=8}e+=2184}else{const i=this.vm.mixedMode&&!this.vm.textMode&&!this.vm.monoMode;for(let r=0;r<8;r++){let h=!(1&o),d=this.charset[8*s+r]<<1;i&&t&&(d^=511);for(let t=0;t<7;t++){let t;i?(t=128&d?128!=(448&d)?fi:h?ui:li:gi,h=!h):t=128&d?a:n,this._drawPixel(c,e,t),d<<=1,e+=8}e+=2184}}}else if(this.vm._80colMode&&!this.vm.an3State){let t=4*(14*o+7*(i?0:1)+560*d*8);if(this.vm.monoMode)for(let e=0;e<8;e++){let i=e<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&o&&(i>>=2);for(let e=0;e<7;e++){const e=1&i?fi:gi;this._drawHalfPixel(c,t,e),i>>=1,t+=4}t+=2212}else{1&i&&(s=(119&s)<<1|(136&s)>>3);for(let e=0;e<8;e++){const i=pi[e<4?15&s:s>>4];for(let e=0;e<7;e++)this._drawHalfPixel(c,t,i),t+=4;t+=2212}}}else if(0===i){let t=4*(14*o+560*d*8);if(this.vm.monoMode)for(let e=0;e<8;e++){let i=e<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&o&&(i>>=2);for(let e=0;e<14;e++){const e=1&i?fi:gi;this._drawHalfPixel(c,t,e),i>>=1,t+=4}t+=2184}else for(let e=0;e<8;e++){const i=pi[e<4?15&s:s>>4];for(let e=0;e<7;e++)this._drawPixel(c,t,i),t+=8;t+=2184}}}}refresh(){this.highColorTextMode=!this.vm.an3State&&this.vm.textMode&&!this.vm._80colMode;let t=1024*this.page;this._refreshing=!0;for(let e=0;e<1024;e++,t++)this._write(t>>8,255&t,this._buffer[0][e],0),this.vm._80colMode&&this._write(t>>8,255&t,this._buffer[1][e],1);this._refreshing=!1}blink(){let t=1024*this.page;this._refreshing=!0,this._blink=!this._blink;for(let e=0;e<1024;e++,t++)64==(192&this._buffer[0][e])&&this._write(t>>8,255&t,this._buffer[0][e],0);this._refreshing=!1}start(){return setInterval((()=>this.blink()),267),this._start()}end(){return this._end()}read(t,e){return this._read(t,e,0)}write(t,e,s){return this._write(t,e,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(t){this._buffer[0]=new Uint8Array(t.buffer[0]),this._buffer[1]=new Uint8Array(t.buffer[1]),this.refresh()}rowToBase(t){const e=t>>3&3;return(t>>1&3)<<8|(1&t)<<7|e<<5|e<<3}mapCharCode(t){return(t&=127)<32&&(t+=64),!this.e&&t>=96&&(t-=64),t}getText(){let t,e,s,i,r,a="";for(s=0;s<24;s++){if(r=this.rowToBase(s),t="",this.e&&this.vm._80colMode)for(i=0;i<80;i++)e=this.mapCharCode(this._buffer[1-i%2][r+Math.floor(i/2)]),t+=String.fromCharCode(e);else for(i=0;i<40;i++)e=this.mapCharCode(this._buffer[0][r+i]),t+=String.fromCharCode(e);t=t.trimRight(),a+=t+"\n"}return a}}class yi{constructor(t,e){this.vm=t,this.page=e,this.dirty=Object.assign({},_i),this._buffer=[],this._refreshing=!1,this.colorDHRMode=!0,this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=T(32),this._buffer[1]=T(32),this.vm.setHiresPage(e,this)}_drawPixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=t[e+4]=i,t[e+1]=t[e+5]=r,t[e+2]=t[e+6]=a}_drawHalfPixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=i,t[e+1]=r,t[e+2]=a}_draw3Pixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=t[e+4]=t[e+8]=i,t[e+1]=t[e+5]=t[e+9]=r,t[e+2]=t[e+6]=t[e+10]=a}_draw4Pixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=t[e+4]=t[e+8]=t[e+12]=i,t[e+1]=t[e+5]=t[e+9]=t[e+13]=r,t[e+2]=t[e+6]=t[e+10]=t[e+14]=a}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,0),write:(t,e,s)=>this._write(t,e,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,1),write:(t,e,s)=>this._write(t,e,s,1)}}_start(){return 32*this.page}_end(){return 32*this.page+31}_read(t,e,s){const i=8191&(t<<8|e);return this._buffer[s][i]}_write(t,e,s,i){const r=t<<8|e,a=8191&r;if(this._buffer[i][a]===s&&!this._refreshing)return;this._buffer[i][a]=s;const n=a%128%40,o=e-n,h=24&o|(3&t)<<1|o>>7,d=a>>10,c=this.imageData.data;let l,m;if(h<24&&n<40&&(this.vm.hiresMode||this._refreshing)){let t=h<<4|d<<1;t<this.dirty.top&&(this.dirty.top=t),t+=1,t>this.dirty.bottom&&(this.dirty.bottom=t);let e,o,u,f,g,p,A,b=14*n-2;if(b<this.dirty.left&&(this.dirty.left=b),b+=18,b>this.dirty.right&&(this.dirty.right=b),m=h<<4|d<<1,this.oneSixtyMode&&!this.vm.monoMode){const t=15&s,e=s>>4;l=2*n+(1^i);const r=28*l+280*m*4;this._draw3Pixel(c,r,bi[t]),this._draw4Pixel(c,r+12,bi[e])}else if(this.vm.doubleHiresMode){s&=127;const t=n%2,h=n-t,d=a-t;e=this._buffer[0][d-1],o=this._buffer[1][d],u=this._buffer[0][d],f=this._buffer[1][d+1],g=this._buffer[0][d+1],p=this._buffer[1][d+2],A=[0,(15&o)>>0,(112&o)>>4|(1&u)<<3,(30&u)>>1,(96&u)>>5|(3&f)<<2,(60&f)>>2,(64&f)>>6|(7&g)<<1,(120&g)>>3,0];const b=[0,128&o,128&o,128&u,128&f,128&f,128&g,128&g,0];n>0&&(A[0]=(120&e)>>3,b[0]=128&e),n<39&&(A[8]=15&p,b[8]=128&p),l=14*h;let _=4*l+280*m*4,w=null;(this.vm.monoMode||this.monoDHRMode)&&(w=fi);for(let t=1;t<8;t++){const e=b[t],s=bi[Ai[A[t]]];let i=A[t-1]|A[t]<<4|A[t+1]<<8;for(let r=0;r<4;r++,_+=4)w?16&i?this._drawHalfPixel(c,_,w):this._drawHalfPixel(c,_,gi):this.mixedDHRMode?e?this._drawHalfPixel(c,_,s):16&i?this._drawHalfPixel(c,_,fi):this._drawHalfPixel(c,_,gi):this.colorDHRMode?this._drawHalfPixel(c,_,s):A[t]===A[t-1]||A[t]===A[t+1]||28!=(28&i)&&112!=(112&i)&&56!=(56&i)?56&i||A[t]===A[t+1]||A[t]===A[t-1]?this._drawHalfPixel(c,_,s):40&i?this._drawHalfPixel(c,_,di(s)):this._drawHalfPixel(c,_,gi):this._drawHalfPixel(c,_,fi),i>>=1}if(!this._refreshing){this._refreshing=!0;const t=i?0:1;for(let e=r-1;e<=r+1;e++){const s=this._read(e>>8,255&e,t);this._write(e>>8,255&e,s,t)}this._refreshing=!1}}else{const t=128&(s=this._buffer[0][a]);s&=127,l=14*n-2,o=n>0?this._buffer[0][a-1]:0,f=n<39?this._buffer[0][a+1]:0;let e,i=32&o,r=64&o,h=1&(s|=(3&f)<<7),d=!(1&n);const u=t?ci:li,g=t?mi:ui;let p=4*l+280*m*4;const A=this.vm.monoMode?fi:null;for(let t=0;t<9;t++,p+=8)s>>=1,e=r?A||(this.highColorHGRMode?bi[this._buffer[1][a]>>4]:i||h?fi:d?u:g):A?gi:this.highColorHGRMode?bi[15&this._buffer[1][a]]:d&&h&&i?i?di(g):g:!d&&i&&h?h?di(u):u:gi,l>-1&&l<560&&this._drawPixel(c,p,e),l+=2,i=r,r=h,h=1&s,d=!d}}}refresh(){this.highColorHGRMode=!this.vm.an3State&&this.vm.hiresMode&&!this.vm._80colMode,this.oneSixtyMode=1===this.vm.flag&&this.vm.doubleHiresMode,this.mixedDHRMode=2===this.vm.flag&&this.vm.doubleHiresMode,this.monoDHRMode=3===this.vm.flag&&this.vm.doubleHiresMode;let t=8192*this.page;this._refreshing=!0;for(let e=0;e<8192;e++,t++){const s=t>>8,i=255&t;this._write(s,i,this._buffer[0][e],0),this.vm._80colMode&&this._write(s,i,this._buffer[1][e],1)}this._refreshing=!1}start(){return this._start()}end(){return this._end()}read(t,e){return this._read(t,e,0)}write(t,e,s){return this._write(t,e,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(t){this._buffer[0]=new Uint8Array(t.buffer[0]),this._buffer[1]=new Uint8Array(t.buffer[1]),this.refresh()}}class Si{constructor(t,e){this.screen=t,this.e=e,this._grs=[],this._hgrs=[],this._refreshFlag=!0,this.ready=Promise.resolve(),this.flag=0,this.monoMode=!1,this._canvas=document.createElement("canvas");const s=this._canvas.getContext("2d"),i=this.screen.getContext("2d");if(!s||!i)throw new Error("No 2d context");this.context=s;const{width:r,height:a}={width:560,height:192};this._canvas.width=r,this._canvas.height=a,this._screenContext=i,this._screenContext.imageSmoothingEnabled=!1,this._left=(this.screen.width-560)/2,this._top=(this.screen.height-384)/2}_refresh(){this.doubleHiresMode=!this.an3State&&this.hiresMode&&this._80colMode,this._refreshFlag=!0}refresh(){this._refresh()}reset(){this.textMode=!0,this.mixedMode=!1,this.hiresMode=!0,this.pageMode=1,this._80colMode=!1,this.altCharMode=!1,this.flag=0,this.an3State=!0,this._refresh()}setLoresPage(t,e){this._grs[t-1]=e}setHiresPage(t,e){this._hgrs[t-1]=e}getLoresPage(t){return this._grs[t-1]}getHiresPage(t){return this._hgrs[t-1]}text(t){const e=this.textMode;this.textMode=t,t&&(this.flag=0),e!==t&&this._refresh()}_80col(t){if(!this.e)return;const e=this._80colMode;this._80colMode=t,e!==t&&this._refresh()}altChar(t){if(!this.e)return;const e=this.altCharMode;this.altCharMode=t,e!==t&&this._refresh()}hires(t){const e=this.hiresMode;this.hiresMode=t,t||(this.flag=0),e!==t&&this._refresh()}an3(t){if(!this.e)return;const e=this.an3State;this.an3State=t,t&&(this.flag=3&(this.flag<<1|(this._80colMode?0:1))),e!==t&&this._refresh()}doubleHires(t){this.an3(!t)}mixed(t){const e=this.mixedMode;this.mixedMode=t,e!==t&&this._refresh()}page(t){const e=this.pageMode;this.pageMode=t,e!==t&&this._refresh()}isText(){return this.textMode}isMixed(){return this.mixedMode}isPage2(){return 2===this.pageMode}isHires(){return this.hiresMode}isDoubleHires(){return this.doubleHiresMode}is80Col(){return this._80colMode}isAltChar(){return this.altCharMode}buildScreen(t,e){const{x:s,y:i}=(this._80colMode,{x:0,y:0});return e?(this.context.putImageData(t,s,i,0,0,560,160),this.context.putImageData(e,s,i,0,160,560,32)):this.context.putImageData(t,s,i),this._canvas}updateImage(t,e,s,i){let r=!1;if(-1!==e.bottom||i&&-1!==i.bottom){const e=this.buildScreen(t,s);this._screenContext.drawImage(e,0,0,560,192,this._left,this._top,560,384),r=!0}return r}blit(t){let e=!1;const s=this._hgrs[this.pageMode-1],i=this._grs[this.pageMode-1];return this._refreshFlag&&(s.refresh(),i.refresh(),this._refreshFlag=!1),e=t?this.updateImage(t,{top:0,left:0,right:560,bottom:192}):this.hiresMode&&!this.textMode?this.updateImage(s.imageData,s.dirty,this.mixedMode?i.imageData:null,this.mixedMode?i.dirty:null):this.updateImage(i.imageData,i.dirty),s.dirty=Object.assign({},_i),i.dirty=Object.assign({},_i),e}getState(){return{grs:[this._grs[0].getState(),this._grs[1].getState()],hgrs:[this._hgrs[0].getState(),this._hgrs[1].getState()],textMode:this.textMode,mixedMode:this.mixedMode,hiresMode:this.hiresMode,pageMode:this.pageMode,_80colMode:this._80colMode,altCharMode:this.altCharMode,an3State:this.an3State,flag:this.flag}}setState(t){this.textMode=t.textMode,this.mixedMode=t.mixedMode,this.hiresMode=t.hiresMode,this.pageMode=t.pageMode,this._80colMode=t._80colMode,this.altCharMode=t.altCharMode,this.an3State=t.an3State,this.flag=t.flag,this._grs[0].setState(t.grs[0]),this._grs[1].setState(t.grs[1]),this._hgrs[0].setState(t.hgrs[0]),this._hgrs[1].setState(t.hgrs[1]),this._refresh()}mono(t){t?this.screen.classList.add("mono"):this.screen.classList.remove("mono"),this.monoMode=t,this._refresh()}scanlines(t){const e=this.screen.parentElement;e&&(t?e.classList.add("scanlines"):e.classList.remove("scanlines"))}getText(){return this._grs[this.pageMode-1].getText()}}var Ei=r(7911);const Ri=[255,255,255],Ti=[0,0,0],vi={top:193,bottom:-1,left:561,right:-1};class Pi{constructor(t,e,s,i){this.vm=t,this.page=e,this.charset=s,this.e=i,this._buffer=[],this._refreshing=!1,this._blink=!1,this.dirty=Object.assign({},vi),this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=T(4),this._buffer[1]=T(4),this.vm.setLoresPage(e,this)}_drawPixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=t[e+4]=i,t[e+1]=t[e+5]=r,t[e+2]=t[e+6]=a}_drawHalfPixel(t,e,s){const i=s[0],r=s[1],a=s[2];t[e+0]=i,t[e+1]=r,t[e+2]=a}_checkInverse(t){let e=!1;return this.e?this.vm._80colMode||this.vm.altCharMode||(e=64==(192&t)&&this._blink):e=!(128&t||64&t&&this._blink),e}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,0),write:(t,e,s)=>this._write(t,e,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,1),write:(t,e,s)=>this._write(t,e,s,1)}}_start(){return 4*this.page}_end(){return 4*this.page+3}_read(t,e,s){const i=1023&(t<<8|e);return this._buffer[s][i]}_write(t,e,s,i){const r=1023&(t<<8|e);let a,n;if(this._buffer[i][r]===s&&!this._refreshing)return;this._buffer[i][r]=s;const o=r%128%40,h=e-o,d=24&h|(3&t)<<1|h>>7,c=this.imageData.data;if(d<24&&o<40){let t=d<<3;t<this.dirty.top&&(this.dirty.top=t),t+=8,t>this.dirty.bottom&&(this.dirty.bottom=t);let e=14*o;if(e<this.dirty.left&&(this.dirty.left=e),e+=14,e>this.dirty.right&&(this.dirty.right=e),this.vm.textMode||this.vm.hiresMode||this.vm.mixedMode&&d>19){if(this.vm._80colMode){const t=this._checkInverse(s);a=t?Ti:Ri,n=t?Ri:Ti,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let e=4*(14*o+7*(i?0:1)+560*d*8);for(let t=0;t<8;t++){let i=this.charset[8*s+t];for(let t=0;t<7;t++){const t=1&i?n:a;this._drawHalfPixel(c,e,t),i>>=1,e+=4}e+=2212}}else if(0===i){s=this._buffer[0][r];const t=this._checkInverse(s);a=t?Ti:Ri,n=t?Ri:Ti,this.vm.altCharMode||(s=s>=64&&s<128?s-64:s);let e=4*(14*o+560*d*8);if(this.e)for(let t=0;t<8;t++){let i=this.charset[8*s+t];for(let t=0;t<7;t++){const t=1&i?n:a;this._drawPixel(c,e,t),i>>=1,e+=8}e+=2184}else for(let t=0;t<8;t++){let i=this.charset[8*s+t]<<1;for(let t=0;t<7;t++){const t=128&i?a:n;this._drawPixel(c,e,t),i<<=1,e+=8}e+=2184}}}else if(this.vm._80colMode&&!this.vm.an3State){let t=4*(14*o+7*(i?0:1)+560*d*8);for(let e=0;e<8;e++){let i=e<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&o&&(i>>=2);for(let e=0;e<7;e++){const e=1&i?Ri:Ti;this._drawHalfPixel(c,t,e),i>>=1,t+=4}t+=2212}}else if(0===i){let t=4*(14*o+560*d*8);for(let e=0;e<8;e++){let i=e<4?15&s:s>>4;i|=i<<4,i|=i<<8,1&o&&(i>>=2);for(let e=0;e<14;e++){const e=1&i?Ri:Ti;this._drawHalfPixel(c,t,e),i>>=1,t+=4}t+=2184}}}}refresh(){let t=1024*this.page;this._refreshing=!0;for(let e=0;e<1024;e++,t++)this._write(t>>8,255&t,this._buffer[0][e],0),this.vm._80colMode&&this._write(t>>8,255&t,this._buffer[1][e],1);this._refreshing=!1}blink(){let t=1024*this.page;this._refreshing=!0,this._blink=!this._blink;for(let e=0;e<1024;e++,t++)64==(192&this._buffer[0][e])&&this._write(t>>8,255&t,this._buffer[0][e],0);this._refreshing=!1}start(){return setInterval((()=>this.blink()),267),this._start()}end(){return this._end()}read(t,e){return this._read(t,e,0)}write(t,e,s){return this._write(t,e,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(t){this._buffer[0]=new Uint8Array(t.buffer[0]),this._buffer[1]=new Uint8Array(t.buffer[1]),this.refresh()}rowToBase(t){const e=t>>3&3;return(t>>1&3)<<8|(1&t)<<7|e<<5|e<<3}mapCharCode(t){return(t&=127)<32&&(t+=64),!this.e&&t>=96&&(t-=64),t}getText(){let t,e,s,i,r,a="";for(s=0;s<24;s++){if(r=this.rowToBase(s),t="",this.e&&this.vm._80colMode)for(i=0;i<80;i++)e=this.mapCharCode(this._buffer[1-i%2][r+Math.floor(i/2)]),t+=String.fromCharCode(e);else for(i=0;i<40;i++)e=this.mapCharCode(this._buffer[0][r+i]),t+=String.fromCharCode(e);t=t.trimRight(),a+=t+"\n"}return a}}const Ci=(t,e,s)=>{const i=s[0],r=s[1],a=s[2];t[e+0]=t[e+4]=i,t[e+1]=t[e+5]=r,t[e+2]=t[e+6]=a},Ii=(t,e,s)=>{const i=s[0],r=s[1],a=s[2];t[e+0]=i,t[e+1]=r,t[e+2]=a};class Oi{constructor(t,e){this.vm=t,this.page=e,this.dirty=Object.assign({},vi),this._buffer=[],this._refreshing=!1,this.imageData=this.vm.context.createImageData(560,192),this.imageData.data.fill(255),this._buffer[0]=T(32),this._buffer[1]=T(32),this.vm.setHiresPage(e,this)}bank0(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,0),write:(t,e,s)=>this._write(t,e,s,0)}}bank1(){return{start:()=>this._start(),end:()=>this._end(),read:(t,e)=>this._read(t,e,1),write:(t,e,s)=>this._write(t,e,s,1)}}_start(){return 32*this.page}_end(){return 32*this.page+31}_read(t,e,s){const i=8191&(t<<8|e);return this._buffer[s][i]}_write(t,e,s,i){const r=t<<8|e,a=8191&r;if(this._buffer[i][a]===s&&!this._refreshing)return;this._buffer[i][a]=s;const n=a%128%40,o=e-n,h=24&o|(3&t)<<1|o>>7,d=a>>10,c=this.imageData.data;if(h<24&&n<40&&this.vm.hiresMode){let t=h<<3|d;t<this.dirty.top&&(this.dirty.top=t),t+=1,t>this.dirty.bottom&&(this.dirty.bottom=t);let e=14*n-2;e<this.dirty.left&&(this.dirty.left=e),e+=14,e>this.dirty.right&&(this.dirty.right=e);const o=h<<3|d;if(this.vm.doubleHiresMode){let t=4*(14*n+(i?0:7))+280*o*4*2,e=s;for(let s=0;s<7;s++,t+=4)Ii(c,t,1&e?Ri:Ti),e>>=1}else if(0===i){const t=128&s,e=t&&39===n;let h=14*n*4+560*o*4;if(t){const t=this._buffer[i][a-1]||0;Ii(c,h,64&t?Ri:Ti),h+=4}let d=s;for(let t=0;t<7;t++,h+=8){(e&&6===t?Ii:Ci)(c,h,1&d?Ri:Ti),d>>=1}if(!this._refreshing){this._refreshing=!0;const t=r+1;this._write(t>>8,255&t,this._buffer[0][8191&t],0),this._refreshing=!1}}}}refresh(){let t=8192*this.page;this._refreshing=!0;for(let e=0;e<8192;e++,t++){const s=t>>8,i=255&t;this._write(s,i,this._buffer[0][e],0),this.vm._80colMode&&this._write(s,i,this._buffer[1][e],1)}this._refreshing=!1}start(){return this._start()}end(){return this._end()}read(t,e){return this._read(t,e,0)}write(t,e,s){return this._write(t,e,s,0)}getState(){return{buffer:[new Uint8Array(this._buffer[0]),new Uint8Array(this._buffer[1])]}}setState(t){this._buffer[0]=new Uint8Array(t.buffer[0]),this._buffer[1]=new Uint8Array(t.buffer[1]),this.refresh()}}class ki{constructor(t,e){this.screen=t,this.e=e,this._grs=[],this._hgrs=[],this._scanlines=!1,this._refreshFlag=!0,this.flag=0,this.monoMode=!1,this._canvas=document.createElement("canvas");const s=this._canvas.getContext("2d");if(!s)throw new Error("no 2d context");const{width:i,height:r}=Ei.screenEmu.C.NTSC_DETAILS.imageSize;this._canvas.width=i,this._canvas.height=r,this.context=s,this._sv=new Ei.screenEmu.ScreenView(this.screen),this.ready=this.init()}init(){return t=this,e=void 0,i=function*(){yield this._sv.initOpenGL(),this._displayConfig=this.defaultMonitor(),this._sv.displayConfiguration=this._displayConfig},new((s=void 0)||(s=Promise))((function(r,a){function n(t){try{h(i.next(t))}catch(t){a(t)}}function o(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,o)}h((i=i.apply(t,e||[])).next())}));var t,e,s,i}defaultMonitor(){const t=new Ei.screenEmu.DisplayConfiguration;return t.displayResolution=new Ei.screenEmu.Size(this.screen.width,this.screen.height),t.displayScanlineLevel=.5,t.videoWhiteOnly=!0,t.videoSaturation=.8,t.videoSize=new Ei.screenEmu.Size(1.25,1.15),t.videoCenter=new Ei.screenEmu.Point(.01,.02),t}monitorII(){const t=new Ei.screenEmu.DisplayConfiguration;return t.displayResolution=new Ei.screenEmu.Size(this.screen.width,this.screen.height),t.videoDecoder="CANVAS_MONOCHROME",t.videoBrightness=.15,t.videoContrast=.8,t.videoSaturation=1.45,t.videoHue=.27,t.videoCenter=new Ei.screenEmu.Point(.01,.02),t.videoSize=new Ei.screenEmu.Size(1.25,1.15),t.videoBandwidth=9e6,t.displayBarrel=.1,t.displayScanlineLevel=.5,t.displayCenterLighting=.5,t.displayLuminanceGain=1.5,t}_refresh(){this.doubleHiresMode=!this.an3State&&this.hiresMode&&this._80colMode,this._refreshFlag=!0,this._displayConfig&&(this._displayConfig.videoWhiteOnly=this.textMode||this.monoMode,this._displayConfig.displayScanlineLevel=this._scanlines?.5:0,this._sv.displayConfiguration=this._displayConfig)}refresh(){this._refresh()}reset(){this.textMode=!0,this.mixedMode=!1,this.hiresMode=!0,this.pageMode=1,this._80colMode=!1,this.altCharMode=!1,this.an3State=!0,this._refresh()}setLoresPage(t,e){this._grs[t-1]=e}setHiresPage(t,e){this._hgrs[t-1]=e}getLoresPage(t){return this._grs[t-1]}getHiresPage(t){return this._hgrs[t-1]}text(t){const e=this.textMode;this.textMode=t,e!==t&&this._refresh()}_80col(t){if(!this.e)return;const e=this._80colMode;this._80colMode=t,e!==t&&this._refresh()}altChar(t){if(!this.e)return;const e=this.altCharMode;this.altCharMode=t,e!==t&&this._refresh()}hires(t){const e=this.hiresMode;this.hiresMode=t,e!==t&&this._refresh()}an3(t){if(!this.e)return;const e=this.an3State;this.an3State=t,e!==t&&this._refresh()}doubleHires(t){this.an3(!t)}mixed(t){const e=this.mixedMode;this.mixedMode=t,e!==t&&this._refresh()}page(t){const e=this.pageMode;this.pageMode=t,e!==t&&this._refresh()}isText(){return this.textMode}isMixed(){return this.mixedMode}isPage2(){return 2===this.pageMode}isHires(){return this.hiresMode}isDoubleHires(){return this.doubleHiresMode}is80Col(){return this._80colMode}isAltChar(){return this.altCharMode}updateImage(t,e,s,i){let r=!1;if(-1!==e.bottom||i&&-1!==i.bottom){const e=this.buildScreen(t,s),i=new Ei.screenEmu.ImageInfo(e);this._sv.image=i,r=!0}return this._sv.vsync(),r}buildScreen(t,e){const s=Ei.screenEmu.C.NTSC_DETAILS,{width:i,height:r}=s.imageSize,{x:a,y:n}=this._80colMode?s.topLeft80Col:s.topLeft;return e?(this.context.putImageData(t,a,n,0,0,560,160),this.context.putImageData(e,a,n,0,160,560,32)):this.context.putImageData(t,a,n),this.context.getImageData(0,0,i,r)}blit(t){let e=!1;const s=this._hgrs[this.pageMode-1],i=this._grs[this.pageMode-1];if(this._refreshFlag){const{width:t,height:e}=Ei.screenEmu.C.NTSC_DETAILS.imageSize;this.context.clearRect(0,0,t,e),s.refresh(),i.refresh(),this._refreshFlag=!1}return e=t?this.updateImage(t,{top:0,left:0,right:560,bottom:192}):this.hiresMode&&!this.textMode?this.updateImage(s.imageData,s.dirty,this.mixedMode?i.imageData:null,this.mixedMode?i.dirty:null):this.updateImage(i.imageData,i.dirty),s.dirty=Object.assign({},vi),i.dirty=Object.assign({},vi),e}getState(){return{grs:[this._grs[0].getState(),this._grs[1].getState()],hgrs:[this._hgrs[0].getState(),this._hgrs[1].getState()],textMode:this.textMode,mixedMode:this.mixedMode,hiresMode:this.hiresMode,pageMode:this.pageMode,_80colMode:this._80colMode,altCharMode:this.altCharMode,an3State:this.an3State,flag:0}}setState(t){this.textMode=t.textMode,this.mixedMode=t.mixedMode,this.hiresMode=t.hiresMode,this.pageMode=t.pageMode,this._80colMode=t._80colMode,this.altCharMode=t.altCharMode,this.an3State=t.an3State,this._grs[0].setState(t.grs[0]),this._grs[1].setState(t.grs[1]),this._hgrs[0].setState(t.hgrs[0]),this._hgrs[1].setState(t.hgrs[1]),this._refresh()}mono(t){this.monoMode=t,this._displayConfig=t?this.monitorII():this.defaultMonitor(),this._refresh()}scanlines(t){this._scanlines=t,this._refresh()}getText(){return this._grs[this.pageMode-1].getText()}}class Mi{constructor(t,e){this.start_page=t,this.end_page=e,this.mem=T(e-t+1)}start(){return this.start_page}end(){return this.end_page}read(t,e){return this.mem[t-this.start_page<<8|e]}write(t,e,s){this.mem[t-this.start_page<<8|e]=s}getState(){return{mem:new Uint8Array(this.mem)}}setState(t){this.mem=new Uint8Array(t.mem)}}class Di{constructor(t){this.mmu=t}read(t,e){return this.mmu._access(e)||0}write(t,e,s){this.mmu._access(e,s)}}class Li{constructor(t,e){this.mmu=t,this.rom=e}_access(t,e){195===t&&(this.mmu._setIntc8rom(!0),this.mmu._updateBanks()),207===t&&255===e&&(this.mmu._setIntc8rom(!1),this.mmu._updateBanks())}read(t,e){return this._access(t,e),this.rom.read(t,e)}write(t,e,s){this._access(t,e)}}class Ni{constructor(t,e,s,i,r,a,n,o){this.cpu=t,this.vm=e,this.lores1=s,this.lores2=i,this.hires1=r,this.hires2=a,this.io=n,this.rom=o,this._readPages=new Array(256),this._writePages=new Array(256),this._pages=new Array(256),this._vbEnd=0,this.switches=new Di(this),this.auxRom=new Li(this,this.rom),this.mem00_01=[new Mi(0,1),new Mi(0,1)],this.mem02_03=[new Mi(2,3),new Mi(2,3)],this.mem04_07=[this.lores1.bank0(),this.lores1.bank1()],this.mem08_0B=[this.lores2.bank0(),this.lores2.bank1()],this.mem0C_1F=[new Mi(12,31),new Mi(12,31)],this.mem20_3F=[this.hires1.bank0(),this.hires1.bank1()],this.mem40_5F=[this.hires2.bank0(),this.hires2.bank1()],this.mem60_BF=[new Mi(96,191),new Mi(96,191)],this.memC0_C0=[this.switches],this.memC1_CF=[this.io,this.auxRom],this.memD0_DF=[this.rom,new Mi(208,223),new Mi(208,223),new Mi(208,223),new Mi(208,223)],this.memE0_FF=[this.rom,new Mi(224,255),new Mi(224,255)];for(let t=0;t<2;t++)this._pages[t]=this.mem00_01,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=2;t<4;t++)this._pages[t]=this.mem02_03,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=4;t<8;t++)this._pages[t]=this.mem04_07,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=8;t<12;t++)this._pages[t]=this.mem08_0B,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=12;t<32;t++)this._pages[t]=this.mem0C_1F,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=32;t<64;t++)this._pages[t]=this.mem20_3F,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=64;t<96;t++)this._pages[t]=this.mem40_5F,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=96;t<192;t++)this._pages[t]=this.mem60_BF,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];{const t=192;this._pages[t]=this.memC0_C0,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0]}for(let t=193;t<208;t++)this._pages[t]=this.memC1_CF,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=208;t<224;t++)this._pages[t]=this.memD0_DF,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];for(let t=224;t<256;t++)this._pages[t]=this.memE0_FF,this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0]}_initSwitches(){this._bank1=!1,this._readbsr=!1,this._writebsr=!1,this._prewrite=!1,this._auxRamRead=!1,this._auxRamWrite=!1,this._altzp=!1,this._intcxrom=!1,this._slot3rom=!1,this._intc8rom=!1,this.__80store=!1,this._page2=!1,this._hires=!1,this._iouDisable=!0}_debug(...t){}_setIntc8rom(t){this._intc8rom=t}_updateBanks(){if(this._auxRamRead)for(let t=2;t<192;t++)this._readPages[t]=this._pages[t][1];else for(let t=2;t<192;t++)this._readPages[t]=this._pages[t][0];if(this._auxRamWrite)for(let t=2;t<192;t++)this._writePages[t]=this._pages[t][1];else for(let t=2;t<192;t++)this._writePages[t]=this._pages[t][0];if(this.__80store)if(this._page2){for(let t=4;t<8;t++)this._readPages[t]=this._pages[t][1],this._writePages[t]=this._pages[t][1];if(this._hires)for(let t=32;t<64;t++)this._readPages[t]=this._pages[t][1],this._writePages[t]=this._pages[t][1]}else{for(let t=4;t<8;t++)this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];if(this._hires)for(let t=32;t<64;t++)this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0]}if(this._intcxrom)for(let t=193;t<208;t++)this._readPages[t]=this._pages[t][1],this._writePages[t]=this._pages[t][1];else{for(let t=193;t<208;t++)this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];if(this._slot3rom||(this._readPages[195]=this._pages[195][1],this._writePages[195]=this._pages[195][1]),this._intc8rom)for(let t=200;t<208;t++)this._readPages[t]=this._pages[t][1],this._writePages[t]=this._pages[t][1]}if(this._altzp)for(let t=0;t<2;t++)this._readPages[t]=this._pages[t][1],this._writePages[t]=this._pages[t][1];else for(let t=0;t<2;t++)this._readPages[t]=this._pages[t][0],this._writePages[t]=this._pages[t][0];if(this._readbsr){if(this._bank1)for(let t=208;t<224;t++)this._readPages[t]=this._pages[t][this._altzp?2:1];else for(let t=208;t<224;t++)this._readPages[t]=this._pages[t][this._altzp?4:3];for(let t=224;t<256;t++)this._readPages[t]=this._pages[t][this._altzp?2:1]}else for(let t=208;t<256;t++)this._readPages[t]=this._pages[t][0];if(this._writebsr){if(this._bank1)for(let t=208;t<224;t++)this._writePages[t]=this._pages[t][this._altzp?2:1];else for(let t=208;t<224;t++)this._writePages[t]=this._pages[t][this._altzp?4:3];for(let t=224;t<256;t++)this._writePages[t]=this._pages[t][this._altzp?2:1]}else for(let t=208;t<256;t++)this._writePages[t]=this._pages[t][0]}_accessMMUSet(t,e){switch(t){case 0:this.__80store=!1,this._debug("80 Store Off",e),this.vm.page(this._page2?2:1);break;case 1:this.__80store=!0,this._debug("80 Store On",e);break;case 2:this._auxRamRead=!1,this._debug("Aux RAM Read Off");break;case 3:this._auxRamRead=!0,this._debug("Aux RAM Read On");break;case 4:this._auxRamWrite=!1,this._debug("Aux RAM Write Off");break;case 5:this._auxRamWrite=!0,this._debug("Aux RAM Write On");break;case 6:this._intcxrom=!1,this._slot3rom&&(this._intc8rom=!1),this._debug("Int CX ROM Off");break;case 7:this._intcxrom=!0,this._debug("Int CX ROM On");break;case 8:this._altzp=!1,this._debug("Alt ZP Off");break;case 9:this._altzp=!0,this._debug("Alt ZP On");break;case 10:this._slot3rom=!1,this._debug("Slot 3 ROM Off");break;case 11:this._slot3rom=!0,this._debug("Slot 3 ROM On");break;case 12:this._debug("80 Column Mode off"),this.vm._80col(!1);break;case 13:this._debug("80 Column Mode on"),this.vm._80col(!0);break;case 14:this._debug("Alt Char off"),this.vm.altChar(!1);break;case 15:this._debug("Alt Char on"),this.vm.altChar(!0)}this._updateBanks()}_accessStatus(t,e){let s;switch(t){case 17:this._debug("Bank 2 Read "+(this._bank1?"false":"true")),s=this._bank1?0:128;break;case 18:this._debug("Bank SW RAM Read "+(this._readbsr?"true":"false")),s=this._readbsr?128:0;break;case 19:this._debug("Aux RAM Read "+(this._auxRamRead?"true":"false")),s=this._auxRamRead?128:0;break;case 20:this._debug("Aux RAM Write "+(this._auxRamWrite?"true":"false")),s=this._auxRamWrite?128:0;break;case 21:s=this._intcxrom?128:0;break;case 22:this._debug("Alt ZP "+(this._altzp?"true":"false")),s=this._altzp?128:0;break;case 23:this._debug("Slot C3 ROM "+(this._slot3rom?"true":"false")),s=this._slot3rom?128:0;break;case 24:this._debug("80 Store "+(this.__80store?"true":"false")),s=this.__80store?128:0;break;case 25:s=this.cpu.getCycles()<this._vbEnd?128:0;break;case 26:s=this.vm.isText()?128:0;break;case 27:s=this.vm.isMixed()?128:0;break;case 28:s=this._page2?128:0;break;case 29:s=this.vm.isHires()?128:0;break;case 31:s=this.vm.is80Col()?128:0;break;case 30:s=this.vm.isAltChar()?128:0;break;default:s=this.io.ioSwitch(t,e)}return s}_accessIOUDisable(t,e){const s=void 0!==e;let i;switch(t){case 126:s?this._iouDisable=!0:i=this._iouDisable?0:128;break;case 127:s?this._iouDisable=!1:i=this.vm.isDoubleHires()?128:0;break;default:i=this.io.ioSwitch(t,e)}return i}_accessGraphics(t,e){let s=0;switch(t){case 84:this._page2=!1,this.__80store||(s=this.io.ioSwitch(t,e)),this._debug("Page 2 off");break;case 85:this._page2=!0,this.__80store||(s=this.io.ioSwitch(t,e)),this._debug("Page 2 on");break;case 86:this._hires=!1,s=this.io.ioSwitch(t,e),this._debug("Hires off");break;case 94:this._iouDisable?this.vm.doubleHires(!0):s=this.io.ioSwitch(t,e);break;case 95:this._iouDisable?this.vm.doubleHires(!1):s=this.io.ioSwitch(t,e);break;case 87:this._hires=!0,s=this.io.ioSwitch(t,e),this._debug("Hires on");break;default:s=this.io.ioSwitch(t,e)}return this._updateBanks(),s}_accessLangCard(t,e){const s=void 0===e,i=s?0:void 0,r=2&t,a=8&t;let n,o;return 1&t?(s&&this._prewrite&&(this._writebsr=!0),this._prewrite=s,r?(this._readbsr=!0,o="Read/Write"):(this._readbsr=!1,o="Write")):(this._writebsr=!1,this._prewrite=!1,r?(this._readbsr=!1,o="Off"):(this._readbsr=!0,o="Read")),a?(this._bank1=!0,n="Bank 1"):(this._bank1=!1,n="Bank 2"),this._debug(n,o),this._updateBanks(),i}_access(t,e){let s;const i=void 0!==e;switch(t>>4){case 0:i?this._accessMMUSet(t,e):s=this.io.ioSwitch(t);break;case 1:i?this.io.ioSwitch(t,e):s=this._accessStatus(t,e);break;case 5:s=this._accessGraphics(t,e);break;case 7:s=this._accessIOUDisable(t,e);break;case 8:s=this._accessLangCard(t,e);break;default:s=this.io.ioSwitch(t,e)}return s}start(){return this.lores1.start(),this.lores2.start(),0}end(){return 255}reset(){P("reset"),this._initSwitches(),this._updateBanks(),this.vm.reset(),this.io.reset()}read(t,e){return this._readPages[t].read(t,e)}write(t,e,s){this._writePages[t].write(t,e,s)}writeBank(t,e,s,i){this._pages[e][t].write(e,s,i)}resetVB(){this._vbEnd=this.cpu.getCycles()+1e3}get bank1(){return this._bank1}get readbsr(){return this._readbsr}get writebsr(){return this._writebsr}get auxread(){return this._auxRamRead}get auxwrite(){return this._auxRamWrite}get altzp(){return this._altzp}get _80store(){return this.__80store}get page2(){return this._page2}get hires(){return this._hires}get intcxrom(){return this._intcxrom}getState(){return{bank1:this._bank1,readbsr:this._readbsr,writebsr:this._writebsr,prewrite:this._prewrite,intcxrom:this._intcxrom,slot3rom:this._slot3rom,intc8rom:this._intc8rom,auxRamRead:this._auxRamRead,auxRamWrite:this._auxRamWrite,altzp:this._altzp,_80store:this.__80store,page2:this._page2,hires:this._hires,mem00_01:[this.mem00_01[0].getState(),this.mem00_01[1].getState()],mem02_03:[this.mem02_03[0].getState(),this.mem02_03[1].getState()],mem0C_1F:[this.mem0C_1F[0].getState(),this.mem0C_1F[1].getState()],mem60_BF:[this.mem60_BF[0].getState(),this.mem60_BF[1].getState()],memD0_DF:[this.memD0_DF[0].getState(),this.memD0_DF[1].getState(),this.memD0_DF[2].getState(),this.memD0_DF[3].getState(),this.memD0_DF[4].getState()],memE0_FF:[this.memE0_FF[0].getState(),this.memE0_FF[1].getState(),this.memE0_FF[2].getState()]}}setState(t){this._readbsr=t.readbsr,this._writebsr=t.writebsr,this._bank1=t.bank1,this._prewrite=t.prewrite,this._intcxrom=t.intcxrom,this._slot3rom=t.slot3rom,this._intc8rom=t.intc8rom,this._auxRamRead=t.auxRamRead,this._auxRamWrite=t.auxRamWrite,this._altzp=t.altzp,this.__80store=t._80store,this._page2=t.page2,this._hires=t.hires,this.mem00_01[0].setState(t.mem00_01[0]),this.mem00_01[1].setState(t.mem00_01[1]),this.mem02_03[0].setState(t.mem02_03[0]),this.mem02_03[1].setState(t.mem02_03[1]),this.mem0C_1F[0].setState(t.mem0C_1F[0]),this.mem0C_1F[1].setState(t.mem0C_1F[1]),this.mem60_BF[0].setState(t.mem60_BF[0]),this.mem60_BF[1].setState(t.mem60_BF[1]),this.memD0_DF[0].setState(t.memD0_DF[0]),this.memD0_DF[1].setState(t.memD0_DF[1]),this.memD0_DF[2].setState(t.memD0_DF[2]),this.memD0_DF[3].setState(t.memD0_DF[3]),this.memD0_DF[4].setState(t.memD0_DF[4]),this.memE0_FF[0].setState(t.memE0_FF[0]),this.memE0_FF[1].setState(t.memE0_FF[1]),this.memE0_FF[2].setState(t.memE0_FF[2]),this._updateBanks()}}const xi={49152:"KEYBOARD",49153:"80STOREON",49154:"RAMRDOFF",49155:"RAMRDON",49156:"RAMWROFF",49157:"RAMWRON",49158:"INTCXOFF",49159:"INTCXON",49160:"ALTZPOFF",49161:"ALTZPON",49162:"SLOT3OFF",49163:"SLOT3ON",49164:"CLR80VID",49165:"SET80VID",49166:"CLRALTCH",49167:"SETALTCH",49168:"STROBE",49169:"BSRBANK2",49170:"BSRREAD",49171:"RAMRD",49172:"RAMWRT",49173:"INTCXROM",49174:"ALTZP",49175:"SLOT3ROM",49176:"80STRORE",49177:"VERTBLANK",49178:"RDTEXT",49179:"RDMIXED",49180:"RDPAGE2",49181:"RDHIRES",49182:"RDALTCH",49183:"RD80VID",49184:"TAPEOUT",49200:"SPEAKER",49232:"CLRTEXT",49233:"SETTEXT",49234:"CLRMIXED",49235:"SETMIXED",49236:"PAGE1",49237:"PAGE2",49238:"CLRHIRS",49239:"SETHIRES",49240:"CLRAN0",49241:"SETAN0",49242:"CLRAN1",49243:"SETAN1",49244:"CLRAN2",49245:"SETAN2",49246:"CLRAN3",49247:"SETAN3",49248:"TAPEIN",49249:"PB0",49250:"PB1",49251:"PB2",49252:"PADDLE0",49253:"PADDLE1",49254:"PADDLE2",49255:"PADDLE3",49264:"PDLTRIG",49278:"SETIOUDIS",49279:"CLRIOUDIS",49280:"RDBSR2",49281:"WRBSR2",49282:"OFFBSR2",49283:"RWBSR2",49284:"RDBSR2",49285:"WRBSR2",49286:"OFFBSR2",49287:"RWBSR2",49288:"RDBSR1",49289:"WRBSR1",49290:"OFFBSR1",49291:"RWBSR1",49292:"RDBSR1",49293:"WRBSR1",49294:"OFFBSR1",49295:"RWBSR1",53248:"TOKEN.ADDRESS.TABLE",53376:"UNFNC",53426:"MATHTBL",53447:"M.NEG",53450:"M.EQU",53453:"M.REL",53456:"TOKEN.NAME.TABLE",53856:"ERROR.MESSAGES",54096:"QT.ERROR",54104:"QT.IN",54109:"QT.BREAK",54117:"GTFORPNT",54163:"BLTU",54170:"BLTU2",54230:"CHKMEM",54243:"REASON",54288:"MEMERR",54290:"ERROR",54321:"PRINT.ERROR.LINNUM",54332:"RESTART",54364:"NUMBERED.LINE",54453:"PUT.NEW.LINE",54514:"FIX.LINKS",54572:"INLIN",54574:"INLIN2",54611:"INCHR",54617:"PARSE.INPUT.LINE",54636:"PARSE",54810:"FNDLIN",54814:"FL1",54856:"RTS.1",54857:"NEW",54859:"SCRTCH",54885:"SETPTRS",54890:"CLEAR",54892:"CLEARC",54915:"STKINI",54934:"RTS.2",54935:"STXTPT",54949:"LIST",55002:"LIST.0",55038:"LIST.1",55042:"LIST.2",55076:"LIST.3",55084:"GETCHR",55092:"LIST.4",55142:"FOR",55215:"STEP",55250:"NEWSTT",55301:"TRACE.",55334:"GOEND",55336:"EXECUTE.STATEMENT",55338:"EXECUTE.STATEMENT.1",55362:"COLON.",55366:"SYNERR.1",55369:"RESTORE",55379:"SETDA",55383:"RTS.3",55384:"ISCNTC",55395:"CONTROL.C.TYPED",55406:"STOP",55408:"END",55409:"END2",55434:"END4",55446:"CONT",55471:"RTS.4",55472:"SAVE",55497:"LOAD",55536:"VARTIO",55553:"PROGIO",55570:"RUN",55585:"GOSUB",55605:"GO.TO.LINE",55614:"GOTO",55658:"RTS.5",55659:"POP",55676:"UNDERR",55681:"SYNERR.2",55684:"RETURN",55701:"DATA",55704:"ADDON",55714:"RTS.6",55715:"DATAN",55718:"REMN",55749:"PULL3",55753:"IF",55772:"REM",55777:"IF.TRUE",55788:"ONGOTO",55796:"ON.1",55800:"ON.2",55819:"RTS.7",55820:"LINGET",55878:"LET",55907:"LET2",55930:"LET.STRING",55931:"PUTSTR",56015:"PR.STRING",56021:"PRINT",56023:"PRINT2",56059:"CRDO",56064:"NEGATE",56066:"RTS.8",56067:"PR.COMMA",56086:"PR.TAB.OR.SPC",56108:"NXSPC",56111:"PR.NEXT.CHAR",56117:"DOSPC",56122:"STROUT",56125:"STRPRT",56151:"OUTSP",56154:"OUTQUES",56156:"OUTDO",56177:"INPUTERR",56187:"READERR",56191:"ERLIN",56198:"INPERR",56199:"RESPERR",56224:"GET",56242:"INPUT",56284:"NXIN",56290:"READ",56297:"INPUT.FLAG.ZERO",56299:"PROCESS.INPUT.LIST",56305:"PROCESS.INPUT.ITEM",56363:"INSTART",56425:"INPUT.DATA",56434:"INPUT.MORE",56473:"INPFIN",56480:"FINDATA",56518:"INPDONE",56543:"ERR.EXTRA",56559:"ERR.REENTRY",56569:"NEXT",56575:"NEXT.1",56578:"NEXT.2",56589:"GERR",56591:"NEXT.3",56679:"FRMNUM",56682:"CHKNUM",56684:"CHKSTR",56685:"CHKVAL",56696:"JERROR",56699:"FRMEVL",56710:"FRMEVL.1",56725:"FRMEVL.2",56781:"FRM.PRECEDENCE.TEST",56790:"NXOP",56791:"SAVOP",56804:"FRM.RELATIONAL",56822:"PREFNC",56829:"FRM.RECURSE",56845:"SNTXERR",56848:"FRM.STACK.1",56853:"FRM.STACK.2",56864:"FRM.STACK.3",56885:"NOTMATH",56888:"GOEX",56890:"FRM.PERFORM.1",56899:"FRM.PERFORM.2",56925:"EXIT",56928:"FRM.ELEMENT",56961:"STRTXT",56976:"NOT.",56984:"EQUOP",56996:"FN.",57003:"SGN.",57010:"PARCHK",57016:"CHKCLS",57019:"CHKOPN",57022:"CHKCOM",57024:"SYNCHR",57033:"SYNERR",57038:"MIN",57040:"EQUL",57045:"FRM.VARIABLE",57047:"FRM.VARIABLE.CALL",57081:"SCREEN",57100:"UNARY",57167:"OR",57173:"AND",57181:"FALSE",57184:"TRUE",57189:"RELOPS",57213:"STRCMP",57258:"STRCMP.1",57264:"NUMCMP",57269:"STRCMP.2",57281:"CMPDONE",57293:"PDL",57302:"NXDIM",57305:"DIM",57315:"PTRGET",57320:"PTRGET2",57322:"PTRGET3",57332:"BADNAM",57335:"NAMOK",57351:"PTRGET4",57469:"ISLETC",57479:"NAME.NOT.FOUND",57498:"C.ZERO",57500:"MAKE.NEW.VARIABLE",57566:"SET.VARPNT.AND.YA",57581:"GETARY",57583:"GETARY2",57598:"NEG32768",57602:"MAKINT",57608:"MKINT",57612:"AYINT",57625:"MI1",57627:"MI2",57630:"ARRAY",57750:"SUBERR",57753:"IQERR",57755:"JER",57758:"USE.OLD.ARRAY",57784:"MAKE.NEW.ARRAY",57931:"FIND.ARRAY.ELEMENT",57939:"FAE.1",57961:"GSE",57964:"GME",57967:"FAE.2",57968:"FAE.3",58028:"RTS.9",58029:"MULTIPLY.SUBSCRIPT",58038:"MULTIPLY.SUBS.1",58078:"FRE",58098:"GIVAYF",58111:"POS",58113:"SNGFLT",58118:"ERRDIR",58126:"UNDFNC",58131:"DEF",58177:"FNC.",58196:"FUNCT",58287:"FNCDATA",58309:"STR",58325:"STRINI",58333:"STRSPA",58343:"STRLIT",58349:"STRLT2",58410:"PUTNEW",58418:"JERR",58421:"PUTEMP",58450:"GETSPA",58500:"GARBAG",58504:"FIND.HIGHEST.STRING",58649:"CHECK.SIMPLE.VARIABLE",58659:"CHECK.VARIABLE",58706:"CHECK.BUMP",58717:"CHECK.EXIT",58722:"MOVE.HIGHEST.STRING.TO.TOP",58775:"CAT",58836:"MOVINS",58850:"MOVSTR",58854:"MOVSTR.1",58877:"FRESTR",58880:"FREFAC",58884:"FRETMP",58933:"FRETMS",58950:"CHRSTR",58970:"LEFTSTR",58976:"SUBSTRING.1",58983:"SUBSTRING.2",58984:"SUBSTRING.3",59014:"RIGHTSTR",59025:"MIDSTR",59065:"SUBSTRING.SETUP",59094:"LEN",59100:"GETSTR",59109:"ASC",59122:"GOIQ",59125:"GTBYTC",59128:"GETBYT",59131:"CONINT",59143:"VAL",59197:"POINT",59206:"GTNUM",59212:"COMBYTE",59218:"GETADR",59236:"PEEK",59259:"POKE",59268:"WAIT",59295:"RTS.10",59296:"FADDH",59303:"FSUB",59306:"FSUBT",59321:"FADD.1",59326:"FADD",59329:"FADDT",59342:"FADD.2",59386:"FADD.3",59433:"NORMALIZE.FAC.1",59438:"NORMALIZE.FAC.2",59470:"ZERO.FAC",59472:"STA.IN.FAC.SIGN.AND.EXP",59474:"STA.IN.FAC.SIGN",59477:"FADD.4",59508:"NORMALIZE.FAC.3",59520:"NORMALIZE.FAC.4",59533:"NORMALIZE.FAC.5",59535:"NORMALIZE.FAC.6",59549:"RTS.11",59550:"COMPLEMENT.FAC",59556:"COMPLEMENT.FAC.MANTISSA",59590:"INCREMENT.FAC.MANTISSA",59604:"RTS.12",59605:"OVERFLOW",59610:"SHIFT.RIGHT.1",59612:"SHIFT.RIGHT.2",59632:"SHIFT.RIGHT",59645:"L",59655:"SHIFT.RIGHT.4",59665:"SHIFT.RIGHT.5",59667:"CON.ONE",59672:"POLY.LOG",59693:"CON.SQR.HALF",59698:"CON.SQR.TWO",59703:"CON.NEG.HALF",59708:"CON.LOG.TWO",59713:"LOG",59720:"GIQ",59723:"LOG.2",59775:"FMULT",59778:"FMULTT",59824:"MULTIPLY.1",59829:"MULTIPLY.2",59874:"RTS.13",59875:"LOAD.ARG.FROM.YA",59918:"ADD.EXPONENTS",59920:"ADD.EXPONENTS.1",59947:"OUTOFRNG",59953:"ZERO",59958:"JOV",59961:"MUL10",59984:"CON.TEN",59989:"DIV10",59998:"DIV",60006:"FDIV",60009:"FDIVT",60134:"COPY.RESULT.INTO.FAC",60153:"LOAD.FAC.FROM.YA",60190:"STORE.FAC.IN.TEMP2.ROUNDED",60193:"STORE.FAC.IN.TEMP1.ROUNDED",60199:"SETFOR",60203:"STORE.FAC.AT.YX.ROUNDED",60243:"COPY.ARG.TO.FAC",60245:"MFA",60259:"COPY.FAC.TO.ARG.ROUNDED",60262:"MAF",60273:"RTS.14",60274:"ROUND.FAC",60282:"INCREMENT.MANTISSA",60290:"SIGN",60294:"SIGN1",60296:"SIGN2",60303:"RTS.15",60304:"SGN",60307:"FLOAT",60315:"FLOAT.1",60320:"FLOAT.2",60335:"ABS",60338:"FCOMP",60340:"FCOMP2",60402:"QINT",60433:"RTS.16",60434:"QINT.2",60451:"INT",60480:"QINT.3",60489:"RTS.17",60490:"FIN",60513:"FIN.1",60516:"FIN.2",60518:"FIN.3",60551:"FIN.4",60554:"FIN.5",60556:"FIN.6",60568:"FIN.10",60574:"FIN.7",60576:"FIN.8",60609:"FIN.9",60629:"ADDACC",60648:"GETEXP",60682:"CON.99999999.9",60687:"CON.999999999",60692:"CON.BILLION",60697:"INPRT",60708:"LINPRT",60718:"PRINT.FAC",60721:"GO.STROUT",60724:"FOUT",60726:"FOUT.1",60812:"FOUT.2",60951:"FOUT.3",61015:"FOUT.4",61018:"FOUT.5",61023:"FOUT.6",61028:"CON.HALF",61033:"DECTBL",61069:"SQR",61079:"FPWRT",61136:"NEGOP",61146:"RTS.18",61147:"CON.LOG.E",61152:"POLY.EXP",61193:"EXP",61276:"POLYNOMIAL.ODD",61298:"POLYNOMIAL",61302:"SERMAIN",61349:"RTS.19",61350:"CON.RND.1",61354:"CON.RND.2",61358:"RND",61415:"GO.MOVMF",61418:"COS",61425:"SIN",61475:"SIN.1",61478:"SIN.2",61498:"TAN",61538:"TAN.1",61542:"CON.PI.HALF",61547:"CON.PI.DOUB",61552:"QUARTER",61557:"POLY.SIN",61598:"ATN",61645:"RTS.20",61646:"POLY.ATN",61707:"GENERIC.CHRGET",61736:"COLD.START",61909:"CALL",61918:"IN.NUMBER",61925:"PR.NUMBER",61932:"PLOTFNS",61958:"GOERR",61961:"LINCOOR",61989:"PLOT",62002:"HLIN",62017:"VLIN",62031:"COLOR",62038:"VTAB",62050:"SPEED",62061:"TRACE",62063:"NOTRACE",62067:"NORMAL",62071:"INVERSE",62073:"N.I.",62075:"N.I.F.",62080:"FLASH",62086:"HIMEM",62102:"JMM",62105:"SETHI",62118:"LOMEM",62155:"ONERR",62185:"HANDLERR",62232:"RESUME",62254:"JSYN",62257:"DEL",62352:"GR",62361:"TEXT",62367:"STORE",62396:"RECALL",62424:"HGR2",62434:"HGR",62442:"SETHPG",62450:"HCLR",62454:"BKGND",62481:"HPOSN",62551:"HPLOT0",62565:"MOVE.LEFT.OR.RIGHT",62574:"LR.1",62577:"LR.2",62582:"LR.3",62584:"LR.4",62590:"COLOR.SHIFT",62602:"MOVE.RIGHT",62620:"LRUDX1",62621:"LRUDX2",62643:"LRUD1",62644:"LRUD2",62660:"LRUD3",62664:"LRUD4",62669:"CON.03",62675:"MOVE.UP.OR.DOWN",62721:"UD.1",62725:"MOVE.DOWN",62728:"CON.04",62768:"HLINRL",62778:"HGLIN",62844:"MOVEX",62849:"MOVEX2",62898:"MSKTBL",62905:"CON.1C",62906:"COSINE.TABLE",62923:"HFIND",62976:"RTS.22",62977:"DRAW0",62981:"DRAW1",63069:"XDRAW0",63073:"XDRAW1",63161:"HFNS",63206:"GGERR",63209:"HCOLOR",63221:"RTS.23",63222:"COLORTBL",63230:"HPLOT",63265:"ROT",63271:"SCALE",63277:"DRWPNT",63337:"DRAW",63343:"XDRAW",63349:"SHLOAD",63420:"TAPEPNT",63449:"GETARYPT",63463:"HTAB",63488:"MON.PLOT",63513:"MON.HLINE",63528:"MON.VLINE",63588:"MON.SETCOL",63601:"MON.SCRN",64286:"MON.PREAD",64313:"MON.SETTXT",64320:"MON.SETGR",64347:"MON.TABV",64600:"MON.HOME",64680:"MON.WAIT",64762:"MON.RD2BIT",64780:"MON.RDKEY",64874:"MON.GETLN",65005:"MON.COUT",65163:"MON.INPORT",65173:"MON.OUTPORT",65229:"MON.WRITE",65277:"MON.READ",65282:"MON.READ2"},Bi=t=>!0,Fi=t=>[t&Vs?"N":"-",t&Qs?"V":"-",32&t?"X":"-",t&Js?"B":"-",8&t?"D":"-",4&t?"I":"-",2&t?"Z":"-",1&t?"C":"-"].join("");class Ui{constructor(t,e){this.cpu=t,this.container=e,this.verbose=!1,this.maxTrace=256,this.trace=[],this.breakpoints=new Map,this.symbols={},this.break=()=>{this.container.stop()},this.step=()=>{this.cpu.step((()=>{const t=this.cpu.getDebugInfo();P(this.printDebugInfo(t)),this.updateTrace(t)}))},this.continue=()=>{this.container.run()},this.runAt=t=>{this.cpu.reset(),this.cpu.setPC(t)},this.isRunning=()=>this.container.isRunning(),this.setVerbose=t=>{this.verbose=t},this.setMaxTrace=t=>{this.maxTrace=t},this.getTrace=t=>this.trace.slice(t?-t:void 0).map(this.printDebugInfo).join("\n"),this.printTrace=t=>{P(this.getTrace(t))},this.getStack=t=>{const{sp:e}=this.cpu.getDebugInfo(),s=[];let i=255,r=0;t&&(e-3>=255-t?r=Math.max(255-t+1,0):(i=Math.min(e+t-4,255),r=Math.max(e-3,0)));for(let a=i;a>=r;a--){const i=a===e?"*":" ",r=`$${C(256+a)}`,n=C(this.cpu.read(1,a));(!t||e+t>a&&a>e-t)&&s.push(`${i} ${r} ${n}`)}return s.join("\n")},this.setBreakpoint=(t,e)=>{this.breakpoints.set(t,e||Bi)},this.clearBreakpoint=t=>{this.breakpoints.delete(t)},this.listBreakpoints=()=>{for(const[t,e]of this.breakpoints.entries())P(C(t,4),e)},this.addSymbols=t=>{this.symbols=Object.assign(Object.assign({},this.symbols),t)},this.printDebugInfo=t=>{const{pc:e,cmd:s}=t,i=this.padWithSymbol(e);return[C(e,4),"- ",i,this.dumpRegisters(t)," ",this.dumpRawOp(s)," ",this.dumpOp(e,s)].join("")},this.dumpPC=t=>{const e=this.cpu.read(t),s=this.cpu.getOpInfo(e),i=qs[s.mode];let r=C(t,4)+"- ";r+=this.padWithSymbol(t);const a=new Array(i);for(let e=0,s=t;e<i;e++,s++)a[e]=this.cpu.read(s);return r+=this.dumpRawOp(a)+" "+this.dumpOp(t,a),r},this.dumpRegisters=t=>{void 0===t&&(t=this.cpu.getDebugInfo());const{ar:e,xr:s,yr:i,sr:r,sp:a}=t;return["A="+C(e)," X="+C(s)," Y="+C(i)," P="+C(r)," S="+C(a)," ",Fi(r)].join("")},this.dumpPage=(t,e)=>{let s="";void 0===e&&(e=t);for(let i=t;i<=e;i++)for(let t=0;t<16;t++){s+=C(i)+C(t<<4)+": ";for(let e=0;e<16;e++)s+=C(this.cpu.read(i,16*t+e))+" ";s+="        ";for(let e=0;e<16;e++){const r=127&this.cpu.read(i,16*t+e);s+=r>=32&&r<127?String.fromCharCode(r):"."}s+="\n"}return s},this.list=t=>{const e=[];for(let s=0;s<20;s++){const s=this.cpu.read(t),i=this.cpu.getOpInfo(s);e.push(this.dumpPC(t)),t+=qs[i.mode]}return e}}stepCycles(t){this.cpu.stepCyclesDebug(this.verbose?1:t,(()=>{var t;const e=this.cpu.getDebugInfo();if(null===(t=this.breakpoints.get(e.pc))||void 0===t?void 0:t(e))return P("breakpoint",this.printDebugInfo(e)),this.container.stop(),!0;this.verbose?P(this.printDebugInfo(e)):this.updateTrace(e)}))}getMemory(t,e){const s=new Uint8Array(e);for(let i=0;i<e;i++)t&=65535,s[i]=this.cpu.read(t++);return s}setMemory(t,e){for(const s of e)t&=65535,this.cpu.write(t++,s)}updateTrace(t){this.trace.push(t),this.trace.length>this.maxTrace&&this.trace.shift()}padWithSymbol(t){const e="          ",s=this.symbols[t];let i=e;return s&&(i=`${s}${e.substring(s.length)}`),i}dumpRawOp(t){const e=new Array(4);for(let s=0;s<4;s++)s<t.length?e[s]=C(t[s]):e[s]="  ";return e.join(" ")}dumpOp(t,e){const s=this.cpu.getOpInfo(e[0]),i=e[1],r=e[2],a=r<<8|i;let n,o;const h=(t,e)=>this.symbols[t]||"$"+C(t,e);let d=s.name+" ";switch(s.mode){case"implied":default:break;case"immediate":d+=`#${h(i)}`;break;case"absolute":d+=`${h(a,4)}`;break;case"zeroPage":d+=`${h(i)}`;break;case"relative":o=i,o>127&&(o-=256),d+=`${h(t+=o+2,4)} (${o})`;break;case"absoluteX":d+=`${h(a,4)},X`;break;case"absoluteY":d+=`${h(a,4)},Y`;break;case"zeroPageX":d+=`${h(i)},X`;break;case"zeroPageY":d+=`${h(i)},Y`;break;case"absoluteIndirect":d+=`(${h(a,4)})`;break;case"zeroPageXIndirect":d+=`(${h(i)},X)`;break;case"zeroPageIndirectY":d+=`(${h(i)},),Y`;break;case"accumulator":d+="A";break;case"zeroPageIndirect":d+=`(${h(i)})`;break;case"absoluteXIndirect":d+=`(${h(a,4)},X)`;break;case"zeroPage_relative":n=i,o=r,o>127&&(o-=256),t+=o+2,d+=`${h(n)},${h(t,4)} (${o})`}return d}}var Xi=function(t,e,s,i){return new(s||(s=Promise))((function(r,a){function n(t){try{h(i.next(t))}catch(t){a(t)}}function o(t){try{h(i.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,o)}h((i=i.apply(t,e||[])).next())}))};const zi=new s,Hi=zi.readPref("computer_type2e");let Gi,Zi,Yi=!1;switch(Hi){case"apple2e":Gi="apple2e",Zi="apple2e_char";break;case"apple2rm":Gi="apple2e",Zi="rmfont_char",Yi=!0;break;case"apple2ex":Gi="apple2ex",Zi="apple2enh_char",Yi=!0;break;default:Gi="apple2enh",Zi="apple2enh_char",Yi=!0}const Wi={gl:"true"===zi.readPref("gl_canvas","true"),canvas:document.querySelector("#screen"),rom:Gi,characterRom:Zi,e:!0,enhanced:Yi,tick:Me},Ki=new class{constructor(t){this.paused=!1,this.runTimer=null,this.runAnimationFrame=null,this.stats={cycles:0,frames:0,renderedFrames:0},this.ready=this.init(t)}loadGridmasterSnapshot(){return Xi(this,void 0,void 0,(function*(){const t=yield fetch("json/snapshots/gridmaster_start.json"),e=yield t.text(),s=yield _(e);this.setState(s)}))}init(t){return Xi(this,void 0,void 0,(function*(){const e=r(6190)(`./${t.rom}`),s=r(2800)(`./${t.characterRom}`),i=t.gl?Pi:wi,a=t.gl?Oi:yi,n=t.gl?ki:Si;this.cpu=new ti({flavor:t.enhanced?Ws:Ys}),this.vm=new n(t.canvas,t.e);const[{default:o},{default:h}]=yield Promise.all([e,s,this.vm.ready]);this.rom=new o,this.characterRom=h,this.gr=new i(this.vm,1,this.characterRom,t.e),this.gr2=new i(this.vm,2,this.characterRom,t.e),this.hgr=new a(this.vm,1),this.hgr2=new a(this.vm,2),this.io=new hi(this.cpu,this.vm),this.tick=t.tick,t.e?(this.mmu=new Ni(this.cpu,this.vm,this.gr,this.gr2,this.hgr,this.hgr2,this.io,this.rom),this.cpu.addPageHandler(this.mmu)):(this.ram=[new Mi(0,3),new Mi(12,31),new Mi(96,191)],this.cpu.addPageHandler(this.ram[0]),this.cpu.addPageHandler(this.gr),this.cpu.addPageHandler(this.gr2),this.cpu.addPageHandler(this.ram[1]),this.cpu.addPageHandler(this.hgr),this.cpu.addPageHandler(this.hgr2),this.cpu.addPageHandler(this.ram[2]),this.cpu.addPageHandler(this.io),this.cpu.addPageHandler(this.rom))}))}run(){if(this.paused=!1,this.runTimer||this.runAnimationFrame)return;this.theDebugger=new Ui(this.cpu,this),this.theDebugger.addSymbols(xi);let t,e=Date.now();const s=()=>{const i=this.io.getKHz();t=Date.now();const r=30*i;let a=(t-e)*i;if(e=t,a>r&&(a=r),this.theDebugger?this.theDebugger.stepCycles(a):this.cpu.stepCycles(a),this.mmu&&this.mmu.resetVB(),this.io.annunciator(0)){const t=this.io.blit();t&&(this.vm.blit(t),this.stats.renderedFrames++)}else this.vm.blit()&&this.stats.renderedFrames++;this.stats.cycles=this.cpu.getCycles(),this.stats.frames++,this.io.tick(),this.tick(),function(t){if(W=navigator.getGamepads()[0],!W)return;const e=(1.414*W.axes[0]+1)/2,s=(1.414*W.axes[1]+1)/2;t.paddle(0,e),t.paddle(1,s);for(let e=0;e<W.buttons.length;e++){const s=j[e];if(void 0!==s){const i=q[e],r=W.buttons[e];let a;a="object"==typeof r?r.pressed:1===r,a&&!i?s<=0?t.buttonDown(-s):t.keyDown(s):!a&&i&&(s<=0?t.buttonUp(-s):t.keyUp()),q[e]=a}}}(this.io),!this.paused&&requestAnimationFrame&&(this.runAnimationFrame=requestAnimationFrame(s))};requestAnimationFrame?this.runAnimationFrame=requestAnimationFrame(s):this.runTimer=window.setInterval(s,30),this.loadGridmasterSnapshot()}stop(){this.paused=!0,this.runTimer&&clearInterval(this.runTimer),this.runAnimationFrame&&cancelAnimationFrame(this.runAnimationFrame),this.runTimer=null,this.runAnimationFrame=null}isRunning(){return!this.paused}getState(){var t,e;return{cpu:this.cpu.getState(),vm:this.vm.getState(),io:this.io.getState(),mmu:null===(t=this.mmu)||void 0===t?void 0:t.getState(),ram:null===(e=this.ram)||void 0===e?void 0:e.map((t=>t.getState()))}}setState(t){this.cpu.setState(t.cpu),this.vm.setState(t.vm),this.io.setState(t.io),this.mmu&&t.mmu&&this.mmu.setState(t.mmu),this.ram&&this.ram.forEach(((e,s)=>{t.ram&&e.setState(t.ram[s])}))}reset(){this.cpu.reset()}getStats(){return this.stats}getCPU(){return this.cpu}getIO(){return this.io}getMMU(){return this.mmu}getROM(){return this.rom}getVideoModes(){return this.vm}getDebugger(){return this.theDebugger}}(Wi);Ki.ready.then((()=>{const t=Ki.getIO(),e=Ki.getCPU(),s=new Xe("#printer-modal .paper"),i=new He(Wi.canvas),r=new zs(s),a=new Gs(1048576),n=new Us(t,se),o=new ai,h=new ii(e,null,{block:!Yi}),d=new oi(e,i);t.setSlot(1,r),t.setSlot(2,a),t.setSlot(4,d),t.setSlot(5,o),t.setSlot(6,n),t.setSlot(7,h),Ue(Ki,n,h,s,Wi.e)})).catch(console.error);const ji=Object.assign(Object.assign({},t),{apple2:Ki})})(),a.Apple2})()));
//# sourceMappingURL=main2e.bundle.js.map